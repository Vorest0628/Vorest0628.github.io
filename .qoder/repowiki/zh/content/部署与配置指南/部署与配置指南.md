# 部署与配置指南

<cite>
**本文档引用文件**  
- [vite.config.js](file://frontend/vite.config.js#L1-L53)
- [vercel.json](file://backend/vercel.json#L1-L20)
- [cloudflare-worker.js](file://cloudflare-worker.js#L1-L118)
</cite>

## 目录
1. [本地开发环境搭建](#本地开发环境搭建)
2. [生产环境部署流程](#生产环境部署流程)
3. [关键配置项说明](#关键配置项说明)
4. [Vite构建配置解析](#vite构建配置解析)
5. [Cloudflare Worker反向代理设置](#cloudflare-worker反向代理设置)
6. [常见部署问题排查](#常见部署问题排查)

## 本地开发环境搭建

本项目采用前后端分离架构，前端基于Vue 3 + Vite构建，后端使用Node.js + Express框架。本地开发需分别启动前后端服务。

### 前端服务启动
进入`frontend`目录，安装依赖并启动开发服务器：
```bash
cd frontend
npm install
npm run dev
```
默认监听端口为5173，可通过浏览器访问`http://localhost:5173`查看应用。

### 后端服务启动
进入`backend`目录，安装依赖并启动服务：
```bash
cd backend
npm install
npm start
```
后端服务默认运行在`http://localhost:3000`，提供RESTful API接口。

### 环境变量配置
项目依赖以下环境变量，需在`.env`文件中配置（参考`.env.example`）：
- `DATABASE_URL`: 数据库连接字符串（如MongoDB）
- `JWT_SECRET`: JWT令牌密钥，用于用户认证
- `VERCEL_BLOB_TOKEN`: Vercel Blob存储凭证，用于文件上传

**Section sources**
- [vite.config.js](file://frontend/vite.config.js#L1-L53)

## 生产环境部署流程

### Vercel Serverless部署配置
后端通过Vercel Serverless函数部署，核心配置文件为`vercel.json`，定义了构建规则和路由映射。

```json
{
  "version": 2,
  "builds": [
    {
      "src": "app.js",
      "use": "@vercel/node"
    }
  ],
  "routes": [
    {
      "src": "/api/(.*)",
      "dest": "/app.js"
    },
    {
      "src": "/(.*)",
      "dest": "/app.js"
    }
  ]
}
```

该配置说明：
- 将`app.js`作为Serverless函数入口
- 所有以`/api/`开头的请求均路由至`app.js`处理
- 其他路径请求也由`app.js`统一处理，实现单入口模式

部署命令：
```bash
vercel --prod
```

**Section sources**
- [vercel.json](file://backend/vercel.json#L1-L20)

## 关键配置项说明

### 数据库连接
在`.env`文件中配置`DATABASE_URL`，示例：
```
DATABASE_URL=mongodb://localhost:27017/my_website
```

### JWT密钥
用于生成和验证用户身份令牌，长度建议不少于32位：
```
JWT_SECRET=your_32bit_or_longer_secret_key_here
```

### Vercel Blob凭证
用于存储用户上传的图片、文档等资源：
```
VERCEL_BLOB_TOKEN=your_vercel_blob_token
```

### 跨域配置
前后端分离部署时需配置CORS，后端`app.js`中应包含：
```js
app.use(cors({
  origin: '*',
  credentials: true
}));
```

## Vite构建配置解析

`frontend/vite.config.js`是前端构建的核心配置文件，主要包含以下关键设置：

### 代理配置（开发环境）
解决本地开发时的跨域问题，将API请求代理至后端服务：
```js
server: {
  port: 5173,
  proxy: {
    '/api': {
      target: 'http://localhost:3000',
      changeOrigin: true,
      rewrite: path => path.replace(/^\/api/, '/api')
    }
  }
}
```
此配置将前端请求的`/api/*`路径代理到`http://localhost:3000/api/*`。

### 构建输出设置
优化生产环境构建输出：
```js
build: {
  outDir: 'dist',
  assetsDir: 'assets',
  sourcemap: false,
  chunkSizeWarningLimit: 1000,
  rollupOptions: {
    output: {
      manualChunks: {
        vendor: ['vue', 'vue-router', 'pinia'],
        particles: ['particles.js']
      }
    }
  }
}
```
- 输出目录为`dist`
- 静态资源存放于`assets`子目录
- 禁用sourcemap以提升安全性
- 手动分块优化加载性能，分离第三方库

**Section sources**
- [vite.config.js](file://frontend/vite.config.js#L1-L53)

## Cloudflare Worker反向代理设置

为解决Vercel在中国大陆访问不稳定的问题，可通过Cloudflare Worker实现API请求的反向代理。

### 工作原理
`cloudflare-worker.js`作为边缘函数，拦截所有`/api/`开头的请求，并将其转发至Vercel部署的后端服务，同时处理CORS跨域问题。

### 核心功能实现
```js
// 后端API源站地址
const API_ORIGIN = 'https://vorest0628-github-io.vercel.app'

async function handleApiRequest(request, url) {
  const targetPath = `${url.pathname}${url.search}`
  const targetUrl = `${API_ORIGIN}${targetPath}`

  // 清理可能引起问题的请求头
  const headers = new Headers(request.headers)
  headers.delete('host')
  headers.delete('origin')
  headers.delete('referer')

  // 代理请求到Vercel
  const response = await fetchWithTimeout(targetUrl, {
    method: request.method,
    headers,
    body: request.body
  }, 8000)

  // 添加CORS响应头
  const responseHeaders = new Headers(response.headers)
  responseHeaders.set('Access-Control-Allow-Origin', '*')
  
  return new Response(response.body, {
    status: response.status,
    headers: responseHeaders
  })
}
```

### 部署步骤
1. 登录Cloudflare Workers控制台
2. 创建新Worker
3. 粘贴`cloudflare-worker.js`代码
4. 保存并部署
5. 在前端应用中将API基础URL指向Worker域名

此方案可显著提升中国大陆用户的API访问速度和稳定性。

**Section sources**
- [cloudflare-worker.js](file://cloudflare-worker.js#L1-L118)

## 常见部署问题排查

### 问题1：前端无法连接后端API
**现象**：浏览器控制台出现跨域错误或连接拒绝  
**解决方案**：
- 检查Vercel部署是否成功，访问`https://your-project.vercel.app/api/health`测试
- 确认`vercel.json`路由配置正确
- 若使用Cloudflare Worker，检查`API_ORIGIN`是否指向正确的Vercel地址

### 问题2：Vite构建后页面空白
**现象**：部署后页面加载但内容为空  
**解决方案**：
- 检查`vite.config.js`中的`base`配置，GitHub Pages需设置为`/仓库名/`
- 确认`index.html`中的资源路径正确
- 清除浏览器缓存或尝试无痕模式访问

### 问题3：Cloudflare Worker代理超时
**现象**：API请求返回500错误或超时  
**解决方案**：
- 检查目标Vercel服务是否正常运行
- 调整`fetchWithTimeout`的超时时间（当前为8秒）
- 查看Cloudflare Workers日志，定位具体错误

### 问题4：环境变量未生效
**现象**：部署后功能异常，如数据库连接失败  
**解决方案**：
- 在Vercel或Cloudflare控制台中正确设置环境变量
- 确认变量名前缀为`VITE_`（前端）或直接使用（后端）
- 重新部署以确保环境变量加载