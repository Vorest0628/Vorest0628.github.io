# 环境变量与配置项

<cite>
**本文档引用文件**  
- [backend/setting.env](file://backend/setting.env)
- [frontend/setting.env](file://frontend/setting.env)
- [backend/app.js](file://backend/app.js)
- [backend/middleware/auth.js](file://backend/middleware/auth.js)
- [frontend/src/services/api.ts](file://frontend/src/services/api.ts)
- [frontend/vite.config.js](file://frontend/vite.config.js)
- [README.md](file://README.md)
- [cloudflare-worker.js](file://cloudflare-worker.js)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构概览](#项目结构概览)
3. [核心环境变量说明](#核心环境变量说明)
4. [前后端配置文件详解](#前后端配置文件详解)
5. [配置使用方式分析](#配置使用方式分析)
6. [常见配置问题与排查](#常见配置问题与排查)
7. [生产环境安全实践](#生产环境安全实践)
8. [总结](#总结)

## 简介
本项目为全栈个人网站系统，采用前后端分离架构。前端基于 Vue 3 + Vite 构建，后端使用 Express + MongoDB 实现 RESTful API 服务。系统部署于 Vercel Serverless 环境，并集成 Vercel Blob 作为文件存储方案。环境变量在开发与生产环境中扮演关键角色，用于配置数据库连接、认证密钥、API 路径等核心参数。

## 项目结构概览

```mermaid
graph TB
subgraph "根目录"
README[README.md]
package[package.json]
worker[cloudflare-worker.js]
end
subgraph "前端"
frontend[frontend/]
envFront[setting.env]
vite[vite.config.js]
apiService[src/services/api.ts]
end
subgraph "后端"
backend[backend/]
envBack[setting.env]
app[app.js]
auth[auth.js]
blob[utils/uploader.js]
end
README --> frontend
README --> backend
envFront --> apiService
envBack --> app
app --> auth
app --> blob
backend --> frontend
```

**图示来源**  
- [project_structure](file://project_structure)

## 核心环境变量说明

### 后端核心配置项

**数据库连接 (MONGODB_URI)**  
- **用途**：指定 MongoDB 数据库连接字符串  
- **格式**：`mongodb+srv://用户名:密码@集群地址/数据库名?retryWrites=true&w=majority`  
- **示例值**：`mongodb+srv://Henry:QnnhVROtHpXmTpRr@cluster0.27eleqn.mongodb.net/my_website`  
- **安全提示**：生产环境严禁硬编码，应通过 Vercel 控制台注入

**JWT 认证密钥 (JWT_SECRET)**  
- **用途**：用于生成和验证 JSON Web Token，保障用户会话安全  
- **长度建议**：至少 32 位随机字符  
- **示例值**：`oF2ZEI52iW42J7CX1lSe`  
- **使用位置**：`backend/middleware/auth.js` 中 `jwt.verify()` 方法

**Vercel Blob 存储凭证 (BLOB_READ_WRITE_TOKEN)**  
- **用途**：授权后端访问 Vercel Blob 云存储服务，用于上传文档、图片等资源  
- **获取方式**：在 Vercel 项目设置中生成  
- **条件加载**：代码中通过 `process.env.BLOB_READ_WRITE_TOKEN` 判断是否启用 Blob 功能

**服务器端口 (PORT)**  
- **用途**：本地开发时指定后端服务监听端口  
- **默认值**：`3000`  
- **生产环境**：Vercel 自动管理，无需配置

**CORS 跨域源 (CORS_ORIGIN)**  
- **用途**：定义允许访问 API 的前端域名列表  
- **开发值**：`http://localhost:5173`  
- **生产值**：需包含 GitHub Pages 或 Vercel 域名

### 前端核心配置项

**API 基础路径 (VITE_APP_API_URL)**  
- **用途**：前端请求后端接口的根地址  
- **开发值**：`http://localhost:3000/api`（通过代理）  
- **生产值**：`https://your-backend.vercel.app/api` 或 Cloudflare Worker 地址  
- **使用方式**：通过 `import.meta.env.VITE_APP_API_URL` 在运行时注入

**应用元信息**  
- `VITE_APP_TITLE`：网站标题  
- `VITE_APP_VERSION`：版本号  
- `VITE_APP_ENV`：环境标识（development/production）

**文件上传限制**  
- `VITE_APP_FILE_UPLOAD_MAX_SIZE`：最大文件上传大小（如 50MB）  
- `VITE_APP_IMAGE_UPLOAD_MAX_SIZE`：最大图片上传大小（如 10MB）

**Section sources**  
- [backend/setting.env](file://backend/setting.env#L1-L20)
- [frontend/setting.env](file://frontend/setting.env#L1-L12)

## 前后端配置文件详解

### 后端配置文件 (backend/setting.env)

```env
# 数据库配置
MONGODB_URI=mongodb+srv://Henry:QnnhVROtHpXmTpRr@cluster0.27eleqn.mongodb.net/my_website

# JWT密钥
JWT_SECRET=oF2ZEI52iW42J7CX1lSe
JWT_EXPIRES_IN=7d

# 服务器端口
PORT=3000

# 环境
NODE_ENV=development

# CORS配置
CORS_ORIGIN=http://localhost:5173

BLOB_READ_WRITE_TOKEN=vercel_blob_rw_6HMyNSRRk1NBujui_ilfjaroQulYEcuIEfKhsHzxyavGoaJ
```

该文件在非 Vercel 环境下由 `dotenv` 自动加载。生产环境通过 Vercel 控制台设置环境变量，避免敏感信息泄露。

### 前端配置文件 (frontend/setting.env)

```env
# API 基础 URL
VITE_APP_API_URL=https://vorest0628-github-io.vercel.app/api

# 应用信息
VITE_APP_TITLE=Vorest's Personal Website
VITE_APP_VERSION=1.0.0

# 文件上传限制
VITE_APP_FILE_UPLOAD_MAX_SIZE=50MB
VITE_APP_IMAGE_UPLOAD_MAX_SIZE=10MB

# 环境模式
VITE_APP_ENV=production
```

前端环境变量需以 `VITE_` 开头，才能被 Vite 构建系统识别并注入到 `import.meta.env` 中。

### 配置初始化流程

```mermaid
flowchart TD
Start([项目启动]) --> CheckEnv["检查运行环境"]
CheckEnv --> |本地开发| LoadDotenv["加载 .env 文件"]
CheckEnv --> |Vercel 生产| UseVercelEnv["使用 Vercel 环境变量"]
LoadDotenv --> InitApp["初始化应用配置"]
UseVercelEnv --> InitApp
InitApp --> ConnectDB["连接数据库"]
InitApp --> StartServer["启动服务器或等待调用"]
ConnectDB --> |成功| LogSuccess["打印连接成功日志"]
ConnectDB --> |失败| LogError["打印错误并重试"]
```

**图示来源**  
- [backend/app.js](file://backend/app.js#L0-L27)
- [backend/app.js](file://backend/app.js#L167-L204)

**Section sources**  
- [backend/app.js](file://backend/app.js#L0-L27)
- [backend/app.js](file://backend/app.js#L167-L204)

## 配置使用方式分析

### 后端配置使用 (auth.js)

```javascript
const jwt = require('jsonwebtoken')

exports.auth = async (req, res, next) => {
  try {
    const token = req.headers.authorization.split(' ')[1]
    // 使用环境变量中的密钥验证 JWT
    const decoded = jwt.verify(token, process.env.JWT_SECRET)
    req.user = decoded
    next()
  } catch (error) {
    next(new ApiError(401, '无效的令牌'))
  }
}
```

**关键点**：`process.env.JWT_SECRET` 直接从 Node.js 运行时环境读取，开发时来自 `.env` 文件，生产时来自 Vercel 注入。

### 前端配置使用 (api.ts)

```typescript
const getViteEnv = (key: string): string | undefined => {
  try {
    const env = (new Function('try{return import.meta.env}catch(e){return {}}'))()
    return env?.[key]
  } catch {
    return undefined
  }
}

console.log('VITE_APP_API_URL:', getViteEnv('VITE_APP_API_URL'))
```

**关键点**：通过运行时函数动态读取 `import.meta.env`，避免编译时解析问题，确保环境变量正确加载。

### API 请求服务 (services/api.ts)

```typescript
import axios from 'axios'

// 构建基础 API 实例
const apiService = axios.create({
  baseURL: getViteEnv('VITE_APP_API_URL') || 'http://localhost:3000/api',
  timeout: 10000
})
```

**动态回退机制**：若环境变量未定义，则默认指向本地后端，提升开发便利性。

**Section sources**  
- [backend/middleware/auth.js](file://backend/middleware/auth.js#L0-L37)
- [frontend/src/services/api.ts](file://frontend/src/services/api.ts#L0-L46)

## 常见配置问题与排查

### 数据库连接失败

**现象**：后端日志显示 `❌ 数据库连接失败`  
**可能原因**：
- `MONGODB_URI` 格式错误或包含特殊字符
- MongoDB Atlas 未开放 IP 白名单（需添加 `0.0.0.0/0`）
- 网络策略限制（如企业防火墙）

**排查步骤**：
1. 检查 `MONGODB_URI` 是否正确
2. 登录 MongoDB Atlas 控制台，确认网络访问设置
3. 查看 Vercel 日志中的完整错误信息

### 认证失败（401 错误）

**现象**：登录后无法访问受保护接口  
**可能原因**：
- `JWT_SECRET` 前后端不一致
- 令牌过期时间设置不当
- 请求头未正确携带 `Authorization: Bearer <token>`

**排查步骤**：
1. 确认前后端 `JWT_SECRET` 完全一致
2. 检查 `auth.js` 中 `jwt.verify()` 是否抛出异常
3. 使用浏览器开发者工具检查请求头

### 资源加载异常

**现象**：图片或文档无法显示/下载  
**可能原因**：
- `VITE_APP_API_URL` 指向错误地址
- Cloudflare Worker 配置错误
- Vercel Blob 未正确启用

**排查步骤**：
1. 检查 `frontend/setting.env` 中的 API 地址
2. 确认 `BLOB_READ_WRITE_TOKEN` 已正确配置
3. 查看 `galleryController.js` 和 `documentController.js` 的 Blob 初始化逻辑

**Section sources**  
- [backend/app.js](file://backend/app.js#L200-L236)
- [backend/middleware/auth.js](file://backend/middleware/auth.js#L0-L37)
- [frontend/src/services/api.ts](file://frontend/src/services/api.ts#L0-L46)

## 生产环境安全实践

### 敏感信息保护

- **禁止提交**：`.env` 文件必须加入 `.gitignore`，防止密钥泄露
- **Vercel 注入**：生产环境所有敏感变量通过 Vercel 控制台设置
- **最小权限原则**：`BLOB_READ_WRITE_TOKEN` 仅授予必要权限

### 配置最佳实践

1. **使用 .env.example 模板**  
   提供示例文件，指导开发者正确配置：
   ```bash
   cp backend/setting.env.example backend/setting.env
   cp frontend/setting.env.example frontend/setting.env
   ```

2. **环境区分**  
   通过 `NODE_ENV` 区分开发、测试、生产环境，应用不同配置策略。

3. **Cloudflare Worker 代理**  
   用于优化国内访问速度，配置如下：
   ```javascript
   // cloudflare-worker.js
   const API_ORIGIN = 'https://your-backend.vercel.app'
   ```
   前端将 `VITE_APP_API_URL` 指向 Worker 地址。

**Section sources**  
- [README.md](file://README.md#L73-L94)
- [README.md](file://README.md#L132-L160)
- [cloudflare-worker.js](file://cloudflare-worker.js#L42-L60)

## 总结
本项目通过清晰的环境变量设计，实现了开发与生产环境的无缝切换。后端依赖 `MONGODB_URI`、`JWT_SECRET` 和 `BLOB_READ_WRITE_TOKEN` 保障数据与安全，前端通过 `VITE_APP_API_URL` 灵活指向不同后端服务。合理使用 `.env` 文件模板和 Vercel 环境注入机制，既方便本地开发，又确保生产安全。建议始终遵循最小权限和敏感信息隔离原则，定期审查配置项的有效性与安全性。