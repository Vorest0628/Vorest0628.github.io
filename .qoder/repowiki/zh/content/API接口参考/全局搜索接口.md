# 全局搜索接口

<cite>
**本文档引用的文件**
- [searchRoutes.js](file://backend/routes/searchRoutes.js#L1-L17)
- [searchController.js](file://backend/controllers/searchController.js#L1-L373)
- [SearchView.vue](file://frontend/src/views/SearchView.vue#L1-L631)
- [index.ts](file://frontend/src/api/index.ts#L1-L92)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介
本文档详细说明了网站中全局搜索功能的实现机制。该功能通过单一API接口 `/api/search` 实现跨内容类型的统一检索，支持对博客、文档等多种资源的关键词搜索。后端基于MongoDB的文本索引与模糊匹配双重策略，前端通过 `SearchView.vue` 提供用户友好的搜索界面。文档涵盖接口定义、查询参数、响应结构、后端实现逻辑及前后端集成方式。

## 项目结构
全局搜索功能涉及前后端多个模块，其文件组织结构如下：

```mermaid
graph TB
subgraph "后端"
SR[searchRoutes.js]
SC[searchController.js]
B[Blog.js]
D[Document.js]
end
subgraph "前端"
SV[SearchView.vue]
AI[index.ts]
API[apiService.ts]
end
SR --> SC
SC --> B
SC --> D
SV --> AI
AI --> API
AI --> SR
```

**图示来源**
- [searchRoutes.js](file://backend/routes/searchRoutes.js#L1-L17)
- [searchController.js](file://backend/controllers/searchController.js#L1-L373)
- [SearchView.vue](file://frontend/src/views/SearchView.vue#L1-L631)

**本节来源**
- [searchRoutes.js](file://backend/routes/searchRoutes.js#L1-L17)
- [searchController.js](file://backend/controllers/searchController.js#L1-L373)
- [SearchView.vue](file://frontend/src/views/SearchView.vue#L1-L631)

## 核心组件
全局搜索功能的核心组件包括：
- **searchRoutes.js**：定义 `/api/search` 路由，绑定控制器
- **searchController.js**：实现搜索逻辑，整合多类型内容
- **SearchView.vue**：提供搜索界面与用户交互
- **index.ts**：封装搜索API供前端调用

这些组件协同工作，实现从用户输入到结果展示的完整流程。

**本节来源**
- [searchRoutes.js](file://backend/routes/searchRoutes.js#L1-L17)
- [searchController.js](file://backend/controllers/searchController.js#L1-L373)
- [SearchView.vue](file://frontend/src/views/SearchView.vue#L1-L631)

## 架构概述
全局搜索采用分层架构，从前端界面到后端数据访问形成清晰的数据流：

```mermaid
sequenceDiagram
participant 用户 as "用户"
participant 前端 as "SearchView.vue"
participant API as "searchApi"
participant 后端 as "searchController"
participant 数据库 as "MongoDB"
用户->>前端 : 输入关键词并搜索
前端->>API : 调用 searchApi.searchAll(params)
API->>后端 : 发送 GET /api/search 请求
后端->>数据库 : 执行文本搜索与正则匹配
数据库-->>后端 : 返回博客与文档结果
后端->>后端 : 合并、排序、分页处理
后端-->>API : 返回结构化搜索结果
API-->>前端 : 解析响应数据
前端->>前端 : 根据过滤器显示结果
前端-->>用户 : 展示搜索结果页面
```

**图示来源**
- [searchController.js](file://backend/controllers/searchController.js#L1-L373)
- [SearchView.vue](file://frontend/src/views/SearchView.vue#L1-L631)

## 详细组件分析

### 后端搜索控制器分析
`searchController.js` 是搜索功能的核心，实现了跨内容类型的检索逻辑。

#### 搜索流程图
```mermaid
flowchart TD
Start([开始搜索]) --> 检查关键词["检查搜索关键词"]
检查关键词 --> 关键词为空{"关键词为空?"}
关键词为空 --> |是| 返回空结果["返回空结果集"]
关键词为空 --> |否| 确定类型["确定搜索类型 (全部/博客/文档)"]
确定类型 --> 搜索博客{"需要搜索博客?"}
搜索博客 --> |是| 文本搜索博客["尝试文本搜索"]
文本搜索博客 --> 博客结果少{"结果少于10条?"}
博客结果少 --> |是| 正则搜索博客["补充正则搜索"]
博客结果少 --> |否| 处理博客结果["处理博客结果"]
正则搜索博客 --> 处理博客结果
确定类型 --> 搜索文档{"需要搜索文档?"}
搜索文档 --> |是| 文本搜索文档["尝试文本搜索"]
文本搜索文档 --> 文档结果少{"结果少于10条?"}
文档结果少 --> |是| 正则搜索文档["补充正则搜索"]
文档结果少 --> |否| 处理文档结果["处理文档结果"]
正则搜索文档 --> 处理文档结果
处理博客结果 --> 合并结果["合并博客与文档结果"]
处理文档结果 --> 合并结果
合并结果 --> 排序["按相关性分数排序"]
排序 --> 分页["执行分页处理"]
分页 --> 返回响应["返回JSON响应"]
返回空结果 --> 返回响应
返回响应 --> End([结束])
```

**图示来源**
- [searchController.js](file://backend/controllers/searchController.js#L1-L373)

#### 相关性评分机制
系统为每个搜索结果计算相关性分数，主要依据以下因素：
- **标题匹配**：+10分（权重最高）
- **摘要匹配**：+8分
- **内容匹配**：+5分
- **分类匹配**：+3分
- **标签匹配**：+2分

此评分机制确保最相关的结果排在前面。

**本节来源**
- [searchController.js](file://backend/controllers/searchController.js#L1-L373)

### 前端搜索视图分析
`SearchView.vue` 是用户与搜索功能交互的界面组件，实现了完整的搜索体验。

#### 用户交互流程
```mermaid
flowchart TD
A([页面加载]) --> B{URL中有q参数?}
B --> |是| C[提取搜索关键词和分页信息]
B --> |否| D[等待用户输入]
C --> E[发起搜索请求]
D --> E
E --> F[显示加载状态]
F --> G[接收搜索结果]
G --> H{结果成功?}
H --> |是| I[渲染结果列表]
H --> |否| J[显示错误信息]
I --> K{用户操作?}
K --> L[切换过滤器]
K --> M[翻页]
K --> N[修改搜索词]
L --> O[更新URL并重新搜索]
M --> O
N --> O
O --> E
```

**图示来源**
- [SearchView.vue](file://frontend/src/views/SearchView.vue#L1-L631)

#### 响应式数据结构
组件使用Vue 3的Composition API管理状态：

```mermaid
classDiagram
class SearchView {
+loading : boolean
+error : string
+searchQuery : string
+searchResults : object
+activeFilter : string
+currentPage : number
+total : number
+totalPages : number
+resultCounts : object
+searchTime : number
+displayResults : computed
+visiblePages : computed
+search(query, page) : Promise
+setFilter(filter) : void
+goToPage(page) : void
+updateURL() : void
+retry() : void
+formatDate(date) : string
+formatFileSize(bytes) : string
}
```

**图示来源**
- [SearchView.vue](file://frontend/src/views/SearchView.vue#L1-L631)

## 依赖分析
全局搜索功能的依赖关系清晰，前后端职责分明：

```mermaid
graph TD
SearchView --> searchApi
searchApi --> apiService
apiService --> searchRoutes
searchRoutes --> searchController
searchController --> BlogModel
searchController --> DocumentModel
BlogModel --> MongoDB
DocumentModel --> MongoDB
```

**图示来源**
- [searchRoutes.js](file://backend/routes/searchRoutes.js#L1-L17)
- [searchController.js](file://backend/controllers/searchController.js#L1-L373)
- [SearchView.vue](file://frontend/src/views/SearchView.vue#L1-L631)

**本节来源**
- [searchRoutes.js](file://backend/routes/searchRoutes.js#L1-L17)
- [searchController.js](file://backend/controllers/searchController.js#L1-L373)
- [SearchView.vue](file://frontend/src/views/SearchView.vue#L1-L631)

## 性能考虑
搜索功能在性能方面采取了多项优化措施：
- **双重搜索策略**：优先使用MongoDB文本索引，失败时回退到正则匹配
- **结果限制**：每个类型最多获取50条结果，避免数据库压力
- **去重合并**：防止文本搜索与正则搜索结果重复
- **前端分页**：后端返回所有匹配结果，前端进行分页展示
- **相关性预计算**：在后端计算相关性分数，减少前端处理负担

这些措施确保了搜索功能在大数据量下的响应速度。

## 故障排除指南
### 常见问题及解决方案
- **问题**：搜索无结果返回
  - **原因**：关键词拼写错误或内容中不存在
  - **解决方案**：检查拼写，尝试更通用的关键词

- **问题**：连接服务器失败
  - **原因**：后端服务未启动或网络问题
  - **解决方案**：确认后端服务正在运行，检查网络连接

- **问题**：搜索接口404
  - **原因**：API路由配置错误
  - **解决方案**：检查 `searchRoutes.js` 是否正确挂载

- **问题**：搜索结果不准确
  - **原因**：MongoDB文本索引未创建或过期
  - **解决方案**：为Blog和Document集合创建文本索引

**本节来源**
- [searchController.js](file://backend/controllers/searchController.js#L1-L373)
- [SearchView.vue](file://frontend/src/views/SearchView.vue#L1-L631)

## 结论
全局搜索功能通过 `GET /api/search` 接口实现了跨内容类型的统一检索，后端采用文本索引与模糊匹配相结合的策略确保搜索效果，前端提供直观的用户界面和交互体验。系统设计合理，代码结构清晰，具备良好的可维护性和扩展性。未来可考虑增加更多内容类型（如图库、评论）的支持，并引入全文搜索引擎（如Elasticsearch）以提升大规模数据下的搜索性能。