import{r as c,c as _,j as V,y as u,z as i,A as t,K as S,O as d,u as C,M as h,Q as B,I as D,al as M,V as N,J as y,aj as T,ae as U,P as I,a6 as R,H as j}from"./vendor-CeqXcVya.js";import{_ as q,u as z}from"./index-BH5EIy1g.js";import{d as k,C as G}from"./CommentNode-BISccqNQ.js";import"./particles-D6-XlEtG.js";const L={class:"comments"},F={class:"comment-stats"},H={class:"stat-item"},J={class:"stat-number"},K={class:"stat-item"},O={class:"stat-number"},Q={class:"stat-item"},W={class:"stat-number"},X={class:"comment-form"},Y={key:0,class:"login-prompt"},Z={class:"user-info"},$={class:"current-user"},ee={class:"form-row"},te={class:"comment-options"},se={class:"checkbox-label"},oe={class:"form-actions"},ae=["disabled"],ne={key:0,class:"loading-state"},le={key:1,class:"error-state"},re={key:2,class:"comment-list"},ie={key:3,class:"empty-state"},ue={__name:"Comments",setup(de){const m=z(),l=c([]),p=c(!1),v=c(""),r=c({content:"",isPublic:!0}),f=c(!1),x=_(()=>l.value.length),w=_(()=>{let s=0;const e=o=>{o.replies&&o.replies.length>0&&(s+=o.replies.length,o.replies.forEach(e))};return l.value.forEach(e),s}),A=_(()=>{const s=new Set,e=o=>{o.author&&o.author.username&&s.add(o.author.username),o.replies&&o.replies.length>0&&o.replies.forEach(e)};return l.value.forEach(e),s.size}),b=async()=>{p.value=!0,v.value="";try{const s=await k.getTargetComments("General","000000000000000000000001",{page:1,limit:100,sortBy:"createdAt",order:"desc"});if(s.success)l.value=s.data;else throw new Error(s.message||"获取留言失败")}catch(s){console.error("获取留言失败:",s),v.value=s.message||"获取留言失败，请稍后重试",l.value=[]}finally{p.value=!1}},E=async()=>{if(!m.isAuthenticated){alert("请先登录后再发表留言");return}if(!r.value.content.trim()){alert("请输入留言内容");return}f.value=!0;try{const s={content:r.value.content.trim(),targetType:"General",targetId:"000000000000000000000001",parentComment:null,isPublic:r.value.isPublic},e=await k.createComment(s);if(e.success)g(e.data),r.value.content="",r.value.isPublic=!0,alert("留言发布成功！");else throw new Error(e.message||"发布留言失败")}catch(s){console.error("提交留言失败:",s),alert("发布留言失败: "+(s.message||"请稍后重试"))}finally{f.value=!1}},g=s=>{if(!s.parentComment)l.value.unshift(s);else{const e=(o,a)=>{for(const n of o){if(n._id===a.parentComment)return n.replies||(n.replies=[]),n.replies.push(a),!0;if(n.replies&&e(n.replies,a))return!0}return!1};e(l.value,s)}},P=s=>{const e=(o,a)=>{for(let n=o.length-1;n>=0;n--){if(o[n]._id===a)return o.splice(n,1),!0;if(o[n].replies&&e(o[n].replies,a))return!0}return!1};e(l.value,s)};return V(async()=>{await m.initAuth(),await b()}),(s,e)=>{const o=M("router-link");return i(),u("div",L,[e[13]||(e[13]=t("h1",null,"留言板",-1)),e[14]||(e[14]=t("p",{class:"page-description"},"欢迎在这里留下您的足迹，分享想法和建议～",-1)),t("div",F,[t("div",H,[t("span",J,d(x.value),1),e[2]||(e[2]=t("span",{class:"stat-label"},"条留言",-1))]),t("div",K,[t("span",O,d(w.value),1),e[3]||(e[3]=t("span",{class:"stat-label"},"条回复",-1))]),t("div",Q,[t("span",W,d(A.value),1),e[4]||(e[4]=t("span",{class:"stat-label"},"位访客",-1))])]),t("div",X,[e[9]||(e[9]=t("h3",null,"发表留言",-1)),C(m).isAuthenticated?(i(),u("form",{key:1,onSubmit:N(E,["prevent"])},[t("div",Z,[t("span",$,"当前用户: "+d(C(m).user.username),1)]),t("div",ee,[y(t("textarea",{"onUpdate:modelValue":e[0]||(e[0]=a=>r.value.content=a),placeholder:"写下你的想法和建议...",required:"",rows:"4",class:"form-textarea"},null,512),[[T,r.value.content]])]),t("div",te,[t("label",se,[y(t("input",{"onUpdate:modelValue":e[1]||(e[1]=a=>r.value.isPublic=a),type:"checkbox",class:"checkbox-input"},null,512),[[U,r.value.isPublic]]),e[8]||(e[8]=t("span",{class:"checkbox-text"},"公开留言",-1))])]),t("div",oe,[t("button",{type:"submit",class:"submit-btn",disabled:f.value},d(f.value?"发布中...":"发布留言"),9,ae)])],32)):(i(),u("div",Y,[t("p",null,[e[6]||(e[6]=h("请先")),B(o,{to:"/auth"},{default:D(()=>e[5]||(e[5]=[h("登录")])),_:1,__:[5]}),e[7]||(e[7]=h("后再发表留言"))])]))]),p.value?(i(),u("div",ne,e[10]||(e[10]=[t("p",null,"正在加载评论...",-1)]))):v.value?(i(),u("div",le,[e[11]||(e[11]=t("h3",null,"加载失败",-1)),t("p",null,d(v.value),1),t("button",{onClick:b,class:"retry-btn"},"重试")])):(i(),u("div",re,[(i(!0),u(I,null,R(l.value,a=>(i(),j(G,{key:a._id,comment:a,onCommentDeleted:P,onCommentAdded:g},null,8,["comment"]))),128))])),!p.value&&l.value.length===0?(i(),u("div",ie,e[12]||(e[12]=[t("h3",null,"还没有留言",-1),t("p",null,"成为第一个发表留言的人吧！",-1)]))):S("",!0)])}}},fe=q(ue,[["__scopeId","data-v-45c831d3"]]);export{fe as default};
