import{r as e,c as a,j as s,y as t,z as l,A as n,K as r,O as i,u,M as c,Q as o,I as m,al as p,V as d,J as v,aj as h,ae as f,P as b,a6 as y,H as g}from"./vue-core-BYuX5Vli.js";import{_ as k,u as w}from"./index-B6AuLqK3.js";import{c as C,C as _}from"./CommentNode-DGiGoMRI.js";import"./element-ui-drMXFw0_.js";import"./utils-DA1bHc0c.js";const x={class:"comments"},j={class:"comment-stats"},P={class:"stat-item"},A={class:"stat-number"},E={class:"stat-item"},I={class:"stat-number"},V={class:"stat-item"},q={class:"stat-number"},z={class:"comment-form"},G={key:0,class:"login-prompt"},S={class:"user-info"},T={class:"current-user"},U={class:"form-row"},B={class:"comment-options"},D={class:"checkbox-label"},H={class:"form-actions"},J=["disabled"],K={key:0,class:"loading-state"},M={key:1,class:"error-state"},N={key:2,class:"comment-list"},O={key:3,class:"empty-state"},Q=k({__name:"Comments",setup(k){const Q=w(),F=e([]),L=e(!1),R=e(""),W=e({content:"",isPublic:!0}),X=e(!1),Y=a(()=>F.value.length),Z=a(()=>{let e=0;const a=s=>{s.replies&&s.replies.length>0&&(e+=s.replies.length,s.replies.forEach(a))};return F.value.forEach(a),e}),$=a(()=>{const e=new Set,a=s=>{s.author&&s.author.username&&e.add(s.author.username),s.replies&&s.replies.length>0&&s.replies.forEach(a)};return F.value.forEach(a),e.size}),ee=async()=>{L.value=!0,R.value="";try{const e=await C.getTargetComments("General","000000000000000000000001",{page:1,limit:100,sortBy:"createdAt",order:"desc"});if(!e.success)throw new Error(e.message||"获取留言失败");F.value=e.data}catch(e){R.value=e.message||"获取留言失败，请稍后重试",F.value=[]}finally{L.value=!1}},ae=async()=>{if(Q.isAuthenticated)if(W.value.content.trim()){X.value=!0;try{const e={content:W.value.content.trim(),targetType:"General",targetId:"000000000000000000000001",parentComment:null,isPublic:W.value.isPublic},a=await C.createComment(e);if(!a.success)throw new Error(a.message||"发布留言失败");se(a.data),W.value.content="",W.value.isPublic=!0,alert("留言发布成功！")}catch(e){alert("发布留言失败: "+(e.message||"请稍后重试"))}finally{X.value=!1}}else alert("请输入留言内容");else alert("请先登录后再发表留言")},se=e=>{if(e.parentComment){const a=(e,s)=>{for(const t of e){if((t.id||t._id)===s.parentComment)return t.replies||(t.replies=[]),t.replies.push(s),!0;if(t.replies&&a(t.replies,s))return!0}return!1};a(F.value,e)}else F.value.unshift(e)},te=e=>{const a=(e,s)=>{for(let t=e.length-1;t>=0;t--){if((e[t].id||e[t]._id)===s)return e.splice(t,1),!0;if(e[t].replies&&a(e[t].replies,s))return!0}return!1};a(F.value,e)};return s(async()=>{await Q.initAuth(),await ee()}),(e,a)=>{const s=p("router-link");return l(),t("div",x,[a[13]||(a[13]=n("h1",null,"留言板",-1)),a[14]||(a[14]=n("p",{class:"page-description"},"欢迎在这里留下您的足迹，分享想法和建议～",-1)),n("div",j,[n("div",P,[n("span",A,i(Y.value),1),a[2]||(a[2]=n("span",{class:"stat-label"},"条留言",-1))]),n("div",E,[n("span",I,i(Z.value),1),a[3]||(a[3]=n("span",{class:"stat-label"},"条回复",-1))]),n("div",V,[n("span",q,i($.value),1),a[4]||(a[4]=n("span",{class:"stat-label"},"位访客",-1))])]),n("div",z,[a[9]||(a[9]=n("h3",null,"发表留言",-1)),u(Q).isAuthenticated?(l(),t("form",{key:1,onSubmit:d(ae,["prevent"])},[n("div",S,[n("span",T,"当前用户: "+i(u(Q).user.username),1)]),n("div",U,[v(n("textarea",{"onUpdate:modelValue":a[0]||(a[0]=e=>W.value.content=e),placeholder:"写下你的想法和建议...",required:"",rows:"4",class:"form-textarea"},null,512),[[h,W.value.content]])]),n("div",B,[n("label",D,[v(n("input",{"onUpdate:modelValue":a[1]||(a[1]=e=>W.value.isPublic=e),type:"checkbox",class:"checkbox-input"},null,512),[[f,W.value.isPublic]]),a[8]||(a[8]=n("span",{class:"checkbox-text"},"公开留言",-1))])]),n("div",H,[n("button",{type:"submit",class:"submit-btn",disabled:X.value},i(X.value?"发布中...":"发布留言"),9,J)])],32)):(l(),t("div",G,[n("p",null,[a[6]||(a[6]=c("请先")),o(s,{to:"/auth"},{default:m(()=>a[5]||(a[5]=[c("登录")])),_:1,__:[5]}),a[7]||(a[7]=c("后再发表留言"))])]))]),L.value?(l(),t("div",K,a[10]||(a[10]=[n("p",null,"正在加载评论...",-1)]))):R.value?(l(),t("div",M,[a[11]||(a[11]=n("h3",null,"加载失败",-1)),n("p",null,i(R.value),1),n("button",{onClick:ee,class:"retry-btn"},"重试")])):(l(),t("div",N,[(l(!0),t(b,null,y(F.value,e=>(l(),g(_,{key:e.id||e._id,comment:e,onCommentDeleted:te,onCommentAdded:se},null,8,["comment"]))),128))])),L.value||0!==F.value.length?r("",!0):(l(),t("div",O,a[12]||(a[12]=[n("h3",null,"还没有留言",-1),n("p",null,"成为第一个发表留言的人吧！",-1)])))])}}},[["__scopeId","data-v-487f6c92"]]);export{Q as default};
