import{b as e,_ as a,u as t}from"./index-B6AuLqK3.js";import{r as l,X as s,c as n,j as o,y as i,z as r,A as u,H as c,J as d,aj as v,aX as p,P as m,a6 as g,M as y,K as f,O as b,D as h,V as w,a1 as k,aQ as C,ae as _,ag as T,C as x,aP as I,L as U}from"./vue-core-BYuX5Vli.js";import{authStorage as D}from"./auth-CVx9WU4Z.js";import{adminApi as A}from"./admin-DYrCn_N8.js";import{m as V}from"./marked.esm-BNz8l3bD.js";import{p as L}from"./purify.es-COJDRNUs.js";import{f as P}from"./friendLink-BvIdLo5P.js";import{g as S}from"./gallery-DWscGW5t.js";import{d as j}from"./document-BWgxCF9I.js";import{U as E}from"./UserPanel-6kLqNBdo.js";import"./element-ui-drMXFw0_.js";import"./utils-DA1bHc0c.js";async function z(a){const t=new FormData;t.append("image",a);const l=await e.post("/admin/uploads/images",t,{headers:{"Content-Type":"multipart/form-data"}});if(!(null==l?void 0:l.success))throw new Error((null==l?void 0:l.message)||"上传失败");return l.data}const O={class:"admin-blog-manager"},$={class:"manager-header"},M={class:"blog-list"},F={class:"list-header"},B={class:"search-bar"},q={class:"filter-bar"},N={class:"blog-table"},X={class:"blog-title"},R={key:0,class:"pinned-indicator"},G={class:"blog-summary"},W={class:"category-badge"},J={class:"action-buttons"},Q=["onClick"],H=["onClick"],K={class:"modal-header"},Y={class:"modal-body"},Z={class:"form-group"},ee={class:"form-group"},ae={class:"form-group"},te={class:"content-header"},le={key:0,class:"assets-counter"},se={class:"markdown-editor"},ne=["innerHTML"],oe={class:"form-group"},ie={class:"cover-row"},re={key:0,class:"cover-preview"},ue=["src"],ce={class:"form-group"},de={class:"form-group"},ve=["value"],pe={key:0,class:"mt-2"},me={class:"form-group"},ge={class:"form-actions"},ye={type:"submit",class:"save-btn"},fe={__name:"AdminBlogManager",setup(e){t();const a=l([]),C=l([]),_=l(""),T=l(""),x=l(!1),I=l(!1),U=l(!1),D=l(""),P=l(null),S=l(null),j=l(null),E=l([]),fe=l(null),be=l(new Map),he=l(["前端开发","AI技术","游戏","音乐"]),we=s({id:null,title:"",excerpt:"",content:"",category:"",newCategoryText:"",tags:"",status:"draft",coverImage:""}),ke=new V.Renderer;ke.image=(e="",a,t)=>{if("object"==typeof e&&null!==e){const l=e;e=l.href||"",a=l.title,t=l.text||l.alt||""}const l=/^(https?:|data:)/i.test(e),s=/^\/api\/blog\//i.test(e);let n=e;if(l||s)s&&(n=`https://api.shirakawananase.top${e}`);else{const a=String(e).replace(/^\.\//,"").replace(/\\/g,"/").replace(/^\//,""),t=be.value.get(a);n=t||e}return`<img src="${n}" alt="${t||""}"${a?` title="${a}"`:""} loading="lazy" decoding="async">`},V.setOptions({renderer:ke});const Ce=n(()=>{const e=V(we.content||"");return L.sanitize(e)}),_e=()=>{"__other__"!==we.category&&(we.newCategoryText="")},Te=()=>{var e;null==(e=P.value)||e.click()},xe=()=>{var e;null==(e=j.value)||e.click()},Ie=e=>{const a=e.target.files[0];if(!a)return;if(a.type&&"text/markdown"!==a.type&&!a.name.endsWith(".md"))return void alert("请选择一个 Markdown (.md) 文件。");const t=new FileReader;t.onload=e=>{we.content=e.target.result},t.onerror=e=>{alert("文件读取失败")},t.readAsText(a)},Ue=async e=>{const a=Array.from(e.target.files||[]);E.value=a,be.value=new Map;for(const t of a){if(/\.zip$/i.test(t.name))continue;const e=URL.createObjectURL(t);be.value.set(t.name.replace(/\\/g,"/"),e)}},De=async()=>{U.value=!0,D.value="";try{const e=await A.getAllBlogs();if(!e.success)throw new Error(e.message||"获取博客列表失败");a.value=e.data.blogs||[],C.value=e.data.blogs||[],(()=>{const e=new Set(["前端开发","AI技术","游戏","音乐"]);a.value.forEach(a=>{a.category&&e.add(a.category)}),he.value=Array.from(e).sort()})()}catch(e){D.value=e.message||"获取博客列表失败，请稍后重试",a.value=[],C.value=[]}finally{U.value=!1}},Ae=()=>{let e=a.value;if(_.value){const a=_.value.toLowerCase();e=e.filter(e=>e.title.toLowerCase().includes(a)||e.excerpt.toLowerCase().includes(a)||e.content.toLowerCase().includes(a)||e.tags&&e.tags.some(e=>e.toLowerCase().includes(a)))}T.value&&(e=e.filter(e=>e.status===T.value)),C.value=e},Ve=async()=>{var e;try{const a="__other__"===we.category?we.newCategoryText.trim():we.category,t={title:we.title,excerpt:we.excerpt,content:we.content,category:a,tags:we.tags.split(",").map(e=>e.trim()).filter(Boolean),status:we.status,coverImage:we.coverImage||""};if(!t.title)return void alert("请填写博客标题");if(!t.excerpt)return void alert("请填写博客摘要");if(!t.content)return void alert("请填写博客内容");if(!t.category)return void alert("请选择博客分类");if("__other__"===we.category&&!we.newCategoryText.trim())return void alert("请输入新分类名称");let l;if(/!\[[^\]]*\]\((?!https?:|data:|\/api\/blog\/)[^\)]+\)/i.test(t.content)&&((null==(e=E.value)?void 0:e.length)||0)>0){const e=new FormData,a=new Blob([t.content],{type:"text/markdown"});e.append("markdown",a,`${Date.now()}.md`),e.append("title",t.title),e.append("excerpt",t.excerpt),e.append("category",t.category);for(const l of t.tags)e.append("tags",l);e.append("status",t.status),!x.value&&we.id&&e.append("blogId",we.id);for(const t of E.value)e.append("assets",t);l=await A.importMarkdown(e)}else l=x.value?await A.createBlog(t):await A.updateBlog(we.id,t);if(!l.success)throw new Error(l.message||"保存失败");await De(),Le(),alert(x.value?"博客创建成功!":"博客更新成功!")}catch(a){let e="保存失败";if(a.response){const t=a.response.data;switch(t.message&&(e+=": "+t.message),a.response.status){case 400:e="数据验证失败 - 请检查所有必填字段是否正确填写",t.errors&&(e+="\n详细错误: "+JSON.stringify(t.errors));break;case 401:e="认证失败 - 请重新登录";break;case 403:e="权限不足 - 您没有权限执行此操作";break;case 500:e="服务器内部错误 - 请稍后重试"}}else e=a.request?"网络连接失败 - 请检查网络连接":a.message;alert(e)}},Le=()=>{x.value=!1,I.value=!1,Object.assign(we,{id:null,title:"",excerpt:"",content:"",category:"",newCategoryText:"",tags:"",status:"draft",coverImage:""}),E.value=[],be.value=new Map,j.value&&(j.value.value=""),fe.value&&(fe.value.value="")};const Pe=async e=>{const a=(e.clipboardData||e.originalEvent.clipboardData).items;for(let t=0;t<a.length;t++){const l=a[t];if("file"===l.kind&&-1!==l.type.indexOf("image")){e.preventDefault();const a=l.getAsFile();await je(a);break}}},Se=async e=>{e.preventDefault();const a=e.dataTransfer.files;for(let t=0;t<a.length;t++){const e=a[t];if(-1!==e.type.indexOf("image")){await je(e);break}}},je=async e=>{try{const a=await z(e),t=`![${e.name}](${a.url})`;!function(e,a){const t=e.selectionStart,l=e.selectionEnd,s=e.value;e.value=s.slice(0,t)+a+s.slice(l);const n=t+a.length;e.selectionStart=e.selectionEnd=n,e.dispatchEvent(new Event("input"))}(S.value,t)}catch(a){alert("图片上传失败: "+a.message)}},Ee=()=>{var e;null==(e=fe.value)||e.click()},ze=async e=>{var a;const t=null==(a=e.target.files)?void 0:a[0];if(t)try{const e=await z(t);we.coverImage=e.url}catch(l){alert("封面上传失败: "+l.message)}},Oe=e=>{if(!e)return"";const a=/^(https?:|data:)/i.test(e),t=/^\/api\/blog\//i.test(e);return a?e:t?`https://api.shirakawananase.top${e}`:e},$e=()=>{},Me=e=>{if(!e)return"N/A";const a=new Date(e);return isNaN(a.getTime())?"Invalid Date":a.toLocaleDateString("zh-CN")};return o(()=>{De()}),(e,a)=>(r(),i("div",O,[u("div",$,[a[13]||(a[13]=u("h2",null,"博客管理",-1)),u("button",{onClick:a[0]||(a[0]=e=>x.value=!0),class:"create-btn"}," ➕ 创建博客 ")]),u("div",M,[u("div",F,[u("div",B,[d(u("input",{"onUpdate:modelValue":a[1]||(a[1]=e=>_.value=e),placeholder:"搜索博客标题或内容...",onInput:Ae},null,544),[[v,_.value]])]),u("div",q,[d(u("select",{"onUpdate:modelValue":a[2]||(a[2]=e=>T.value=e),onChange:Ae},a[14]||(a[14]=[u("option",{value:""},"全部状态",-1),u("option",{value:"published"},"已发布",-1),u("option",{value:"draft"},"草稿",-1),u("option",{value:"pinned"},"置顶",-1)]),544),[[p,T.value]])])]),u("div",N,[u("table",null,[a[15]||(a[15]=u("thead",null,[u("tr",null,[u("th",null,"标题"),u("th",null,"分类"),u("th",null,"状态"),u("th",null,"创建时间"),u("th",null,"更新时间"),u("th",null,"操作")])],-1)),u("tbody",null,[(r(!0),i(m,null,g(C.value,e=>{return r(),i("tr",{key:e._id||e.id},[u("td",null,[u("div",X,[y(b(e.title)+" ",1),"pinned"===e.status?(r(),i("span",R,"📌")):f("",!0),u("span",G,b(e.excerpt),1)])]),u("td",null,[u("span",W,b(e.category),1)]),u("td",null,[u("span",{class:h(["status-badge",e.status])},b((a=e.status,{draft:"草稿",published:"已发布",pinned:"置顶"}[a]||a)),3)]),u("td",null,b(Me(e.createdAt)),1),u("td",null,b(Me(e.updatedAt)),1),u("td",null,[u("div",J,[u("button",{onClick:a=>(e=>{var a;Object.assign(we,{id:e._id||e.id,title:e.title,excerpt:e.excerpt,content:e.content,category:e.category,newCategoryText:"",tags:(null==(a=e.tags)?void 0:a.join(","))||"",status:e.status||"draft",coverImage:e.coverImage||""}),I.value=!0})(e),class:"edit-btn"},"编辑",8,Q),u("button",{onClick:a=>(async e=>{if(confirm("确定要删除这篇博客吗？"))try{const a=await A.deleteBlog(e);if(!a.success&&"博客已删除"!==a.message)throw new Error(a.message||"删除失败");await De(),alert("博客删除成功!")}catch(a){alert("删除失败: "+a.message)}})(e._id||e.id),class:"delete-btn"},"删除",8,H)])])]);var a}),128))])])])]),(r(),c(k,{to:"body"},[x.value||I.value?(r(),i("div",{key:0,class:"modal-overlay",onClick:Le},[u("div",{class:"modal-content",onClick:a[12]||(a[12]=w(()=>{},["stop"]))},[u("div",K,[u("h3",null,b(x.value?"创建博客":"编辑博客"),1),u("button",{onClick:Le,class:"close-btn"},"✕")]),u("div",Y,[u("form",{onSubmit:w(Ve,["prevent"])},[u("div",Z,[a[16]||(a[16]=u("label",null,"标题",-1)),d(u("input",{"onUpdate:modelValue":a[3]||(a[3]=e=>we.title=e),type:"text",required:""},null,512),[[v,we.title]])]),u("div",ee,[a[17]||(a[17]=u("label",null,"摘要",-1)),d(u("textarea",{"onUpdate:modelValue":a[4]||(a[4]=e=>we.excerpt=e),rows:"3"},null,512),[[v,we.excerpt]])]),u("div",ae,[u("div",te,[a[18]||(a[18]=u("label",null,"内容 (Markdown)",-1)),u("button",{type:"button",onClick:Te,class:"upload-md-btn"},"从文件上传"),u("input",{type:"file",ref_key:"markdownFileInput",ref:P,onChange:Ie,accept:".md",style:{display:"none"}},null,544),u("button",{type:"button",onClick:xe,class:"upload-md-btn"},"添加资源"),u("input",{type:"file",ref_key:"assetsInput",ref:j,onChange:Ue,multiple:"",style:{display:"none"},accept:"image/*,.zip"},null,544),E.value.length?(r(),i("span",le,"已添加 "+b(E.value.length)+" 个资源",1)):f("",!0)]),u("div",se,[d(u("textarea",{"onUpdate:modelValue":a[5]||(a[5]=e=>we.content=e),ref_key:"markdownTextarea",ref:S,rows:"15",required:"",class:"markdown-input",onPaste:Pe,onDrop:Se,onDragover:a[6]||(a[6]=w(()=>{},["prevent"]))},null,544),[[v,we.content]]),u("div",{innerHTML:Ce.value,class:"markdown-preview"},null,8,ne)])]),u("div",oe,[a[19]||(a[19]=u("label",null,"封面图（可选）",-1)),u("div",ie,[d(u("input",{"onUpdate:modelValue":a[7]||(a[7]=e=>we.coverImage=e),type:"text",placeholder:"封面图 URL 或相对路径"},null,512),[[v,we.coverImage]]),u("input",{type:"file",ref_key:"coverInput",ref:fe,accept:"image/*",style:{display:"none"},onChange:ze},null,544),u("button",{type:"button",class:"upload-md-btn",onClick:Ee},"上传封面")]),we.coverImage?(r(),i("div",re,[u("img",{src:Oe(we.coverImage),alt:"封面预览",onError:$e},null,40,ue)])):f("",!0)]),u("div",ce,[a[20]||(a[20]=u("label",null,"标签",-1)),d(u("input",{"onUpdate:modelValue":a[8]||(a[8]=e=>we.tags=e),type:"text",placeholder:"用逗号分隔多个标签"},null,512),[[v,we.tags]])]),u("div",de,[a[23]||(a[23]=u("label",null,"分类",-1)),d(u("select",{"onUpdate:modelValue":a[9]||(a[9]=e=>we.category=e),onChange:_e,required:""},[a[21]||(a[21]=u("option",{value:""},"请选择分类",-1)),(r(!0),i(m,null,g(he.value,e=>(r(),i("option",{key:e,value:e},b(e),9,ve))),128)),a[22]||(a[22]=u("option",{value:"__other__"},"其他",-1))],544),[[p,we.category]]),"__other__"===we.category?(r(),i("div",pe,[d(u("input",{"onUpdate:modelValue":a[10]||(a[10]=e=>we.newCategoryText=e),type:"text",placeholder:"输入新分类名称",required:"",class:"form-control"},null,512),[[v,we.newCategoryText]])])):f("",!0)]),u("div",me,[a[25]||(a[25]=u("label",null,"状态",-1)),d(u("select",{"onUpdate:modelValue":a[11]||(a[11]=e=>we.status=e)},a[24]||(a[24]=[u("option",{value:"draft"},"草稿",-1),u("option",{value:"published"},"发布",-1),u("option",{value:"pinned"},"置顶",-1)]),512),[[p,we.status]])]),u("div",ge,[u("button",{type:"button",onClick:Le,class:"cancel-btn"},"取消"),u("button",ye,b(x.value?"创建":"保存"),1)])],32)])])])):f("",!0)]))]))}},be=a(fe,[["__scopeId","data-v-ffb0570e"]]),he={class:"admin-friend-link-manager"},we={class:"manager-header"},ke={class:"filter-bar"},Ce={key:0,class:"loading-state"},_e={key:1,class:"error-state"},Te={key:2,class:"friend-links-grid"},xe={class:"link-header"},Ie=["src","alt"],Ue={class:"link-info"},De={class:"link-name"},Ae={class:"link-url"},Ve=["href"],Le={class:"link-content"},Pe={class:"link-description"},Se={class:"link-meta"},je={class:"category"},Ee={class:"date"},ze={class:"link-actions"},Oe=["onClick"],$e=["onClick"],Me=["onClick"],Fe=["onClick"],Be={key:3,class:"empty-state"},qe={class:"modal-header"},Ne={class:"modal-body"},Xe={class:"form-group"},Re={class:"form-group"},Ge={class:"url-input-group"},We=["disabled"],Je={class:"form-group"},Qe={class:"form-group"},He={class:"form-group"},Ke={class:"logo-input-group"},Ye={key:0,class:"logo-preview"},Ze=["src"],ea={class:"form-group"},aa={class:"form-group"},ta={class:"form-group"},la={class:"form-actions"},sa={type:"submit",class:"save-btn"},na=a({__name:"AdminFriendLinkManager",setup(e){const a=l([]),t=l([]),y=l(!1),_=l(!1),T=l(!1),x=l(""),I=l(""),U=l(""),D=l(""),A=l(!1),V=s({id:null,name:"",url:"",description:"",category:"",avatar:"",email:"",contactInfo:"",isActive:"false"}),L=n(()=>!!V.id),S=async()=>{T.value=!0,x.value="";try{const e=await P.getFriendLinks();if(!e.success)throw new Error(e.message||"获取友情链接失败");a.value=e.data.friendLinks||e.data,t.value=e.data.friendLinks||e.data}catch(e){x.value=e.message||"获取友情链接失败，请稍后重试";const l=[{id:1,name:"Vue.js 官网",url:"https://vuejs.org",description:"The Progressive JavaScript Framework",category:"技术社区",avatar:"https://vuejs.org/logo.svg",isActive:!0,email:"admin@vuejs.org",contactInfo:"",createdAt:(new Date).toISOString()},{id:2,name:"GitHub",url:"https://github.com",description:"Where the world builds software",category:"工具网站",avatar:"https://github.com/fluidicon.png",isActive:!0,email:"support@github.com",contactInfo:"",createdAt:(new Date).toISOString()},{id:3,name:"测试博客",url:"https://example.com",description:"这是一个待审核的测试博客",category:"个人博客",avatar:"",isActive:!1,email:"test@example.com",contactInfo:"QQ: 123456789",createdAt:(new Date).toISOString()}];a.value=l,t.value=l}finally{T.value=!1}},j=()=>{let e=a.value;if(I.value&&("approved"===I.value?e=e.filter(e=>!0===e.isActive):"pending"===I.value&&(e=e.filter(e=>!1===e.isActive))),U.value&&(e=e.filter(e=>e.category===U.value)),D.value){const a=D.value.toLowerCase();e=e.filter(e=>{var t;return e.name.toLowerCase().includes(a)||(null==(t=e.description)?void 0:t.toLowerCase().includes(a))||e.url.toLowerCase().includes(a)})}t.value=e},E=async()=>{var e,a;try{const e={name:V.name,url:V.url,description:V.description,category:V.category,avatar:V.avatar,email:V.email,contactInfo:V.contactInfo,isActive:"true"===V.isActive};L.value?(await P.updateFriendLink(V.id,e),alert("友情链接更新成功!")):(await P.createFriendLink(e),alert("友情链接创建成功!")),await S(),O()}catch(t){alert("保存失败: "+((null==(a=null==(e=t.response)?void 0:e.data)?void 0:a.message)||t.message))}},z=async(e,a)=>{var t,l;const s=a?"通过":"禁用";if(confirm(`确定要${s}此友情链接吗？`))try{await P.updateFriendLink(e,{isActive:a}),await S(),alert(`友情链接${s}成功!`)}catch(n){alert("状态切换失败: "+((null==(l=null==(t=n.response)?void 0:t.data)?void 0:l.message)||n.message))}},O=()=>{y.value=!1,_.value=!1,Object.assign(V,{id:null,name:"",url:"",description:"",category:"",avatar:"",email:"",contactInfo:"",isActive:"false"})},$=e=>e?"已通过":"待审核",M=async()=>{var e,a;if(V.url){A.value=!0;try{const e=await P.previewFavicon(V.url);e.success&&e.data.success?(V.avatar=e.data.faviconUrl,alert(`Favicon获取成功！\n方法: ${e.data.method}\n域名: ${e.data.domain}`)):alert("无法获取网站图标，请手动输入Logo地址")}catch(t){alert("获取网站图标失败: "+((null==(a=null==(e=t.response)?void 0:e.data)?void 0:a.message)||t.message))}finally{A.value=!1}}else alert("请先输入网站地址")},F=async()=>{V.url&&!V.avatar&&await M()},B=e=>{e.target.src="/image/default-logo.png"},q=e=>{if(!e)return"/image/default-logo.png";if(e.startsWith("http"))return e;return`${"undefined"==typeof window||"shirakawananase.top"!==window.location.hostname&&!window.location.hostname.endsWith(".shirakawananase.top")?"http://localhost:3000":"https://api.shirakawananase.top"}${e}`};return o(()=>{S()}),(e,a)=>(r(),i("div",he,[u("div",we,[a[13]||(a[13]=u("h2",null,"友情链接管理",-1)),u("button",{onClick:a[0]||(a[0]=e=>y.value=!0),class:"create-btn"}," ➕ 添加友情链接 ")]),u("div",ke,[d(u("select",{"onUpdate:modelValue":a[1]||(a[1]=e=>I.value=e),onChange:j},a[14]||(a[14]=[u("option",{value:""},"全部状态",-1),u("option",{value:"approved"},"已通过",-1),u("option",{value:"pending"},"待审核",-1),u("option",{value:"rejected"},"已拒绝",-1)]),544),[[p,I.value]]),d(u("select",{"onUpdate:modelValue":a[2]||(a[2]=e=>U.value=e),onChange:j},a[15]||(a[15]=[C('<option value="" data-v-fd051ab8>全部分类</option><option value="个人博客" data-v-fd051ab8>个人博客</option><option value="技术社区" data-v-fd051ab8>技术社区</option><option value="学习资源" data-v-fd051ab8>学习资源</option><option value="工具网站" data-v-fd051ab8>工具网站</option><option value="其他" data-v-fd051ab8>其他</option>',6)]),544),[[p,U.value]]),d(u("input",{"onUpdate:modelValue":a[3]||(a[3]=e=>D.value=e),placeholder:"搜索网站名称或描述...",onInput:j},null,544),[[v,D.value]])]),T.value?(r(),i("div",Ce,a[16]||(a[16]=[u("p",null,"正在加载友情链接...",-1)]))):x.value?(r(),i("div",_e,[a[17]||(a[17]=u("h3",null,"加载失败",-1)),u("p",null,b(x.value),1),u("button",{onClick:S,class:"retry-btn"},"重试")])):(r(),i("div",Te,[(r(!0),i(m,null,g(t.value,e=>{return r(),i("div",{key:e._id||e.id,class:"link-card"},[u("div",xe,[u("img",{src:q(e.avatar),alt:e.name,class:"link-logo"},null,8,Ie),u("div",Ue,[u("div",De,b(e.name),1),u("div",Ae,[u("a",{href:e.url,target:"_blank"},b(e.url),9,Ve)])])]),u("div",Le,[u("div",Pe,b(e.description||"暂无描述"),1),u("div",Se,[u("span",je,b(e.category),1),u("span",{class:h(["status",(t=e.isActive,t?"approved":"pending")])},b($(e.isActive)),3),u("span",Ee,b((a=e.createdAt,new Date(a).toLocaleDateString("zh-CN"))),1)])]),u("div",ze,[u("button",{onClick:a=>(e=>{Object.assign(V,{id:e._id||e.id,name:e.name,url:e.url,description:e.description||"",category:e.category,avatar:e.avatar,email:e.email,contactInfo:e.contactInfo,isActive:e.isActive?"true":"false"}),_.value=!0})(e),class:"edit-btn"},"编辑",8,Oe),e.isActive?f("",!0):(r(),i("button",{key:0,onClick:a=>z(e._id||e.id,!0),class:"approve-btn"}," 通过 ",8,$e)),e.isActive?(r(),i("button",{key:1,onClick:a=>z(e._id||e.id,!1),class:"reject-btn"}," 禁用 ",8,Me)):f("",!0),u("button",{onClick:a=>(async e=>{var a,t;if(confirm("确定要删除这个友情链接吗？"))try{await P.deleteFriendLink(e),await S(),alert("友情链接删除成功!")}catch(l){alert("删除失败: "+((null==(t=null==(a=l.response)?void 0:a.data)?void 0:t.message)||l.message))}})(e._id||e.id),class:"delete-btn"},"删除",8,Fe)])]);var a,t}),128))])),T.value||x.value||0!==t.value.length?f("",!0):(r(),i("div",Be,a[18]||(a[18]=[u("h3",null,"暂无友情链接",-1),u("p",null,"还没有任何友情链接，点击添加按钮开始创建",-1)]))),(r(),c(k,{to:"body"},[y.value||_.value?(r(),i("div",{key:0,class:"modal-overlay",onClick:O},[u("div",{class:"modal-content",onClick:a[12]||(a[12]=w(()=>{},["stop"]))},[u("div",qe,[u("h3",null,b(L.value?"编辑友情链接":"添加友情链接"),1),u("button",{onClick:O,class:"close-btn"},"✕")]),u("div",Ne,[u("form",{onSubmit:w(E,["prevent"])},[u("div",Xe,[a[19]||(a[19]=u("label",null,"网站名称",-1)),d(u("input",{"onUpdate:modelValue":a[4]||(a[4]=e=>V.name=e),type:"text",required:""},null,512),[[v,V.name]])]),u("div",Re,[a[20]||(a[20]=u("label",null,"网站地址",-1)),u("div",Ge,[d(u("input",{"onUpdate:modelValue":a[5]||(a[5]=e=>V.url=e),type:"text",required:"",placeholder:"例如：www.example.com 或 https://www.example.com",onBlur:F},null,544),[[v,V.url]]),u("button",{type:"button",onClick:M,class:"fetch-favicon-btn",disabled:A.value||!V.url},b(A.value?"获取中...":"🔄 获取图标"),9,We)])]),u("div",Je,[a[21]||(a[21]=u("label",null,"网站描述",-1)),d(u("textarea",{"onUpdate:modelValue":a[6]||(a[6]=e=>V.description=e),rows:"3"},null,512),[[v,V.description]])]),u("div",Qe,[a[23]||(a[23]=u("label",null,"分类",-1)),d(u("select",{"onUpdate:modelValue":a[7]||(a[7]=e=>V.category=e),required:""},a[22]||(a[22]=[u("option",{value:""},"选择分类",-1),u("option",{value:"个人博客"},"个人博客",-1),u("option",{value:"技术社区"},"技术社区",-1),u("option",{value:"学习资源"},"学习资源",-1),u("option",{value:"工具网站"},"工具网站",-1),u("option",{value:"其他"},"其他",-1)]),512),[[p,V.category]])]),u("div",He,[a[24]||(a[24]=u("label",null,"网站Logo",-1)),u("div",Ke,[d(u("input",{"onUpdate:modelValue":a[8]||(a[8]=e=>V.avatar=e),type:"url",placeholder:"自动获取或手动输入Logo地址"},null,512),[[v,V.avatar]]),V.avatar?(r(),i("div",Ye,[u("img",{src:V.avatar,alt:"Logo预览",onError:B},null,40,Ze)])):f("",!0)]),a[25]||(a[25]=u("small",{class:"form-hint"},"留空将自动获取网站favicon作为Logo",-1))]),u("div",ea,[a[26]||(a[26]=u("label",null,"联系邮箱",-1)),d(u("input",{"onUpdate:modelValue":a[9]||(a[9]=e=>V.email=e),type:"email"},null,512),[[v,V.email]])]),u("div",aa,[a[27]||(a[27]=u("label",null,"联系信息",-1)),d(u("input",{"onUpdate:modelValue":a[10]||(a[10]=e=>V.contactInfo=e),type:"text",placeholder:"QQ、微信等联系方式"},null,512),[[v,V.contactInfo]])]),u("div",ta,[a[29]||(a[29]=u("label",null,"状态",-1)),d(u("select",{"onUpdate:modelValue":a[11]||(a[11]=e=>V.isActive=e)},a[28]||(a[28]=[u("option",{value:"false"},"待审核",-1),u("option",{value:"true"},"已通过",-1)]),512),[[p,V.isActive]])]),u("div",la,[u("button",{type:"button",onClick:O,class:"cancel-btn"},"取消"),u("button",sa,b(L.value?"更新":"创建"),1)])],32)])])])):f("",!0)]))]))}},[["__scopeId","data-v-fd051ab8"]]),oa={class:"admin-gallery-manager"},ia={class:"manager-header"},ra={class:"header-actions"},ua={key:0,class:"batch-actions"},ca={class:"selection-count"},da={class:"filter-bar"},va={class:"filter-controls"},pa={class:"select-controls"},ma={class:"select-all-control"},ga=["checked","indeterminate"],ya={key:0,class:"loading-state"},fa={key:1,class:"error-state"},ba={key:2,class:"gallery-grid"},ha={class:"selection-checkbox"},wa=["checked","onChange"],ka={class:"image-preview"},Ca=["src","alt"],_a={class:"image-overlay"},Ta=["onClick"],xa=["onClick"],Ia={class:"image-info"},Ua={class:"image-title"},Da={class:"image-meta"},Aa={class:"category"},Va={class:"upload-date"},La={key:0,class:"image-tags"},Pa={key:3,class:"empty-state"},Sa={class:"modal-body"},ja={class:"form-group"},Ea=["value"],za={key:0,class:"mt-2"},Oa={key:0,class:"form-group"},$a={class:"tags-selection"},Ma=["id","value"],Fa=["for"],Ba={class:"tag-item"},qa={class:"form-group"},Na={class:"status-selection"},Xa={key:1,class:"selected-files"},Ra={class:"file-list"},Ga=["src","alt"],Wa={class:"file-info"},Ja={class:"file-name"},Qa={class:"file-size"},Ha=["onClick"],Ka={class:"modal-footer"},Ya=["disabled"],Za={class:"modal-body"},et={class:"form-group"},at={class:"form-group"},tt=["value"],lt={class:"form-group"},st={class:"form-group"},nt={class:"visibility-options"},ot={class:"form-group"},it={key:0,class:"modal-overlay"},rt={class:"modal-content batch-delete-modal"},ut={class:"modal-body"},ct={class:"preview-images"},dt=["src","alt"],vt={key:0,class:"more-count"},pt={class:"modal-footer"},mt=["disabled"],gt=a({__name:"AdminGalleryManager",setup(e){const a=l([]),t=l([]),x=l([]),I=l(!1),U=l(!1),D=l(!1),A=l([]),V=l(!1),L=l(!1),P=l(""),j=l(""),E=l(!1),z=l(""),O=l([]),$=l(null),M=l(!1),F=l(["摄影","游戏","编程","设计"]),B=s({category:"",tags:[],otherTagEnabled:!1,newTagText:"",isPublic:"true",otherCategoryEnabled:!1,newCategoryText:""}),q=s({id:null,title:"",category:"",secondaryTagsInput:"",secondaryTags:[],isPublic:!0,status:"draft"}),N=n(()=>t.value.length>0&&x.value.length===t.value.length),X=n(()=>x.value.length>0&&x.value.length<t.value.length),R=n(()=>Q(B.category)),G=async()=>{await Promise.all([ne(),W()]),J()},W=async()=>{try{const e=await S.getTags();e.success&&(O.value=e.data||[])}catch(e){}},J=()=>{const e=new Set(["摄影","游戏","编程","设计"]);a.value.forEach(a=>{a.category&&e.add(a.category)}),F.value=Array.from(e).sort()},Q=e=>{if(!e)return O.value;const t=a.value.filter(a=>a.category===e),l=new Set;return t.forEach(e=>{e.secondaryTags&&e.secondaryTags.length>0&&e.secondaryTags.forEach(e=>l.add(e))}),Array.from(l)},H=e=>x.value.some(a=>(a._id||a.id)===(e._id||e.id)),K=()=>{N.value?x.value=[]:x.value=[...t.value]},Y=()=>{x.value=[]},Z=()=>{B.tags=[],B.otherTagEnabled=!1,B.newTagText="","__other__"!==B.category&&(B.newCategoryText="")},ee=()=>{0!==x.value.length&&(D.value=!0)},ae=async()=>{var e,a;L.value=!0;try{const e=x.value.map(e=>S.deleteImage(e._id||e.id));await Promise.all(e),alert(`成功删除 ${x.value.length} 张图片！`),x.value=[],D.value=!1,await ne(),J()}catch(t){alert("批量删除失败: "+((null==(a=null==(e=t.response)?void 0:e.data)?void 0:a.message)||t.message))}finally{L.value=!1}},te=()=>{D.value=!1},le=async()=>{var e,a;if(0!==A.value.length)if(B.category)if("__other__"!==B.category||B.newCategoryText.trim()){V.value=!0;try{const e="__other__"===B.category?B.newCategoryText.trim():B.category;for(let a=0;a<A.value.length;a++){const t=A.value[a],l=new FormData;l.append("image",t.file),l.append("title",t.name.split(".")[0]),l.append("category",e),l.append("isPublic",B.isPublic),l.append("status","published");let s=[...B.tags];if(B.otherTagEnabled&&B.newTagText){const e=B.newTagText.split(",").map(e=>e.trim()).filter(Boolean);s=[...s,...e]}l.append("secondaryTags",JSON.stringify(s)),await S.uploadImage(l)}alert("图片上传成功!"),await G(),me()}catch(t){alert("上传失败: "+((null==(a=null==(e=t.response)?void 0:e.data)?void 0:a.message)||t.message))}finally{V.value=!1}}else alert("请输入新分类名称");else alert("请选择分类")},se=()=>{let e=a.value;if(P.value&&(e=e.filter(e=>e.category===P.value)),j.value){const a=j.value.toLowerCase();e=e.filter(e=>{var t;return e.title.toLowerCase().includes(a)||(null==(t=e.description)?void 0:t.toLowerCase().includes(a))})}t.value=e,x.value=x.value.filter(a=>e.some(e=>(e._id||e.id)===(a._id||a.id)))},ne=async()=>{E.value=!0,z.value="";try{const e=await S.getAllImages();if(!e.success)throw new Error(e.message||"获取图片列表失败");a.value=e.data||[],t.value=e.data||[]}catch(e){z.value=e.message||"获取图片列表失败，请稍后重试",a.value=[],t.value=[]}finally{E.value=!1}},oe=e=>{const a=Array.from(e.target.files);ve(a)},ie=()=>{$.value.click()},re=e=>{e.preventDefault(),M.value=!1;const a=Array.from(e.dataTransfer.files);ve(a)},ue=e=>{e.preventDefault(),M.value=!0},ce=e=>{e.preventDefault(),e.currentTarget.contains(e.relatedTarget)||(M.value=!1)},de=e=>{e.preventDefault()},ve=e=>{e.forEach(e=>{if(e.type.startsWith("image/")){const a=new FileReader;a.onload=a=>{A.value.push({file:e,name:e.name,size:e.size,preview:a.target.result})},a.readAsDataURL(e)}})},pe=async()=>{var e,a;try{const e={title:q.title,category:q.category,secondaryTags:q.secondaryTagsInput.split(",").map(e=>e.trim()).filter(Boolean),isPublic:q.isPublic,status:q.status};await S.updateImage(q.id,e),alert("图片信息更新成功!"),ge(),await ne()}catch(t){alert("保存失败: "+((null==(a=null==(e=t.response)?void 0:e.data)?void 0:a.message)||t.message))}},me=()=>{I.value=!1,A.value=[],M.value=!1,Object.assign(B,{category:"",tags:[],otherTagEnabled:!1,newTagText:"",isPublic:"true",otherCategoryEnabled:!1,newCategoryText:""})},ge=()=>{U.value=!1,Object.assign(q,{id:null,title:"",category:"",secondaryTagsInput:"",secondaryTags:[],isPublic:!0,status:"draft"})},ye=e=>{if(0===e)return"0 Bytes";const a=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,a)).toFixed(2))+" "+["Bytes","KB","MB","GB"][a]},fe=e=>{if(!e)return"/placeholder.jpg";if(e.startsWith("http"))return e;const a="undefined"==typeof window||"shirakawananase.top"!==window.location.hostname&&!window.location.hostname.endsWith(".shirakawananase.top")?"http://localhost:3000":"https://api.shirakawananase.top";return e.startsWith("/")?`${a}${e}`:`${a}/${e}`};return o(()=>{G()}),(e,a)=>(r(),i("div",oa,[u("div",ia,[a[18]||(a[18]=u("h2",null,"图库管理",-1)),u("div",ra,[x.value.length>0?(r(),i("div",ua,[u("span",ca,"已选择 "+b(x.value.length)+" 张图片",1),u("button",{onClick:ee,class:"batch-delete-btn"}," 🗑️ 批量删除 ("+b(x.value.length)+") ",1),u("button",{onClick:Y,class:"clear-selection-btn"}," ✕ 取消选择 ")])):f("",!0),u("button",{onClick:a[0]||(a[0]=e=>I.value=!0),class:"upload-btn"}," 📷 上传图片 ")])]),u("div",da,[u("div",va,[d(u("select",{"onUpdate:modelValue":a[1]||(a[1]=e=>P.value=e),onChange:se},a[19]||(a[19]=[C('<option value="" data-v-1565dc1b>全部分类</option><option value="摄影" data-v-1565dc1b>摄影</option><option value="游戏" data-v-1565dc1b>游戏</option><option value="编程" data-v-1565dc1b>编程</option><option value="设计" data-v-1565dc1b>设计</option>',5)]),544),[[p,P.value]]),d(u("input",{"onUpdate:modelValue":a[2]||(a[2]=e=>j.value=e),placeholder:"搜索图片标题...",onInput:se},null,544),[[v,j.value]])]),u("div",pa,[u("label",ma,[u("input",{type:"checkbox",checked:N.value,indeterminate:X.value,onChange:K},null,40,ga),u("span",null,"全选 ("+b(t.value.length)+")",1)])])]),E.value?(r(),i("div",ya,a[20]||(a[20]=[u("div",{class:"loading-spinner"},null,-1),u("p",null,"正在加载图片...",-1)]))):z.value?(r(),i("div",fa,[a[21]||(a[21]=u("div",{class:"error-icon"},"😞",-1)),a[22]||(a[22]=u("h3",null,"加载失败",-1)),u("p",null,b(z.value),1),u("button",{onClick:ne,class:"retry-btn"},"重试")])):(r(),i("div",ba,[(r(!0),i(m,null,g(t.value,e=>{return r(),i("div",{key:e._id||e.id,class:h(["image-card",{selected:H(e)}])},[u("div",ha,[u("input",{type:"checkbox",checked:H(e),onChange:a=>(e=>{const a=e._id||e.id,t=x.value.findIndex(e=>(e._id||e.id)===a);-1===t?x.value.push(e):x.value.splice(t,1)})(e)},null,40,wa)]),u("div",ka,[u("img",{src:fe(e.thumbnail||e.url),alt:e.title},null,8,Ca),u("div",_a,[u("button",{onClick:a=>(e=>{Object.assign(q,{id:e._id||e.id,title:e.title,category:e.category,secondaryTagsInput:(e.secondaryTags||[]).join(", "),secondaryTags:e.secondaryTags||[],isPublic:e.isPublic,status:e.status}),U.value=!0})(e),class:"edit-btn"},"编辑",8,Ta),u("button",{onClick:a=>(async e=>{var a,t;if(confirm("确定要删除这张图片吗？"))try{await S.deleteImage(e),alert("图片删除成功!"),await ne(),J()}catch(l){alert("删除失败: "+((null==(t=null==(a=l.response)?void 0:a.data)?void 0:t.message)||l.message))}})(e._id||e.id),class:"delete-btn"},"删除",8,xa)])]),u("div",Ia,[u("div",Ua,b(e.title),1),u("div",Da,[u("span",Aa,b(e.category),1),u("span",Va,b((a=e.date||e.createdAt,new Date(a).toLocaleDateString("zh-CN"))),1),u("span",{class:h(["status",e.isPublic?"public":"private"])},b(e.isPublic?"公开":"私有"),3),u("span",{class:h(["publish-status",e.status])},b("published"===e.status?"已发布":"未发布"),3)]),e.secondaryTags&&e.secondaryTags.length?(r(),i("div",La,[(r(!0),i(m,null,g(e.secondaryTags,e=>(r(),i("span",{key:e,class:"tag"},b(e),1))),128))])):f("",!0)])],2);var a}),128))])),E.value||z.value||0!==t.value.length?f("",!0):(r(),i("div",Pa,a[23]||(a[23]=[u("div",{class:"empty-icon"},"🖼️",-1),u("h3",null,"暂无图片",-1),u("p",null,"还没有上传任何图片，点击上传按钮开始添加图片",-1)]))),(r(),c(k,{to:"body"},[I.value?(r(),i("div",{key:0,class:"modal-overlay",onClick:me},[u("div",{class:"modal-content",onClick:a[10]||(a[10]=w(()=>{},["stop"]))},[u("div",{class:"modal-header"},[a[24]||(a[24]=u("h3",null,"上传图片",-1)),u("button",{onClick:me,class:"close-btn"},"✕")]),u("div",Sa,[u("div",ja,[a[27]||(a[27]=u("label",null,"分类 (一级标签)",-1)),d(u("select",{"onUpdate:modelValue":a[3]||(a[3]=e=>B.category=e),onChange:Z,required:""},[a[25]||(a[25]=u("option",{value:""},"选择分类",-1)),(r(!0),i(m,null,g(F.value,e=>(r(),i("option",{key:e,value:e},b(e),9,Ea))),128)),a[26]||(a[26]=u("option",{value:"__other__"},"其他",-1))],544),[[p,B.category]]),"__other__"===B.category?(r(),i("div",za,[d(u("input",{"onUpdate:modelValue":a[4]||(a[4]=e=>B.newCategoryText=e),type:"text",placeholder:"输入新分类名称",required:"",class:"form-control"},null,512),[[v,B.newCategoryText]])])):f("",!0)]),B.category?(r(),i("div",Oa,[a[29]||(a[29]=u("label",null,"二级标签 (可多选)",-1)),u("div",$a,[(r(!0),i(m,null,g(R.value,e=>(r(),i("div",{key:e,class:"tag-item"},[d(u("input",{type:"checkbox",id:`upload-tag-${e}`,value:e,"onUpdate:modelValue":a[5]||(a[5]=e=>B.tags=e)},null,8,Ma),[[_,B.tags]]),u("label",{for:`upload-tag-${e}`},b(e),9,Fa)]))),128)),u("div",Ba,[d(u("input",{type:"checkbox",id:"upload-other-tag","onUpdate:modelValue":a[6]||(a[6]=e=>B.otherTagEnabled=e)},null,512),[[_,B.otherTagEnabled]]),a[28]||(a[28]=u("label",{for:"upload-other-tag"},"其他",-1)),B.otherTagEnabled?d((r(),i("input",{key:0,"onUpdate:modelValue":a[7]||(a[7]=e=>B.newTagText=e),placeholder:"新标签,逗号分隔"},null,512)),[[v,B.newTagText]]):f("",!0)])]),a[30]||(a[30]=u("p",{class:"helper-text"},"请先选择分类，然后选择相应的二级标签",-1))])):f("",!0),u("div",qa,[a[33]||(a[33]=u("label",null,"状态",-1)),u("div",Na,[d(u("input",{type:"radio",id:"upload-public",value:"true","onUpdate:modelValue":a[8]||(a[8]=e=>B.isPublic=e)},null,512),[[T,B.isPublic]]),a[31]||(a[31]=u("label",{for:"upload-public"},"公开",-1)),d(u("input",{type:"radio",id:"upload-private",value:"false","onUpdate:modelValue":a[9]||(a[9]=e=>B.isPublic=e)},null,512),[[T,B.isPublic]]),a[32]||(a[32]=u("label",{for:"upload-private"},"私有",-1))])]),u("div",{class:h(["upload-area",{"drag-over":M.value}]),onClick:ie,onDrop:re,onDragover:de,onDragenter:ue,onDragleave:ce},[u("input",{ref_key:"fileInput",ref:$,type:"file",multiple:"",accept:"image/*",onChange:oe,class:"file-input"},null,544),a[34]||(a[34]=u("div",{class:"upload-text"},[u("p",null,"拖拽图片到此处或点击选择文件"),u("p",{class:"upload-hint"},"支持多文件选择，格式：JPG、PNG、GIF等")],-1))],34),A.value.length>0?(r(),i("div",Xa,[u("h4",null,"待上传文件 ("+b(A.value.length)+")",1),u("div",Ra,[(r(!0),i(m,null,g(A.value,(e,a)=>(r(),i("div",{key:a,class:"file-item"},[u("img",{src:e.preview,alt:e.name,class:"file-preview"},null,8,Ga),u("div",Wa,[u("div",Ja,b(e.name),1),u("div",Qa,b(ye(e.size)),1)]),u("button",{onClick:e=>(e=>{A.value.splice(e,1)})(a),class:"remove-file"},"✕",8,Ha)]))),128))])])):f("",!0)]),u("div",Ka,[u("button",{onClick:me,class:"cancel-btn"},"取消"),u("button",{onClick:le,disabled:0===A.value.length||V.value,class:"upload-confirm-btn"},b(V.value?"上传中...":`上传 ${A.value.length} 张图片`),9,Ya)])])])):f("",!0)])),(r(),c(k,{to:"body"},[U.value?(r(),i("div",{key:0,class:"modal-overlay",onClick:ge},[u("div",{class:"modal-content",onClick:a[17]||(a[17]=w(()=>{},["stop"]))},[u("div",{class:"modal-header"},[a[35]||(a[35]=u("h3",null,"编辑图片",-1)),u("button",{onClick:ge,class:"close-btn"},"✕")]),u("div",Za,[u("form",{onSubmit:w(pe,["prevent"])},[u("div",et,[a[36]||(a[36]=u("label",null,"标题",-1)),d(u("input",{"onUpdate:modelValue":a[11]||(a[11]=e=>q.title=e),type:"text",required:""},null,512),[[v,q.title]])]),u("div",at,[a[38]||(a[38]=u("label",null,"分类",-1)),d(u("select",{"onUpdate:modelValue":a[12]||(a[12]=e=>q.category=e),required:""},[a[37]||(a[37]=u("option",{value:""},"选择分类",-1)),(r(!0),i(m,null,g(F.value,e=>(r(),i("option",{key:e,value:e},b(e),9,tt))),128))],512),[[p,q.category]])]),u("div",lt,[a[39]||(a[39]=u("label",null,"二级标签",-1)),d(u("input",{"onUpdate:modelValue":a[13]||(a[13]=e=>q.secondaryTagsInput=e),type:"text",placeholder:"用逗号分隔多个标签，如：夜景,城市,建筑"},null,512),[[v,q.secondaryTagsInput]])]),u("div",st,[a[42]||(a[42]=u("label",null,"可见性",-1)),u("div",nt,[u("label",null,[d(u("input",{type:"radio",value:!0,"onUpdate:modelValue":a[14]||(a[14]=e=>q.isPublic=e)},null,512),[[T,q.isPublic]]),a[40]||(a[40]=y(" 公开 "))]),u("label",null,[d(u("input",{type:"radio",value:!1,"onUpdate:modelValue":a[15]||(a[15]=e=>q.isPublic=e)},null,512),[[T,q.isPublic]]),a[41]||(a[41]=y(" 私有 "))])])]),u("div",ot,[a[44]||(a[44]=u("label",null,"发布状态",-1)),d(u("select",{"onUpdate:modelValue":a[16]||(a[16]=e=>q.status=e)},a[43]||(a[43]=[u("option",{value:"draft"},"未发布",-1),u("option",{value:"published"},"已发布",-1)]),512),[[p,q.status]])]),u("div",{class:"form-actions"},[u("button",{type:"button",onClick:ge,class:"cancel-btn"},"取消"),a[45]||(a[45]=u("button",{type:"submit",class:"save-btn"},"保存",-1))])],32)])])])):f("",!0)])),(r(),c(k,{to:"body"},[D.value?(r(),i("div",it,[u("div",rt,[a[49]||(a[49]=u("div",{class:"modal-header"},[u("h3",null,"⚠️ 确认批量删除")],-1)),u("div",ut,[u("p",null,[a[46]||(a[46]=y("您即将删除 ")),u("strong",null,b(x.value.length),1),a[47]||(a[47]=y(" 张图片"))]),a[48]||(a[48]=u("p",{class:"warning-text"},"此操作不可撤销，确定要继续吗？",-1)),u("div",ct,[(r(!0),i(m,null,g(x.value.slice(0,6),e=>(r(),i("img",{key:e._id||e.id,src:fe(e.thumbnail),alt:e.title,class:"preview-thumb"},null,8,dt))),128)),x.value.length>6?(r(),i("div",vt," +"+b(x.value.length-6),1)):f("",!0)])]),u("div",pt,[u("button",{onClick:te,class:"cancel-btn"},"取消"),u("button",{onClick:ae,disabled:L.value,class:"danger-btn"},b(L.value?"删除中...":"确认删除"),9,mt)])])])):f("",!0)]))]))}},[["__scopeId","data-v-1565dc1b"]]),yt={class:"admin-document-manager"},ft={class:"manager-header"},bt={class:"filter-bar"},ht=["value"],wt={key:0,class:"loading-state"},kt={key:1,class:"error-state"},Ct={key:2,class:"document-list"},_t={class:"doc-icon"},Tt={class:"document-info"},xt={class:"document-meta"},It={class:"doc-category"},Ut={class:"doc-type"},Dt={class:"doc-size"},At={class:"doc-date"},Vt={key:0,class:"doc-tags"},Lt={class:"document-actions"},Pt=["onClick"],St=["onClick"],jt=["onClick"],Et={key:3,class:"empty-state"},zt={class:"modal-header"},Ot={class:"modal-body"},$t={key:0,class:"form-group"},Mt={key:0,class:"upload-placeholder"},Ft={key:1,class:"selected-file"},Bt={class:"file-details"},qt={class:"file-name"},Nt={class:"file-size"},Xt={class:"form-group"},Rt={class:"form-group"},Gt={class:"form-group"},Wt=["value"],Jt={key:0,class:"mt-2"},Qt={class:"form-group"},Ht={key:1,class:"form-group"},Kt={class:"current-file-info"},Yt={class:"file-size"},Zt={class:"form-group"},el={key:2,class:"upload-progress"},al={class:"progress-bar"},tl={class:"progress-text"},ll={class:"form-actions"},sl=["disabled"],nl=["disabled"],ol={key:0},il={key:1},rl=a({__name:"AdminDocumentManager",setup(e){const a=l([]),t=l([]),n=l(!1),_=l(!1),T=l(null),I=l(""),U=l(""),D=l(""),V=l(!1),L=l(""),P=l(!1),S=l(0),E=s({id:null,title:"",description:"",category:"",newCategoryText:"",secondaryTagsInput:"",secondaryTags:[],type:"",size:"",downloadUrl:"",previewUrl:"",status:"draft"}),z=l(["前端开发","游戏攻略","AI技术","音乐制作","模板资源"]),O=()=>{"__other__"!==E.category&&(E.newCategoryText="")},$=()=>{let e=a.value;if(I.value&&(e=e.filter(e=>e.category===I.value)),U.value&&(e=e.filter(e=>e.type===U.value)),D.value){const a=D.value.toLowerCase();e=e.filter(e=>{var t,l;return e.title.toLowerCase().includes(a)||(null==(t=e.description)?void 0:t.toLowerCase().includes(a))||(null==(l=e.secondaryTags)?void 0:l.some(e=>e.toLowerCase().includes(a)))})}t.value=e},M=e=>e.split(".").pop().toUpperCase(),F=e=>{if(0===e)return"0 Bytes";const a=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,a)).toFixed(2))+" "+["Bytes","KB","MB","GB"][a]},B=e=>{const a=e.target.files[0];a&&N(a)},q=e=>{const a=e.dataTransfer.files;a.length>0&&N(a[0])},N=e=>{if(e.size>52428800)return void alert("文件大小超过50MB限制，请选择较小的文件");const a=e.name.toLowerCase();[".pdf",".doc",".docx",".ppt",".pptx",".xls",".xlsx",".txt",".md"].some(e=>a.endsWith(e))?(T.value=e,E.type=M(e.name),E.size=F(e.size),E.title||(E.title=e.name.split(".")[0])):alert("不支持的文件类型，请选择 PDF、Word、PowerPoint、Excel、TXT 或 Markdown 文件")},X=()=>{var e;T.value=null,E.type="",E.size="",(null==(e=document.refs)?void 0:e.fileInput)&&(document.refs.fileInput.value="")},R=async()=>{V.value=!0,L.value="";try{0;const e=await A.getAllDocuments();if(!e.success)throw new Error(e.message||"获取文档列表失败");{const l=e.data.documents||e.data||[];0,a.value=l,t.value=l,(()=>{const e=new Set(["前端开发","游戏攻略","AI技术","音乐制作","模板资源"]);a.value.forEach(a=>{a.category&&e.add(a.category)}),z.value=Array.from(e).sort()})()}}catch(e){}finally{V.value=!1}},G=async()=>{try{P.value=!0,S.value=0;const e="__other__"===E.category?E.newCategoryText.trim():E.category,a={title:E.title,description:E.description,category:e,secondaryTags:E.secondaryTagsInput.split(",").map(e=>e.trim()).filter(Boolean),type:E.type,size:E.size,status:E.status};if(!a.title)return void alert("请填写文档标题");if(!a.category)return void alert("请选择文档分类");if("__other__"===E.category&&!E.newCategoryText.trim())return void alert("请输入新分类名称");if(n.value&&!T.value)return void alert("请选择要上传的文档文件");let t;if(n.value)if(T.value){const e=setInterval(()=>{S.value<90&&(S.value+=20*Math.random())},200),l=new FormData;l.append("document",T.value),l.append("title",a.title),l.append("description",a.description),l.append("category",a.category),l.append("type",a.type),l.append("status",a.status),a.secondaryTags.length>0&&l.append("secondaryTags",JSON.stringify(a.secondaryTags));for(let[a,t]of l.entries());try{t=await A.uploadDocumentFile(l),S.value=100}finally{clearInterval(e)}}else t=await A.createDocument(a);else S.value=50,t=await A.updateDocument(E.id,a),S.value=100;if(!t.success)throw new Error(t.message||"保存失败");await R(),W(),alert(n.value?"文档上传成功!":"文档更新成功!")}catch(e){let a="保存失败";if(e.response){const t=e.response.data;switch(t.message&&(a+=": "+t.message),e.response.status){case 400:a="数据验证失败 - 请检查所有必填字段是否正确填写",t.errors&&(a+="\n详细错误: "+JSON.stringify(t.errors));break;case 401:a="认证失败 - 请重新登录";break;case 403:a="权限不足 - 您没有权限执行此操作";break;case 500:a="服务器内部错误 - 请稍后重试"}}else a=e.request?"网络连接失败 - 请检查网络连接":e.message;alert(a)}finally{P.value=!1,S.value=0}},W=()=>{n.value=!1,_.value=!1,T.value=null,document.querySelector('input[type="file"]')&&(document.querySelector('input[type="file"]').value=""),Object.assign(E,{id:null,title:"",description:"",category:"",newCategoryText:"",secondaryTagsInput:"",secondaryTags:[],type:"",size:"",status:"draft"})},J=e=>({PDF:"fas fa-file-pdf",DOCX:"fas fa-file-word",PPT:"fas fa-file-powerpoint",XLSX:"fas fa-file-excel",TXT:"fas fa-file-alt"}[e]||"fas fa-file"),Q=e=>{if(!e)return"未知日期";const a=new Date(e);return isNaN(a.getTime())?"未知日期":a.toLocaleDateString("zh-CN")};return o(()=>{R()}),(e,a)=>{var l;return r(),i("div",yt,[u("div",ft,[a[13]||(a[13]=u("h2",null,"文档管理",-1)),u("button",{onClick:a[0]||(a[0]=e=>n.value=!0),class:"create-btn"}," 📄 上传文档 ")]),u("div",bt,[d(u("select",{"onUpdate:modelValue":a[1]||(a[1]=e=>I.value=e),onChange:$},[a[14]||(a[14]=u("option",{value:""},"全部分类",-1)),(r(!0),i(m,null,g(z.value,e=>(r(),i("option",{key:e,value:e},b(e),9,ht))),128))],544),[[p,I.value]]),d(u("select",{"onUpdate:modelValue":a[2]||(a[2]=e=>U.value=e),onChange:$},a[15]||(a[15]=[C('<option value="" data-v-fe8f1588>全部类型</option><option value="PDF" data-v-fe8f1588>PDF</option><option value="DOCX" data-v-fe8f1588>DOCX</option><option value="PPT" data-v-fe8f1588>PPT</option><option value="XLSX" data-v-fe8f1588>XLSX</option><option value="TXT" data-v-fe8f1588>TXT</option><option value="MD" data-v-fe8f1588>MD</option>',7)]),544),[[p,U.value]]),d(u("input",{"onUpdate:modelValue":a[3]||(a[3]=e=>D.value=e),placeholder:"搜索文档标题或描述...",onInput:$},null,544),[[v,D.value]])]),V.value?(r(),i("div",wt,a[16]||(a[16]=[u("p",null,"正在加载文档...",-1)]))):L.value?(r(),i("div",kt,[a[17]||(a[17]=u("h3",null,"加载失败",-1)),u("p",null,b(L.value),1),u("button",{onClick:R,class:"retry-btn"},"重试")])):(r(),i("div",Ct,[(r(!0),i(m,null,g(t.value,e=>{return r(),i("div",{key:e._id||e.id,class:"document-card"},[u("div",_t,[u("i",{class:h(J(e.type))},null,2)]),u("div",Tt,[u("h3",null,b(e.title),1),u("p",null,b(e.description),1),u("div",xt,[u("span",It,b(e.category),1),u("span",Ut,b(e.type),1),u("span",Dt,b(e.size||e.formattedSize),1),u("span",At,b(Q(e.date||e.createdAt)),1),u("span",{class:h(["status",e.status])},b((a=e.status,{draft:"私人",published:"公开",pinned:"置顶"}[a]||"未知")),3)]),e.secondaryTags&&e.secondaryTags.length?(r(),i("div",Vt,[(r(!0),i(m,null,g(e.secondaryTags,e=>(r(),i("span",{key:e,class:"tag"},b(e),1))),128))])):f("",!0)]),u("div",Lt,[u("button",{onClick:a=>(e=>{var a;Object.assign(E,{id:e.id,title:e.title,description:e.description,category:e.category,newCategoryText:"",secondaryTagsInput:(null==(a=e.secondaryTags)?void 0:a.join(","))||"",secondaryTags:e.secondaryTags||[],type:e.type,size:e.size,downloadUrl:e.downloadUrl,previewUrl:e.previewUrl,status:e.status}),_.value=!0})(e),class:"edit-btn"},"编辑",8,Pt),u("button",{onClick:a=>(async e=>{var a,t;if(confirm("确定要删除这个文档吗？"))try{(await A.deleteDocument(e)).success&&(await R(),alert("文档删除成功!"))}catch(l){alert("删除失败: "+((null==(t=null==(a=l.response)?void 0:a.data)?void 0:t.message)||l.message))}})(e._id||e.id),class:"delete-btn"},"删除",8,St),u("button",{onClick:a=>(async e=>{var a,t,l;try{const t=await j.downloadDocument(e._id||e.id),l=window.URL.createObjectURL(t),s=document.createElement("a");s.href=l,s.download=`${e.title}.${(null==(a=e.type)?void 0:a.toLowerCase())||"file"}`,s.style.display="none",document.body.appendChild(s),s.click(),document.body.removeChild(s),window.URL.revokeObjectURL(l)}catch(s){alert("下载失败："+((null==(l=null==(t=s.response)?void 0:t.data)?void 0:l.message)||s.message||"请稍后重试"))}})(e),class:"download-btn"},"下载",8,jt)])]);var a}),128))])),V.value||L.value||0!==t.value.length?f("",!0):(r(),i("div",Et,a[18]||(a[18]=[u("h3",null,"暂无文档",-1),u("p",null,"还没有上传任何文档，点击创建按钮开始添加文档",-1)]))),(r(),c(k,{to:"body"},[n.value||_.value?(r(),i("div",{key:0,class:"modal-overlay",onClick:W},[u("div",{class:"modal-content",onClick:a[12]||(a[12]=w(()=>{},["stop"]))},[u("div",zt,[u("h3",null,b(n.value?"上传文档":"编辑文档"),1),u("button",{onClick:W,class:"close-btn"},"✕")]),u("div",Ot,[u("form",{onSubmit:w(G,["prevent"])},[n.value?(r(),i("div",$t,[a[20]||(a[20]=u("label",null,"📁 选择文档文件",-1)),u("div",{class:"file-upload-area",onClick:a[4]||(a[4]=a=>{var t;return null==(t=e.$refs.fileInput)?void 0:t.click()}),onDragover:a[5]||(a[5]=w(()=>{},["prevent"])),onDrop:w(q,["prevent"])},[u("input",{ref:"fileInput",type:"file",onChange:B,accept:".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.txt,.md",style:{display:"none"}},null,544),T.value?(r(),i("div",Ft,[u("i",{class:h([J(M(T.value.name)),"file-icon"])},null,2),u("div",Bt,[u("span",qt,b(T.value.name),1),u("span",Nt,b(F(T.value.size)),1)]),u("button",{type:"button",onClick:w(X,["stop"]),class:"remove-file-btn"},"✕")])):(r(),i("div",Mt,a[19]||(a[19]=[u("i",{class:"fas fa-cloud-upload-alt upload-icon"},null,-1),u("p",null,"点击选择文件或拖拽文件到此处",-1),u("p",{class:"upload-hint"},"支持 PDF、Word、PowerPoint、Excel、TXT、Markdown 文件",-1),u("p",{class:"size-limit"},"文件大小限制：50MB",-1)])))],32)])):f("",!0),u("div",Xt,[a[21]||(a[21]=u("label",null,"标题",-1)),d(u("input",{"onUpdate:modelValue":a[6]||(a[6]=e=>E.title=e),type:"text",required:""},null,512),[[v,E.title]])]),u("div",Rt,[a[22]||(a[22]=u("label",null,"描述",-1)),d(u("textarea",{"onUpdate:modelValue":a[7]||(a[7]=e=>E.description=e),rows:"3"},null,512),[[v,E.description]])]),u("div",Gt,[a[25]||(a[25]=u("label",null,"分类",-1)),d(u("select",{"onUpdate:modelValue":a[8]||(a[8]=e=>E.category=e),onChange:O,required:""},[a[23]||(a[23]=u("option",{value:""},"选择分类",-1)),(r(!0),i(m,null,g(z.value,e=>(r(),i("option",{key:e,value:e},b(e),9,Wt))),128)),a[24]||(a[24]=u("option",{value:"__other__"},"其他",-1))],544),[[p,E.category]]),"__other__"===E.category?(r(),i("div",Jt,[d(u("input",{"onUpdate:modelValue":a[9]||(a[9]=e=>E.newCategoryText=e),type:"text",placeholder:"输入新分类名称",required:"",class:"form-control"},null,512),[[v,E.newCategoryText]])])):f("",!0)]),u("div",Qt,[a[26]||(a[26]=u("label",null,"二级标签",-1)),d(u("input",{"onUpdate:modelValue":a[10]||(a[10]=e=>E.secondaryTagsInput=e),type:"text",placeholder:"用逗号分隔多个标签，如：Vue3,JavaScript,Composition API"},null,512),[[v,E.secondaryTagsInput]])]),_.value?(r(),i("div",Ht,[a[27]||(a[27]=u("label",null,"当前文件",-1)),u("div",Kt,[u("i",{class:h(J(E.type))},null,2),u("span",null,b(E.title)+"."+b(null==(l=E.type)?void 0:l.toLowerCase()),1),u("span",Yt,"("+b(E.size)+")",1)]),a[28]||(a[28]=u("p",{class:"file-note"},"💡 提示：要更换文件请重新上传",-1))])):f("",!0),u("div",Zt,[a[30]||(a[30]=u("label",null,"状态",-1)),d(u("select",{"onUpdate:modelValue":a[11]||(a[11]=e=>E.status=e)},a[29]||(a[29]=[u("option",{value:"draft"},"私人",-1),u("option",{value:"published"},"公开",-1),u("option",{value:"pinned"},"置顶",-1)]),512),[[p,E.status]])]),P.value?(r(),i("div",el,[u("div",al,[u("div",{class:"progress-fill",style:x({width:S.value+"%"})},null,4)]),u("p",tl,b(n.value?"正在上传文档...":"正在保存...")+" "+b(S.value)+"%",1)])):f("",!0),u("div",ll,[u("button",{type:"button",onClick:W,disabled:P.value,class:"cancel-btn"},"取消",8,sl),u("button",{type:"submit",disabled:P.value,class:"save-btn"},[P.value?(r(),i("span",ol,[a[31]||(a[31]=u("i",{class:"fas fa-spinner fa-spin"},null,-1)),y(" "+b(n.value?"上传中...":"保存中..."),1)])):(r(),i("span",il,b(n.value?"📁 上传文档":"💾 保存"),1))],8,nl)])],32)])])])):f("",!0)]))])}}},[["__scopeId","data-v-fe8f1588"]]),ul={class:"admin-comment-manager"},cl={class:"manager-header"},dl={class:"stats"},vl={class:"total-count"},pl={class:"filter-bar"},ml={key:0,class:"loading-state"},gl={key:1,class:"error-state"},yl={key:2,class:"comment-list"},fl={class:"comment-info"},bl={class:"comment-header"},hl={class:"user-info"},wl={class:"commenter"},kl={class:"comment-source"},Cl=["onClick","title"],_l={class:"comment-meta"},Tl={class:"comment-time"},xl={key:0,class:"reply-indicator"},Il={class:"comment-content"},Ul={key:0,class:"parent-comment"},Dl={class:"parent-content"},Al={class:"comment-actions"},Vl={class:"like-count"},Ll=["onClick"],Pl=["onClick"],Sl=["onClick"],jl={key:3,class:"empty-state"},El=a({__name:"AdminCommentReview",setup(e){const a=I(),t=l([]),s=l(""),c=l(""),y=l(""),w=l(!1),k=l(""),C=n(()=>t.value.length),_=async()=>{w.value=!0,k.value="";try{const e={};s.value&&(e.status=s.value),c.value&&(e.targetType=c.value),y.value&&(e.search=y.value);const a=await A.getAllComments(e);if(!a.success)throw new Error(a.message||"获取评论列表失败");t.value=a.data.comments||a.data||[]}catch(e){k.value=e.message||"获取评论列表失败，请稍后重试",t.value=[]}finally{w.value=!1}},T=e=>{if("blog"===e.targetType||"Blog"===e.targetType)if(e.targetId){const t="object"==typeof e.targetId?e.targetId.id||e.targetId._id:e.targetId;a.push(`/blog/${t}`)}else alert("博客ID缺失，无法跳转");else"comment"===e.targetType?a.push("/comments"):"document"===e.targetType||"Document"===e.targetType?e.targetTitle?a.push({path:"/documents",query:{search:e.targetTitle}}):a.push("/documents"):"General"===e.targetType?a.push("/comments"):"gallery"===e.targetType||"Gallery"===e.targetType?a.push("/gallery"):alert("无法确定跳转目标，可能是数据不完整")},x=e=>{const a={blog:"博客",Blog:"博客",comment:"评论区",General:"留言板"}[e.targetType]||"其他";const t=e.targetTitle||"";return"blog"===e.targetType||"Blog"===e.targetType?t?`博客：${t}`:"博客":"General"===e.targetType?"留言板":t?`${a}：${t}`:a},U=e=>{if(!e)return"未知时间";const a=new Date(e);return isNaN(a.getTime())?"未知时间":a.toLocaleString("zh-CN")};return o(()=>{_()}),(e,a)=>(r(),i("div",ul,[u("div",cl,[a[2]||(a[2]=u("h2",null,"评论管理",-1)),u("div",dl,[u("span",vl,"总评论: "+b(C.value),1)])]),u("div",pl,[d(u("select",{"onUpdate:modelValue":a[0]||(a[0]=e=>c.value=e),onChange:_},a[3]||(a[3]=[u("option",{value:""},"全部来源",-1),u("option",{value:"blog"},"博客",-1),u("option",{value:"comment"},"评论区",-1),u("option",{value:"General"},"留言板",-1)]),544),[[p,c.value]]),d(u("input",{"onUpdate:modelValue":a[1]||(a[1]=e=>y.value=e),placeholder:"搜索评论内容或用户...",onInput:_},null,544),[[v,y.value]])]),w.value?(r(),i("div",ml,a[4]||(a[4]=[u("p",null,"正在加载评论...",-1)]))):k.value?(r(),i("div",gl,[a[5]||(a[5]=u("h3",null,"加载失败",-1)),u("p",null,b(k.value),1),u("button",{onClick:_,class:"retry-btn"},"重试")])):(r(),i("div",yl,[(r(!0),i(m,null,g(t.value,e=>{var t;return r(),i("div",{key:e.id||e._id,class:"comment-card"},[u("div",fl,[u("div",bl,[u("div",hl,[u("span",wl,b((null==(t=e.author)?void 0:t.username)||e.author||"匿名用户"),1)]),u("div",kl,[a[6]||(a[6]=u("span",{class:"source-label"},"来源:",-1)),u("button",{onClick:a=>T(e),class:"source-link",title:`点击跳转到${x(e)}`},b(x(e)),9,Cl)])]),u("div",_l,[u("span",Tl,b(U(e.createdAt)),1),e.parentComment?(r(),i("span",xl,"回复评论")):f("",!0)]),u("div",Il,b(e.content),1),e.parentComment?(r(),i("div",Ul,[a[7]||(a[7]=u("span",{class:"parent-label"},"回复:",-1)),u("span",Dl,b(e.parentComment.content),1)])):f("",!0)]),u("div",Al,[u("span",Vl,b(e.likeCount||0)+" ❤️",1),u("button",{onClick:a=>(async e=>{var a,t;try{const a=!e.isPublic;(await A.updateCommentVisibility(e.id||e._id,a)).success&&(e.isPublic=a,alert("评论已"+(a?"设为公开":"设为私有")))}catch(l){alert("操作失败: "+((null==(t=null==(a=l.response)?void 0:a.data)?void 0:t.message)||l.message))}})(e),class:h(["visibility-btn",{private:!e.isPublic}])},b(e.isPublic?"🔒 设为私有":"🔓 设为公开"),11,Ll),u("button",{onClick:a=>T(e),class:"jump-btn"}," 🔗 跳转 ",8,Pl),u("button",{onClick:a=>(async e=>{var a,t;if(confirm("确定要删除这条评论吗？此操作不可恢复。"))try{(await A.deleteComment(e)).success&&(await _(),alert("评论已删除!"))}catch(l){alert("删除失败: "+((null==(t=null==(a=l.response)?void 0:a.data)?void 0:t.message)||l.message))}})(e.id||e._id),class:"delete-btn"}," 🗑️ 删除 ",8,Sl)])])}),128))])),w.value||k.value||0!==t.value.length?f("",!0):(r(),i("div",jl,a[8]||(a[8]=[u("h3",null,"暂无评论",-1),u("p",null,"还没有任何评论数据",-1)])))]))}},[["__scopeId","data-v-0a6f6234"]]),zl={class:"admin-user-manager"},Ol={class:"filter-bar"},$l={key:0,class:"loading-state"},Ml={key:1,class:"error-state"},Fl={key:2,class:"users-table"},Bl={class:"user-info"},ql={class:"username"},Nl={key:0,class:"pending-dot"},Xl={class:"user-id"},Rl={class:"action-buttons"},Gl=["onClick"],Wl=["onClick"],Jl=["onClick"],Ql={key:3,class:"empty-state"},Hl={class:"modal-body"},Kl={class:"form-group"},Yl={class:"form-group"},Zl={class:"form-group"},es={class:"password-input-group"},as={class:"form-group"},ts={class:"form-group"},ls=a({__name:"AdminUserManager",setup(e){const a=l([]),t=l([]),C=l(!1),_=l(!1),T=l(""),x=l(""),I=l(""),U=l(""),V=s({id:null,username:"",email:"",password:"",role:"user",status:"pending"}),L=n(()=>{const{user:e}=D.getAuth();return(null==e?void 0:e._id)||(null==e?void 0:e.id)}),P=n(()=>[...t.value].sort((e,a)=>"pending"===e.status&&"pending"!==a.status?-1:"pending"!==e.status&&"pending"===a.status?1:new Date(a.createdAt||0)-new Date(e.createdAt||0))),S=async()=>{_.value=!0,T.value="";try{const e=await A.getAllUsers();if(!e.success)throw new Error(e.message||"获取用户列表失败");{const l=(e.data.users||e.data||[]).map(e=>({...e,status:e.status||(!1!==e.active?"approved":"pending")}));a.value=l,t.value=l}}catch(e){T.value=e.message||"获取用户列表失败，请稍后重试";const l=[{_id:"1",username:"admin",email:"admin@example.com",role:"admin",status:"approved",createdAt:(new Date).toISOString()},{_id:"2",username:"newuser",email:"newuser@example.com",role:"user",status:"pending",createdAt:new Date(Date.now()-864e5).toISOString()},{_id:"3",username:"alice",email:"alice@example.com",role:"user",status:"approved",createdAt:new Date(Date.now()-1728e5).toISOString()}];a.value=l,t.value=l}finally{_.value=!1}},j=()=>{let e=a.value;if(x.value&&(e=e.filter(e=>e.role===x.value)),I.value&&(e=e.filter(e=>e.status===I.value)),U.value){const a=U.value.toLowerCase();e=e.filter(e=>e.username.toLowerCase().includes(a)||e.email.toLowerCase().includes(a))}t.value=e},E=()=>{confirm("确定要重置此用户的密码为 123456 吗？")&&(V.password="123456",alert("密码已设置为 123456"))},z=async()=>{var e,a;try{const e={username:V.username,email:V.email,role:V.role,status:V.status};V.password&&(e.password=V.password);(await A.updateUserRole(V.id,e)).success&&(alert("用户更新成功!"),await S(),O())}catch(t){alert("保存失败: "+((null==(a=null==(e=t.response)?void 0:e.data)?void 0:a.message)||t.message))}},O=()=>{C.value=!1,Object.assign(V,{id:null,username:"",email:"",password:"",role:"user",status:"pending"})},$=e=>{if(!e)return"";const a=new Date(e);return isNaN(a.getTime())?"":a.toLocaleString("zh-CN")};return o(()=>{S()}),(e,a)=>(r(),i("div",zl,[a[24]||(a[24]=u("div",{class:"manager-header"},[u("h2",null,"用户管理")],-1)),u("div",Ol,[d(u("select",{"onUpdate:modelValue":a[0]||(a[0]=e=>x.value=e),onChange:j},a[9]||(a[9]=[u("option",{value:""},"全部角色",-1),u("option",{value:"admin"},"管理员",-1),u("option",{value:"user"},"普通用户",-1)]),544),[[p,x.value]]),d(u("select",{"onUpdate:modelValue":a[1]||(a[1]=e=>I.value=e),onChange:j},a[10]||(a[10]=[u("option",{value:""},"全部状态",-1),u("option",{value:"approved"},"已启用",-1),u("option",{value:"pending"},"待审核",-1)]),544),[[p,I.value]]),d(u("input",{"onUpdate:modelValue":a[2]||(a[2]=e=>U.value=e),placeholder:"搜索用户名或邮箱...",onInput:j},null,544),[[v,U.value]])]),_.value?(r(),i("div",$l,a[11]||(a[11]=[u("p",null,"正在加载用户数据...",-1)]))):T.value?(r(),i("div",Ml,[a[12]||(a[12]=u("h3",null,"加载失败",-1)),u("p",null,b(T.value),1),u("button",{onClick:S,class:"retry-btn"},"重试")])):(r(),i("div",Fl,[u("table",null,[a[13]||(a[13]=u("thead",null,[u("tr",null,[u("th",null,"用户名"),u("th",null,"邮箱"),u("th",null,"角色"),u("th",null,"状态"),u("th",null,"注册时间"),u("th",null,"操作")])],-1)),u("tbody",null,[(r(!0),i(m,null,g(P.value,e=>{return r(),i("tr",{key:e._id||e.id,class:h({"pending-user":"pending"===e.status})},[u("td",null,[u("div",Bl,[u("div",ql,["pending"===e.status?(r(),i("span",Nl)):f("",!0),y(" "+b(e.username),1)]),u("div",Xl,"ID: "+b(e._id||e.id),1)])]),u("td",null,b(e.email),1),u("td",null,[u("span",{class:h(["role-badge",e.role])},b((t=e.role,{admin:"管理员",user:"普通用户"}[t]||t)),3)]),u("td",null,[u("span",{class:h(["status-badge",e.status])},b((a=e.status,{approved:"已启用",pending:"待审核"}[a]||a)),3)]),u("td",null,b($(e.createdAt||e.registerTime)),1),u("td",null,[u("div",Rl,[u("button",{onClick:a=>(e=>{Object.assign(V,{id:e._id||e.id,username:e.username,email:e.email,password:"",role:e.role,status:e.status}),C.value=!0})(e),class:"edit-btn"},"编辑",8,Gl),"pending"===e.status?(r(),i("button",{key:0,onClick:a=>(async e=>{var a,t;if(confirm("确定要启用此用户吗？"))try{(await A.updateUserRole(e,{status:"approved"})).success&&(await S(),alert("用户已启用!"))}catch(l){alert("启用失败: "+((null==(t=null==(a=l.response)?void 0:a.data)?void 0:t.message)||l.message))}})(e._id||e.id),class:"approve-btn"}," 启用 ",8,Wl)):f("",!0),"admin"!==e.role||e._id!==L.value?(r(),i("button",{key:1,onClick:a=>(async e=>{var a,t;if(confirm("确定要删除此用户吗？此操作将删除该用户的所有博客、评论等数据，不可恢复！"))try{(await A.deleteUser(e)).success&&(await S(),alert("用户删除成功!"))}catch(l){alert("删除失败: "+((null==(t=null==(a=l.response)?void 0:a.data)?void 0:t.message)||l.message))}})(e._id||e.id),class:"delete-btn"}," 删除 ",8,Jl)):f("",!0)])])],2);var a,t}),128))])])])),_.value||T.value||0!==t.value.length?f("",!0):(r(),i("div",Ql,a[14]||(a[14]=[u("h3",null,"暂无用户数据",-1),u("p",null,"没有找到符合条件的用户",-1)]))),(r(),c(k,{to:"body"},[C.value?(r(),i("div",{key:0,class:"modal-overlay",onClick:O},[u("div",{class:"modal-content",onClick:a[8]||(a[8]=w(()=>{},["stop"]))},[u("div",{class:"modal-header"},[a[15]||(a[15]=u("h3",null,"编辑用户",-1)),u("button",{onClick:O,class:"close-btn"},"✕")]),u("div",Hl,[u("form",{onSubmit:w(z,["prevent"])},[u("div",Kl,[a[16]||(a[16]=u("label",null,"用户名",-1)),d(u("input",{"onUpdate:modelValue":a[3]||(a[3]=e=>V.username=e),type:"text",required:""},null,512),[[v,V.username]])]),u("div",Yl,[a[17]||(a[17]=u("label",null,"邮箱",-1)),d(u("input",{"onUpdate:modelValue":a[4]||(a[4]=e=>V.email=e),type:"email",required:""},null,512),[[v,V.email]])]),u("div",Zl,[a[18]||(a[18]=u("label",null,"密码",-1)),u("div",es,[d(u("input",{"onUpdate:modelValue":a[5]||(a[5]=e=>V.password=e),type:"password",placeholder:"留空则不修改密码"},null,512),[[v,V.password]]),u("button",{type:"button",onClick:E,class:"reset-password-btn"},"重置密码")])]),u("div",as,[a[20]||(a[20]=u("label",null,"角色",-1)),d(u("select",{"onUpdate:modelValue":a[6]||(a[6]=e=>V.role=e),required:""},a[19]||(a[19]=[u("option",{value:"user"},"普通用户",-1),u("option",{value:"admin"},"管理员",-1)]),512),[[p,V.role]])]),u("div",ts,[a[22]||(a[22]=u("label",null,"状态",-1)),d(u("select",{"onUpdate:modelValue":a[7]||(a[7]=e=>V.status=e)},a[21]||(a[21]=[u("option",{value:"pending"},"待审核",-1),u("option",{value:"approved"},"已启用",-1)]),512),[[p,V.status]])]),u("div",{class:"form-actions"},[u("button",{type:"button",onClick:O,class:"cancel-btn"},"取消"),a[23]||(a[23]=u("button",{type:"submit",class:"save-btn"},"更新",-1))])],32)])])])):f("",!0)]))]))}},[["__scopeId","data-v-c46a3f58"]]),ss={class:"admin-panel"},ns={class:"admin-header"},os={class:"welcome-section"},is={class:"welcome-text"},rs={class:"admin-nav"},us={class:"nav-grid"},cs=["onClick"],ds={class:"nav-icon"},vs={key:0,class:"pending-badge"},ps={class:"admin-content"},ms={key:0,class:"overview-content"},gs={class:"recent-activities"},ys={key:0,class:"activity-list"},fs={class:"activity-icon"},bs={class:"activity-content"},hs={class:"activity-text"},ws={class:"activity-time"},ks={key:1,class:"empty-activity"},Cs=a({__name:"AdminPanel",setup(e){I();const a=l("overview"),t=l(null),d=s({blogs:0,images:0,documents:0,comments:0}),v=l([]),p=n(()=>[{key:"blogs",icon:"📝",label:"博客管理",description:"创建和编辑博客文章",pending:0},{key:"gallery",icon:"🖼️",label:"图库管理",description:"管理图片和分类",pending:0},{key:"documents",icon:"📄",label:"文档管理",description:"管理文档和资源",pending:0},{key:"friend-links",icon:"🔗",label:"友情链接",description:"管理友情链接申请",pending:0},{key:"users",icon:"👥",label:"用户管理",description:"管理用户账户和权限",pending:0},{key:"comments",icon:"💬",label:"评论管理",description:"管理用户评论",pending:0},{key:"user-panel",icon:"👤",label:"我的面板",description:"管理个人评论和设置",pending:0}]),y=n(()=>({blogs:be,gallery:gt,documents:rl,"friend-links":na,users:ls,comments:El,"user-panel":E}[a.value]));return o(()=>{(()=>{const{user:e}=D.getAuth();t.value=e})(),(async()=>{try{const e=await A.getStats();e.success&&(Object.assign(d,e.data.stats),v.value=(e.data.recentActivities||[]).slice(0,3))}catch(e){Object.assign(d,{blogs:15,images:128,documents:25,playlists:45,comments:89}),v.value=[{id:1,icon:"🚀",text:"系统启动完成",time:new Date},{id:2,icon:"👨‍💼",text:"管理员登录成功",time:new Date(Date.now()-6e5)},{id:3,icon:"🔗",text:"数据库连接正常",time:new Date(Date.now()-18e5)}]}})()}),(e,l)=>{var s;return r(),i("div",ss,[u("div",ns,[u("div",os,[l[0]||(l[0]=u("h1",null,"管理员控制台",-1)),u("p",is,"欢迎回来，"+b(null==(s=t.value)?void 0:s.username)+"！",1)])]),u("div",rs,[u("div",us,[(r(!0),i(m,null,g(p.value,e=>(r(),i("div",{key:e.key,class:h(["nav-card",{active:a.value===e.key}]),onClick:t=>a.value=e.key},[u("div",ds,b(e.icon),1),u("h3",null,b(e.label),1),u("p",null,b(e.description),1),e.pending>0?(r(),i("div",vs,b(e.pending),1)):f("",!0)],10,cs))),128))])]),u("div",ps,["overview"===a.value?(r(),i("div",ms,[l[3]||(l[3]=u("h2",null,"系统总览",-1)),u("div",gs,[l[2]||(l[2]=u("h3",null,"最近活动",-1)),v.value.length>0?(r(),i("div",ys,[(r(!0),i(m,null,g(v.value.slice(0,3),e=>{return r(),i("div",{key:e.id,class:"activity-item"},[u("div",fs,b(e.icon),1),u("div",bs,[u("div",hs,b(e.text),1),u("div",ws,b((a=e.time,new Date(a).toLocaleString("zh-CN"))),1)])]);var a}),128))])):(r(),i("div",ks,l[1]||(l[1]=[u("p",null,"暂无最近活动",-1)])))])])):f("",!0),"overview"!==a.value?(r(),c(U(y.value),{key:1})):f("",!0)])])}}},[["__scopeId","data-v-c7cec6c9"]]);export{Cs as default};
