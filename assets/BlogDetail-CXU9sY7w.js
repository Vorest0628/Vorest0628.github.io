import{r as e,c as a,w as l,y as t,z as s,K as n,A as i,Q as o,O as c,I as u,al as r,P as v,a6 as d,D as m,u as p,M as f,V as g,J as h,aj as y,ae as b,aW as k,H as w}from"./vue-core-BYuX5Vli.js";import{b as C}from"./blog-uF5hDeOs.js";import{C as _,c as x}from"./CommentNode-DGiGoMRI.js";import{m as j}from"./marked.esm-BNz8l3bD.js";import{p as $}from"./purify.es-COJDRNUs.js";import{_ as B,u as P}from"./index-B6AuLqK3.js";import{f as I}from"./utils-DA1bHc0c.js";import"./element-ui-drMXFw0_.js";const E={class:"blog-detail"},M={key:0,class:"loading"},T={key:1,class:"not-found"},z={key:2,class:"not-found"},A={key:3,class:"article"},D={key:0,class:"article-cover"},L=["src"],V={class:"article-header"},H={class:"article-info"},S={class:"article-meta"},q={class:"meta-info"},O={class:"date"},U={class:"category"},J={class:"views"},K={class:"article-tags"},N=["innerHTML"],Q={class:"article-footer"},R={class:"article-actions"},W={class:"comment-form"},F={key:0,class:"login-prompt"},G={class:"form-row"},X={class:"comment-options"},Y={class:"checkbox-label"},Z={class:"form-actions"},ee=["disabled"],ae={class:"comments-list"},le={key:0,class:"loading-state"},te={key:0,class:"comments-empty"},se=B({__name:"BlogDetail",setup(B){const se=k(),ne=P(),ie=e(!0),oe=e(null),ce=e(null),ue=e(!1),re=e([]),ve=e(!1),de=e(null),me=e({content:"",isPublic:!0}),pe=e(!1),fe="https://api.shirakawananase.top",ge=new j.Renderer;ge.image=(e="",a,l)=>{if("object"==typeof e&&null!==e){const t=e;e=t.href||"",a=t.title,l=t.text||t.alt||""}const t=/^(https?:|data:)/i.test(e),s=/^\/api\/blog\//i.test(e);let n=e;t||s||(n=e),s&&fe&&(n=`${fe}${e}`);return`<img src="${n}" alt="${l||""}"${a?` title="${a}"`:""} loading="lazy" decoding="async">`},j.setOptions({renderer:ge});const he=a(()=>{var e;if(!(null==(e=oe.value)?void 0:e.content))return"";const a=j(oe.value.content);return $.sanitize(a)}),ye=a(()=>{var e;const a=null==(e=oe.value)?void 0:e.coverImage;if(!a)return"";const l=/^(https?:|data:)/i.test(a),t=/^\/api\/blog\//i.test(a);return l?a:t&&fe?`${fe}${a}`:a}),be=()=>{},ke=a(()=>{let e=0;const a=l=>{e++,l.replies&&l.replies.length>0&&l.replies.forEach(a)};return re.value.forEach(a),e}),we=async e=>{ve.value=!0;try{const a=await x.getTargetComments("Blog",e);a.success&&(re.value=a.data)}catch(a){}finally{ve.value=!1}},Ce=async()=>{if(!pe.value&&oe.value){pe.value=!0;try{const e={content:me.value.content,targetType:"Blog",targetId:oe.value.id,parentComment:null,isPublic:me.value.isPublic},a=await x.createComment(e);if(!a.success)throw new Error(a.message||"评论发布失败");_e(a.data),me.value.content="",me.value.isPublic=!0,alert("评论发表成功！")}catch(e){alert(`评论发布失败: ${e.message}`)}finally{pe.value=!1}}},_e=e=>{if(e.parentComment){const a=(e,l)=>{for(const t of e){if((t.id||t._id)===l.parentComment)return t.replies||(t.replies=[]),t.replies.push(l),!0;if(t.replies&&a(t.replies,l))return!0}return!1};a(re.value,e)}else re.value.unshift(e)},xe=e=>{const a=(e,l)=>{for(let t=e.length-1;t>=0;t--){if((e[t].id||e[t]._id)===l)return e.splice(t,1),!0;if(e[t].replies&&a(e[t].replies,l))return!0}return!1};a(re.value,e)},je=()=>{var e;null==(e=de.value)||e.scrollIntoView({behavior:"smooth"})},$e=async()=>{if(oe.value)try{const e=await C.checkBlogLikeStatus(oe.value.id);e.success&&(ue.value=e.data.isLiked)}catch(e){ue.value=!1}},Be=async()=>{var e,a;if(ne.isAuthenticated){if(oe.value)try{if(ue.value){const e=await C.unlikeBlog(oe.value.id);e.success&&(ue.value=!1,oe.value.likeCount=e.data.likeCount)}else{const e=await C.likeBlog(oe.value.id);e.success&&(ue.value=!0,oe.value.likeCount=e.data.likeCount)}}catch(l){alert((null==(a=null==(e=l.response)?void 0:e.data)?void 0:a.message)||"操作失败，请重试")}}else alert("请先登录后再点赞")},Pe=()=>{navigator.share?navigator.share({title:oe.value.title,text:oe.value.excerpt,url:window.location.href}).catch(e=>{}):navigator.clipboard.writeText(window.location.href).then(()=>alert("文章链接已复制到剪贴板")).catch(()=>alert("分享失败"))};return l(()=>se.params.id,e=>{e&&(async e=>{ie.value=!0,ce.value=null,oe.value=null,re.value=[];try{const a=await C.getBlogById(e);if(!a.success)throw new Error(a.message||"文章加载失败");oe.value=a.data,await we(e),await $e()}catch(a){ce.value=a.message||"无法找到指定的文章，它可能已被删除或不存在。"}finally{ie.value=!1}})(e)},{immediate:!0}),(e,a)=>{const l=r("router-link");return s(),t("div",E,[ie.value?(s(),t("div",M,a[2]||(a[2]=[i("div",{class:"loading-spinner"},null,-1),i("p",null,"加载中...",-1)]))):ce.value?(s(),t("div",T,[a[4]||(a[4]=i("h2",null,"加载文章失败",-1)),i("p",null,c(ce.value),1),o(l,{to:"/blog",class:"back-btn"},{default:u(()=>a[3]||(a[3]=[f("返回博客列表")])),_:1,__:[3]})])):oe.value?(s(),t("article",A,[ye.value?(s(),t("div",D,[i("img",{src:ye.value,alt:"封面图",loading:"lazy",decoding:"async",onError:be},null,40,L)])):n("",!0),i("header",V,[i("div",H,[i("h1",null,c(oe.value.title),1),i("div",S,[i("div",q,[i("span",O,"发布时间："+c((k=oe.value.date,k?I(new Date(k),"yyyy年MM月dd日"):"")),1),i("span",U,"分类："+c(oe.value.category),1),i("span",J,"阅读："+c(oe.value.viewCount)+" 次",1)]),i("div",K,[(s(!0),t(v,null,d(oe.value.tags,e=>(s(),t("span",{key:e,class:"tag"}," # "+c(e),1))),128))])])])]),i("div",{class:"article-content",innerHTML:he.value},null,8,N),i("footer",Q,[i("div",R,[i("button",{onClick:Be,class:m(["action-btn like-btn",{liked:ue.value}])},c(ue.value?"❤️":"🤍")+" "+c(oe.value.likeCount),3),i("button",{onClick:Pe,class:"action-btn share-btn"}," 📤 分享 "),i("button",{onClick:je,class:"action-btn comment-btn"}," 💬 评论 ("+c(ke.value)+") ",1)])])])):(s(),t("div",z,[a[6]||(a[6]=i("h2",null,"文章不存在",-1)),a[7]||(a[7]=i("p",null,"抱歉，找不到您要查看的文章。",-1)),o(l,{to:"/blog",class:"back-btn"},{default:u(()=>a[5]||(a[5]=[f("返回博客列表")])),_:1,__:[5]})])),oe.value?(s(),t("section",{key:4,class:"comments-section",ref_key:"commentsSection",ref:de},[i("h3",null,"评论 ("+c(ke.value)+")",1),i("div",W,[a[12]||(a[12]=i("h4",null,"发表评论",-1)),p(ne).isAuthenticated?(s(),t("form",{key:1,onSubmit:g(Ce,["prevent"])},[i("div",G,[h(i("textarea",{"onUpdate:modelValue":a[0]||(a[0]=e=>me.value.content=e),placeholder:"写下你的评论...",required:"",rows:"4",class:"form-textarea"},null,512),[[y,me.value.content]])]),i("div",X,[i("label",Y,[h(i("input",{"onUpdate:modelValue":a[1]||(a[1]=e=>me.value.isPublic=e),type:"checkbox",class:"checkbox-input"},null,512),[[b,me.value.isPublic]]),a[11]||(a[11]=i("span",{class:"checkbox-text"},"公开评论",-1))])]),i("div",Z,[i("button",{type:"submit",class:"submit-btn",disabled:pe.value},c(pe.value?"发布中...":"发布评论"),9,ee)])],32)):(s(),t("div",F,[i("p",null,[a[9]||(a[9]=f("请先")),o(l,{to:"/auth"},{default:u(()=>a[8]||(a[8]=[f("登录")])),_:1,__:[8]}),a[10]||(a[10]=f("后再发表评论"))])]))]),i("div",ae,[ve.value?(s(),t("div",le,a[13]||(a[13]=[i("p",null,"正在加载评论...",-1)]))):(s(!0),t(v,{key:1},d(re.value,e=>(s(),w(_,{key:e.id||e._id,comment:e,onCommentDeleted:xe,onCommentAdded:_e},null,8,["comment"]))),128))]),ve.value||0!==re.value.length?n("",!0):(s(),t("div",te,a[14]||(a[14]=[i("p",null,"还没有评论，快来抢沙发吧！",-1)])))],512)):n("",!0)]);var k}}},[["__scopeId","data-v-7075a07e"]]);export{se as default};
