import{b as e,_ as t,u as s,c as n}from"./index-BPjNz-Ae.js";import{r as a,X as o,c as r,j as i,y as l,z as c,A as u,H as d,J as h,aj as p,aX as f,P as m,a6 as v,M as g,K as y,O as b,D as w,V as _,a1 as k,aP as x,ae as C,ag as A,C as S,aO as I,L as $}from"./vue-core-BH5VTiN9.js";import{authStorage as T}from"./auth-CVx9WU4Z.js";import{adminApi as O}from"./admin-BRBG1mYN.js";import{m as R}from"./marked.esm-BNz8l3bD.js";import{p as P}from"./purify.es-COJDRNUs.js";import{f as E}from"./friendLink-Ma5Uid9E.js";import{g as D}from"./gallery-B1-iJOZh.js";import{d as j}from"./document-CHhm0Gxb.js";import{U as L}from"./UserPanel-Bz18ivhV.js";import"./element-ui-B3nexxj5.js";import"./utils-DA1bHc0c.js";async function U(t){const s=new FormData;s.append("image",t);const n=await e.post("/admin/uploads/images",s,{headers:{"Content-Type":"multipart/form-data"}});if(!(null==n?void 0:n.success))throw new Error((null==n?void 0:n.message)||"上传失败");return n.data}function M(e,t,s,n,a){if("function"==typeof t||!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return t.set(e,s),s}function q(e,t,s,n){if("a"===s&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===s?n:"a"===s?n.call(e):n?n.value:t.get(e)}let N=function(){const{crypto:e}=globalThis;if(null==e?void 0:e.randomUUID)return N=e.randomUUID.bind(e),e.randomUUID();const t=new Uint8Array(1),s=e?()=>e.getRandomValues(t)[0]:()=>255*Math.random()&255;return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,e=>(+e^s()&15>>+e/4).toString(16))};function B(e){return"object"==typeof e&&null!==e&&("name"in e&&"AbortError"===e.name||"message"in e&&String(e.message).includes("FetchRequestCanceledException"))}const W=e=>{if(e instanceof Error)return e;if("object"==typeof e&&null!==e){try{if("[object Error]"===Object.prototype.toString.call(e)){const t=new Error(e.message,e.cause?{cause:e.cause}:{});return e.stack&&(t.stack=e.stack),e.cause&&!t.cause&&(t.cause=e.cause),e.name&&(t.name=e.name),t}}catch{}try{return new Error(JSON.stringify(e))}catch{}}return new Error(e)};class V extends Error{}class F extends V{constructor(e,t,s,n){super(`${F.makeMessage(e,t,s)}`),this.status=e,this.headers=n,this.requestID=null==n?void 0:n.get("x-request-id"),this.error=t;const a=t;this.code=null==a?void 0:a.code,this.param=null==a?void 0:a.param,this.type=null==a?void 0:a.type}static makeMessage(e,t,s){const n=(null==t?void 0:t.message)?"string"==typeof t.message?t.message:JSON.stringify(t.message):t?JSON.stringify(t):s;return e&&n?`${e} ${n}`:e?`${e} status code (no body)`:n||"(no status code or body)"}static generate(e,t,s,n){if(!e||!n)return new z({message:s,cause:W(t)});const a=null==t?void 0:t.error;return 400===e?new J(e,a,s,n):401===e?new K(e,a,s,n):403===e?new G(e,a,s,n):404===e?new Q(e,a,s,n):409===e?new Y(e,a,s,n):422===e?new Z(e,a,s,n):429===e?new ee(e,a,s,n):e>=500?new te(e,a,s,n):new F(e,a,s,n)}}class X extends F{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}}class z extends F{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}}class H extends z{constructor({message:e}={}){super({message:e??"Request timed out."})}}class J extends F{}class K extends F{}class G extends F{}class Q extends F{}class Y extends F{}class Z extends F{}class ee extends F{}class te extends F{}class se extends V{constructor(){super("Could not parse response content as the length limit was reached")}}class ne extends V{constructor(){super("Could not parse response content as the request was rejected by the content filter")}}class ae extends Error{constructor(e){super(e)}}const oe=/^[a-z][a-z0-9+.-]*:/i;let re=e=>(re=Array.isArray,re(e)),ie=re;function le(e){return"object"!=typeof e?{}:e??{}}function ce(e){return null!=e&&"object"==typeof e&&!Array.isArray(e)}const ue=e=>new Promise(t=>setTimeout(t,e)),de="6.9.1";const he=()=>{var e;const t="undefined"!=typeof Deno&&null!=Deno.build?"deno":"undefined"!=typeof EdgeRuntime?"edge":"[object process]"===Object.prototype.toString.call(void 0!==globalThis.process?globalThis.process:0)?"node":"unknown";if("deno"===t)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":de,"X-Stainless-OS":fe(Deno.build.os),"X-Stainless-Arch":pe(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":"string"==typeof Deno.version?Deno.version:(null==(e=Deno.version)?void 0:e.deno)??"unknown"};if("undefined"!=typeof EdgeRuntime)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":de,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":globalThis.process.version};if("node"===t)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":de,"X-Stainless-OS":fe(globalThis.process.platform??"unknown"),"X-Stainless-Arch":pe(globalThis.process.arch??"unknown"),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":globalThis.process.version??"unknown"};const s=function(){if("undefined"==typeof navigator||!navigator)return null;const e=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:t,pattern:s}of e){const e=s.exec(navigator.userAgent);if(e){return{browser:t,version:`${e[1]||0}.${e[2]||0}.${e[3]||0}`}}}return null}();return s?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":de,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${s.browser}`,"X-Stainless-Runtime-Version":s.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":de,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};const pe=e=>"x32"===e?"x32":"x86_64"===e||"x64"===e?"x64":"arm"===e?"arm":"aarch64"===e||"arm64"===e?"arm64":e?`other:${e}`:"unknown",fe=e=>(e=e.toLowerCase()).includes("ios")?"iOS":"android"===e?"Android":"darwin"===e?"MacOS":"win32"===e?"Windows":"freebsd"===e?"FreeBSD":"openbsd"===e?"OpenBSD":"linux"===e?"Linux":e?`Other:${e}`:"Unknown";let me;function ve(...e){const t=globalThis.ReadableStream;if(void 0===t)throw new Error("`ReadableStream` is not defined as a global; You will need to polyfill it, `globalThis.ReadableStream = ReadableStream`");return new t(...e)}function ge(e){let t=Symbol.asyncIterator in e?e[Symbol.asyncIterator]():e[Symbol.iterator]();return ve({start(){},async pull(e){const{done:s,value:n}=await t.next();s?e.close():e.enqueue(n)},async cancel(){var e;await(null==(e=t.return)?void 0:e.call(t))}})}function ye(e){if(e[Symbol.asyncIterator])return e;const t=e.getReader();return{async next(){try{const e=await t.read();return(null==e?void 0:e.done)&&t.releaseLock(),e}catch(e){throw t.releaseLock(),e}},async return(){const e=t.cancel();return t.releaseLock(),await e,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}const be=({headers:e,body:t})=>({bodyHeaders:{"content-type":"application/json"},body:JSON.stringify(t)}),we="RFC3986",_e=e=>String(e),ke={RFC1738:e=>String(e).replace(/%20/g,"+"),RFC3986:_e};let xe=(e,t)=>(xe=Object.hasOwn??Function.prototype.call.bind(Object.prototype.hasOwnProperty),xe(e,t));const Ce=(()=>{const e=[];for(let t=0;t<256;++t)e.push("%"+((t<16?"0":"")+t.toString(16)).toUpperCase());return e})(),Ae=1024;function Se(e,t){if(re(e)){const s=[];for(let n=0;n<e.length;n+=1)s.push(t(e[n]));return s}return t(e)}const Ie={brackets:e=>String(e)+"[]",comma:"comma",indices:(e,t)=>String(e)+"["+t+"]",repeat:e=>String(e)},$e=function(e,t){Array.prototype.push.apply(e,re(t)?t:[t])};let Te;const Oe={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:(e,t,s,n,a)=>{if(0===e.length)return e;let o=e;if("symbol"==typeof e?o=Symbol.prototype.toString.call(e):"string"!=typeof e&&(o=String(e)),"iso-8859-1"===s)return escape(o).replace(/%u[0-9a-f]{4}/gi,function(e){return"%26%23"+parseInt(e.slice(2),16)+"%3B"});let r="";for(let i=0;i<o.length;i+=Ae){const e=o.length>=Ae?o.slice(i,i+Ae):o,t=[];for(let s=0;s<e.length;++s){let n=e.charCodeAt(s);45===n||46===n||95===n||126===n||n>=48&&n<=57||n>=65&&n<=90||n>=97&&n<=122||"RFC1738"===a&&(40===n||41===n)?t[t.length]=e.charAt(s):n<128?t[t.length]=Ce[n]:n<2048?t[t.length]=Ce[192|n>>6]+Ce[128|63&n]:n<55296||n>=57344?t[t.length]=Ce[224|n>>12]+Ce[128|n>>6&63]+Ce[128|63&n]:(s+=1,n=65536+((1023&n)<<10|1023&e.charCodeAt(s)),t[t.length]=Ce[240|n>>18]+Ce[128|n>>12&63]+Ce[128|n>>6&63]+Ce[128|63&n])}r+=t.join("")}return r},encodeValuesOnly:!1,format:we,formatter:_e,indices:!1,serializeDate:e=>(Te??(Te=Function.prototype.call.bind(Date.prototype.toISOString)))(e),skipNulls:!1,strictNullHandling:!1};const Re={};function Pe(e,t,s,n,a,o,r,i,l,c,u,d,h,p,f,m,v,g){let y=e,b=g,w=0,_=!1;for(;void 0!==(b=b.get(Re))&&!_;){const t=b.get(e);if(w+=1,void 0!==t){if(t===w)throw new RangeError("Cyclic object value");_=!0}void 0===b.get(Re)&&(w=0)}if("function"==typeof c?y=c(t,y):y instanceof Date?y=null==h?void 0:h(y):"comma"===s&&re(y)&&(y=Se(y,function(e){return e instanceof Date?null==h?void 0:h(e):e})),null===y){if(o)return l&&!m?l(t,Oe.encoder,v,"key",p):t;y=""}if("string"==typeof(k=y)||"number"==typeof k||"boolean"==typeof k||"symbol"==typeof k||"bigint"==typeof k||function(e){return!(!e||"object"!=typeof e||!(e.constructor&&e.constructor.isBuffer&&e.constructor.isBuffer(e)))}(y)){if(l){const e=m?t:l(t,Oe.encoder,v,"key",p);return[(null==f?void 0:f(e))+"="+(null==f?void 0:f(l(y,Oe.encoder,v,"value",p)))]}return[(null==f?void 0:f(t))+"="+(null==f?void 0:f(String(y)))]}var k;const x=[];if(void 0===y)return x;let C;if("comma"===s&&re(y))m&&l&&(y=Se(y,l)),C=[{value:y.length>0?y.join(",")||null:void 0}];else if(re(c))C=c;else{const e=Object.keys(y);C=u?e.sort(u):e}const A=i?String(t).replace(/\./g,"%2E"):String(t),S=n&&re(y)&&1===y.length?A+"[]":A;if(a&&re(y)&&0===y.length)return S+"[]";for(let I=0;I<C.length;++I){const t=C[I],b="object"==typeof t&&void 0!==t.value?t.value:y[t];if(r&&null===b)continue;const _=d&&i?t.replace(/\./g,"%2E"):t,k=re(y)?"function"==typeof s?s(S,_):S:S+(d?"."+_:"["+_+"]");g.set(e,w);const A=new WeakMap;A.set(Re,g),$e(x,Pe(b,k,s,n,a,o,r,i,"comma"===s&&m&&re(y)?null:l,c,u,d,h,p,f,m,v,A))}return x}function Ee(e,t={}){let s=e;const n=function(e=Oe){if(void 0!==e.allowEmptyArrays&&"boolean"!=typeof e.allowEmptyArrays)throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(void 0!==e.encodeDotInKeys&&"boolean"!=typeof e.encodeDotInKeys)throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(null!==e.encoder&&void 0!==e.encoder&&"function"!=typeof e.encoder)throw new TypeError("Encoder has to be a function.");const t=e.charset||Oe.charset;if(void 0!==e.charset&&"utf-8"!==e.charset&&"iso-8859-1"!==e.charset)throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let s=we;if(void 0!==e.format){if(!xe(ke,e.format))throw new TypeError("Unknown format option provided.");s=e.format}const n=ke[s];let a,o=Oe.filter;if(("function"==typeof e.filter||re(e.filter))&&(o=e.filter),a=e.arrayFormat&&e.arrayFormat in Ie?e.arrayFormat:"indices"in e?e.indices?"indices":"repeat":Oe.arrayFormat,"commaRoundTrip"in e&&"boolean"!=typeof e.commaRoundTrip)throw new TypeError("`commaRoundTrip` must be a boolean, or absent");const r=void 0===e.allowDots?1==!!e.encodeDotInKeys||Oe.allowDots:!!e.allowDots;return{addQueryPrefix:"boolean"==typeof e.addQueryPrefix?e.addQueryPrefix:Oe.addQueryPrefix,allowDots:r,allowEmptyArrays:"boolean"==typeof e.allowEmptyArrays?!!e.allowEmptyArrays:Oe.allowEmptyArrays,arrayFormat:a,charset:t,charsetSentinel:"boolean"==typeof e.charsetSentinel?e.charsetSentinel:Oe.charsetSentinel,commaRoundTrip:!!e.commaRoundTrip,delimiter:void 0===e.delimiter?Oe.delimiter:e.delimiter,encode:"boolean"==typeof e.encode?e.encode:Oe.encode,encodeDotInKeys:"boolean"==typeof e.encodeDotInKeys?e.encodeDotInKeys:Oe.encodeDotInKeys,encoder:"function"==typeof e.encoder?e.encoder:Oe.encoder,encodeValuesOnly:"boolean"==typeof e.encodeValuesOnly?e.encodeValuesOnly:Oe.encodeValuesOnly,filter:o,format:s,formatter:n,serializeDate:"function"==typeof e.serializeDate?e.serializeDate:Oe.serializeDate,skipNulls:"boolean"==typeof e.skipNulls?e.skipNulls:Oe.skipNulls,sort:"function"==typeof e.sort?e.sort:null,strictNullHandling:"boolean"==typeof e.strictNullHandling?e.strictNullHandling:Oe.strictNullHandling}}(t);let a,o;"function"==typeof n.filter?(o=n.filter,s=o("",s)):re(n.filter)&&(o=n.filter,a=o);const r=[];if("object"!=typeof s||null===s)return"";const i=Ie[n.arrayFormat],l="comma"===i&&n.commaRoundTrip;a||(a=Object.keys(s)),n.sort&&a.sort(n.sort);const c=new WeakMap;for(let h=0;h<a.length;++h){const e=a[h];n.skipNulls&&null===s[e]||$e(r,Pe(s[e],e,i,l,n.allowEmptyArrays,n.strictNullHandling,n.skipNulls,n.encodeDotInKeys,n.encode?n.encoder:null,n.filter,n.sort,n.allowDots,n.serializeDate,n.format,n.formatter,n.encodeValuesOnly,n.charset,c))}const u=r.join(n.delimiter);let d=!0===n.addQueryPrefix?"?":"";return n.charsetSentinel&&("iso-8859-1"===n.charset?d+="utf8=%26%2310003%3B&":d+="utf8=%E2%9C%93&"),u.length>0?d+u:""}let De,je;function Le(e){let t;return(De??(t=new globalThis.TextEncoder,De=t.encode.bind(t)))(e)}function Ue(e){let t;return(je??(t=new globalThis.TextDecoder,je=t.decode.bind(t)))(e)}var Me,qe;class Ne{constructor(){Me.set(this,void 0),qe.set(this,void 0),M(this,Me,new Uint8Array),M(this,qe,null)}decode(e){if(null==e)return[];const t=e instanceof ArrayBuffer?new Uint8Array(e):"string"==typeof e?Le(e):e;M(this,Me,function(e){let t=0;for(const a of e)t+=a.length;const s=new Uint8Array(t);let n=0;for(const a of e)s.set(a,n),n+=a.length;return s}([q(this,Me,"f"),t]));const s=[];let n;for(;null!=(n=Be(q(this,Me,"f"),q(this,qe,"f")));){if(n.carriage&&null==q(this,qe,"f")){M(this,qe,n.index);continue}if(null!=q(this,qe,"f")&&(n.index!==q(this,qe,"f")+1||n.carriage)){s.push(Ue(q(this,Me,"f").subarray(0,q(this,qe,"f")-1))),M(this,Me,q(this,Me,"f").subarray(q(this,qe,"f"))),M(this,qe,null);continue}const e=null!==q(this,qe,"f")?n.preceding-1:n.preceding,t=Ue(q(this,Me,"f").subarray(0,e));s.push(t),M(this,Me,q(this,Me,"f").subarray(n.index)),M(this,qe,null)}return s}flush(){return q(this,Me,"f").length?this.decode("\n"):[]}}function Be(e,t){for(let s=t??0;s<e.length;s++){if(10===e[s])return{preceding:s,index:s+1,carriage:!1};if(13===e[s])return{preceding:s,index:s+1,carriage:!0}}return null}function We(e){for(let t=0;t<e.length-1;t++){if(10===e[t]&&10===e[t+1])return t+2;if(13===e[t]&&13===e[t+1])return t+2;if(13===e[t]&&10===e[t+1]&&t+3<e.length&&13===e[t+2]&&10===e[t+3])return t+4}return-1}Me=new WeakMap,qe=new WeakMap,Ne.NEWLINE_CHARS=new Set(["\n","\r"]),Ne.NEWLINE_REGEXP=/\r\n|[\n\r]/g;const Ve={off:0,error:200,warn:300,info:400,debug:500},Fe=(e,t,s)=>{var n,a;if(e)return n=Ve,a=e,Object.prototype.hasOwnProperty.call(n,a)?e:void Ke(s).warn(`${t} was set to ${JSON.stringify(e)}, expected one of ${JSON.stringify(Object.keys(Ve))}`)};function Xe(){}function ze(e,t,s){return!t||Ve[e]>Ve[s]?Xe:t[e].bind(t)}const He={error:Xe,warn:Xe,info:Xe,debug:Xe};let Je=new WeakMap;function Ke(e){const t=e.logger,s=e.logLevel??"off";if(!t)return He;const n=Je.get(t);if(n&&n[0]===s)return n[1];const a={error:ze("error",t,s),warn:ze("warn",t,s),info:ze("info",t,s),debug:ze("debug",t,s)};return Je.set(t,[s,a]),a}const Ge=e=>(e.options&&(e.options={...e.options},delete e.options.headers),e.headers&&(e.headers=Object.fromEntries((e.headers instanceof Headers?[...e.headers]:Object.entries(e.headers)).map(([e,t])=>[e,"authorization"===e.toLowerCase()||"cookie"===e.toLowerCase()||"set-cookie"===e.toLowerCase()?"***":t]))),"retryOfRequestLogID"in e&&(e.retryOfRequestLogID&&(e.retryOf=e.retryOfRequestLogID),delete e.retryOfRequestLogID),e);var Qe,Ye,Ze;class et{constructor(e,t,s){this.iterator=e,Qe.set(this,void 0),this.controller=t,M(this,Qe,s)}static fromSSEResponse(e,t,s){let n=!1;const a=s?Ke(s):console;return new et(async function*(){if(n)throw new V("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let s=!1;try{for await(const n of async function*(e,t){if(!e.body){if(t.abort(),void 0!==globalThis.navigator&&"ReactNative"===globalThis.navigator.product)throw new V("The default react-native fetch implementation does not support streaming. Please use expo/fetch: https://docs.expo.dev/versions/latest/sdk/expo/#expofetch-api");throw new V("Attempted to iterate over a response with no body")}const s=new tt,n=new Ne,a=ye(e.body);for await(const o of async function*(e){let t=new Uint8Array;for await(const s of e){if(null==s)continue;const e=s instanceof ArrayBuffer?new Uint8Array(s):"string"==typeof s?Le(s):s;let n,a=new Uint8Array(t.length+e.length);for(a.set(t),a.set(e,t.length),t=a;-1!==(n=We(t));)yield t.slice(0,n),t=t.slice(n)}t.length>0&&(yield t)}(a))for(const e of n.decode(o)){const t=s.decode(e);t&&(yield t)}for(const o of n.flush()){const e=s.decode(o);e&&(yield e)}}(e,t))if(!s)if(n.data.startsWith("[DONE]"))s=!0;else if(null!==n.event&&n.event.startsWith("thread.")){let e;try{e=JSON.parse(n.data)}catch(o){throw o}if("error"==n.event)throw new F(void 0,e.error,e.message,void 0);yield{event:n.event,data:e}}else{let t;try{t=JSON.parse(n.data)}catch(o){throw a.error("Could not parse message into JSON:",n.data),a.error("From chunk:",n.raw),o}if(t&&t.error)throw new F(void 0,t.error,void 0,e.headers);yield t}s=!0}catch(o){if(B(o))return;throw o}finally{s||t.abort()}},t,s)}static fromReadableStream(e,t,s){let n=!1;return new et(async function*(){if(n)throw new V("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let s=!1;try{for await(const t of async function*(){const t=new Ne,s=ye(e);for await(const e of s)for(const s of t.decode(e))yield s;for(const e of t.flush())yield e}())s||t&&(yield JSON.parse(t));s=!0}catch(a){if(B(a))return;throw a}finally{s||t.abort()}},t,s)}[(Qe=new WeakMap,Symbol.asyncIterator)](){return this.iterator()}tee(){const e=[],t=[],s=this.iterator(),n=n=>({next:()=>{if(0===n.length){const n=s.next();e.push(n),t.push(n)}return n.shift()}});return[new et(()=>n(e),this.controller,q(this,Qe,"f")),new et(()=>n(t),this.controller,q(this,Qe,"f"))]}toReadableStream(){const e=this;let t;return ve({async start(){t=e[Symbol.asyncIterator]()},async pull(e){try{const{value:s,done:n}=await t.next();if(n)return e.close();const a=Le(JSON.stringify(s)+"\n");e.enqueue(a)}catch(s){e.error(s)}},async cancel(){var e;await(null==(e=t.return)?void 0:e.call(t))}})}}class tt{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const e={event:this.event,data:this.data.join("\n"),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],e}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,s,n]=function(e,t){const s=e.indexOf(t);if(-1!==s)return[e.substring(0,s),t,e.substring(s+t.length)];return[e,"",""]}(e,":");return n.startsWith(" ")&&(n=n.substring(1)),"event"===t?this.event=n:"data"===t&&this.data.push(n),null}}async function st(e,t){const{response:s,requestLogID:n,retryOfRequestLogID:a,startTime:o}=t,r=await(async()=>{var n;if(t.options.stream)return Ke(e).debug("response",s.status,s.url,s.headers,s.body),t.options.__streamClass?t.options.__streamClass.fromSSEResponse(s,t.controller,e):et.fromSSEResponse(s,t.controller,e);if(204===s.status)return null;if(t.options.__binaryResponse)return s;const a=s.headers.get("content-type"),o=null==(n=null==a?void 0:a.split(";")[0])?void 0:n.trim();if((null==o?void 0:o.includes("application/json"))||(null==o?void 0:o.endsWith("+json"))){return nt(await s.json(),s)}return await s.text()})();return Ke(e).debug(`[${n}] response parsed`,Ge({retryOfRequestLogID:a,url:s.url,status:s.status,body:r,durationMs:Date.now()-o})),r}function nt(e,t){return!e||"object"!=typeof e||Array.isArray(e)?e:Object.defineProperty(e,"_request_id",{value:t.headers.get("x-request-id"),enumerable:!1})}class at extends Promise{constructor(e,t,s=st){super(e=>{e(null)}),this.responsePromise=t,this.parseResponse=s,Ye.set(this,void 0),M(this,Ye,e)}_thenUnwrap(e){return new at(q(this,Ye,"f"),this.responsePromise,async(t,s)=>nt(e(await this.parseResponse(t,s),s),s.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(e=>this.parseResponse(q(this,Ye,"f"),e))),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}Ye=new WeakMap;class ot{constructor(e,t,s,n){Ze.set(this,void 0),M(this,Ze,e),this.options=n,this.response=t,this.body=s}hasNextPage(){return!!this.getPaginatedItems().length&&null!=this.nextPageRequestOptions()}async getNextPage(){const e=this.nextPageRequestOptions();if(!e)throw new V("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");return await q(this,Ze,"f").requestAPIList(this.constructor,e)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(Ze=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const t of e.getPaginatedItems())yield t}}class rt extends at{constructor(e,t,s){super(e,t,async(e,t)=>new s(e,t.response,await st(e,t),t.options))}async*[Symbol.asyncIterator](){const e=await(this);for await(const t of e)yield t}}class it extends ot{constructor(e,t,s,n){super(e,t,s,n),this.data=s.data||[],this.object=s.object}getPaginatedItems(){return this.data??[]}nextPageRequestOptions(){return null}}class lt extends ot{constructor(e,t,s,n){super(e,t,s,n),this.data=s.data||[],this.has_more=s.has_more||!1}getPaginatedItems(){return this.data??[]}hasNextPage(){return!1!==this.has_more&&super.hasNextPage()}nextPageRequestOptions(){var e;const t=this.getPaginatedItems(),s=null==(e=t[t.length-1])?void 0:e.id;return s?{...this.options,query:{...le(this.options.query),after:s}}:null}}class ct extends ot{constructor(e,t,s,n){super(e,t,s,n),this.data=s.data||[],this.has_more=s.has_more||!1,this.last_id=s.last_id||""}getPaginatedItems(){return this.data??[]}hasNextPage(){return!1!==this.has_more&&super.hasNextPage()}nextPageRequestOptions(){const e=this.last_id;return e?{...this.options,query:{...le(this.options.query),after:e}}:null}}const ut=()=>{var e;if("undefined"==typeof File){const{process:t}=globalThis,s="string"==typeof(null==(e=null==t?void 0:t.versions)?void 0:e.node)&&parseInt(t.versions.node.split("."))<20;throw new Error("`File` is not defined as a global, which is required for file uploads."+(s?" Update to Node 20 LTS or newer, or set `globalThis.File` to `import('node:buffer').File`.":""))}};function dt(e,t,s){return ut(),new File(e,t??"unknown_file",s)}function ht(e){return("object"==typeof e&&null!==e&&("name"in e&&e.name&&String(e.name)||"url"in e&&e.url&&String(e.url)||"filename"in e&&e.filename&&String(e.filename)||"path"in e&&e.path&&String(e.path))||"").split(/[\\/]/).pop()||void 0}const pt=e=>null!=e&&"object"==typeof e&&"function"==typeof e[Symbol.asyncIterator],ft=async(e,t)=>bt(e.body)?{...e,body:await gt(e.body,t)}:e,mt=async(e,t)=>({...e,body:await gt(e.body,t)}),vt=new WeakMap;const gt=async(e,t)=>{if(!(await function(e){const t="function"==typeof e?e:e.fetch,s=vt.get(t);if(s)return s;const n=(async()=>{try{const e="Response"in t?t.Response:(await t("data:,")).constructor,s=new FormData;return s.toString()!==await new e(s).text()}catch{return!0}})();return vt.set(t,n),n}(t)))throw new TypeError("The provided fetch function does not support file uploads with the current global FormData class.");const s=new FormData;return await Promise.all(Object.entries(e||{}).map(([e,t])=>wt(s,e,t))),s},yt=e=>e instanceof Blob&&"name"in e,bt=e=>{if((e=>"object"==typeof e&&null!==e&&(e instanceof Response||pt(e)||yt(e)))(e))return!0;if(Array.isArray(e))return e.some(bt);if(e&&"object"==typeof e)for(const t in e)if(bt(e[t]))return!0;return!1},wt=async(e,t,s)=>{if(void 0!==s){if(null==s)throw new TypeError(`Received null for "${t}"; to pass null in FormData, you must use the string 'null'`);if("string"==typeof s||"number"==typeof s||"boolean"==typeof s)e.append(t,String(s));else if(s instanceof Response)e.append(t,dt([await s.blob()],ht(s)));else if(pt(s))e.append(t,dt([await new Response(ge(s)).blob()],ht(s)));else if(yt(s))e.append(t,s,ht(s));else if(Array.isArray(s))await Promise.all(s.map(s=>wt(e,t+"[]",s)));else{if("object"!=typeof s)throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${s} instead`);await Promise.all(Object.entries(s).map(([s,n])=>wt(e,`${t}[${s}]`,n)))}}},_t=e=>null!=e&&"object"==typeof e&&"number"==typeof e.size&&"string"==typeof e.type&&"function"==typeof e.text&&"function"==typeof e.slice&&"function"==typeof e.arrayBuffer;async function kt(e){var t;let s=[];if("string"==typeof e||ArrayBuffer.isView(e)||e instanceof ArrayBuffer)s.push(e);else if(_t(e))s.push(e instanceof Blob?e:await e.arrayBuffer());else{if(!pt(e)){const s=null==(t=null==e?void 0:e.constructor)?void 0:t.name;throw new Error(`Unexpected data type: ${typeof e}${s?`; constructor: ${s}`:""}${function(e){if("object"!=typeof e||null===e)return"";const t=Object.getOwnPropertyNames(e);return`; props: [${t.map(e=>`"${e}"`).join(", ")}]`}(e)}`)}for await(const t of e)s.push(...await kt(t))}return s}class xt{constructor(e){this._client=e}}function Ct(e){return e.replace(/[^A-Za-z0-9\-._~!$&'()*+,;=:@]+/g,encodeURIComponent)}const At=Object.freeze(Object.create(null)),St=((e=Ct)=>function(t,...s){if(1===t.length)return t[0];let n=!1;const a=[],o=t.reduce((t,o,r)=>{var i;/[?#]/.test(o)&&(n=!0);const l=s[r];let c=(n?encodeURIComponent:e)(""+l);return r!==s.length&&(null==l||"object"==typeof l&&l.toString===(null==(i=Object.getPrototypeOf(Object.getPrototypeOf(l.hasOwnProperty??At)??At))?void 0:i.toString))&&(c=l+"",a.push({start:t.length+o.length,length:c.length,error:`Value of type ${Object.prototype.toString.call(l).slice(8,-1)} is not a valid path parameter`})),t+o+(r===s.length?"":c)},""),r=o.split(/[?#]/,1)[0],i=new RegExp("(?<=^|\\/)(?:\\.|%2e){1,2}(?=\\/|$)","gi");let l;for(;null!==(l=i.exec(r));)a.push({start:l.index,length:l[0].length,error:`Value "${l[0]}" can't be safely passed as a path parameter`});if(a.sort((e,t)=>e.start-t.start),a.length>0){let e=0;const t=a.reduce((t,s)=>{const n=" ".repeat(s.start-e),a="^".repeat(s.length);return e=s.start+s.length,t+n+a},"");throw new V(`Path parameters result in path with invalid segments:\n${a.map(e=>e.error).join("\n")}\n${o}\n${t}`)}return o})(Ct);let It=class extends xt{list(e,t={},s){return this._client.getAPIList(St`/chat/completions/${e}/messages`,lt,{query:t,...s})}};function $t(e){return void 0!==e&&"function"in e&&void 0!==e.function}function Tt(e){return"auto-parseable-response-format"===(null==e?void 0:e.$brand)}function Ot(e){return"auto-parseable-tool"===(null==e?void 0:e.$brand)}function Rt(e,t){const s=e.choices.map(e=>{var s;if("length"===e.finish_reason)throw new se;if("content_filter"===e.finish_reason)throw new ne;return jt(e.message.tool_calls),{...e,message:{...e.message,...e.message.tool_calls?{tool_calls:(null==(s=e.message.tool_calls)?void 0:s.map(e=>function(e,t){var s;const n=null==(s=e.tools)?void 0:s.find(e=>{var s;return $t(e)&&(null==(s=e.function)?void 0:s.name)===t.function.name});return{...t,function:{...t.function,parsed_arguments:Ot(n)?n.$parseRaw(t.function.arguments):(null==n?void 0:n.function.strict)?JSON.parse(t.function.arguments):null}}}(t,e)))??void 0}:void 0,parsed:e.message.content&&!e.message.refusal?Pt(t,e.message.content):null}}});return{...e,choices:s}}function Pt(e,t){var s,n;if("json_schema"!==(null==(s=e.response_format)?void 0:s.type))return null;if("json_schema"===(null==(n=e.response_format)?void 0:n.type)){if("$parseRaw"in e.response_format){return e.response_format.$parseRaw(t)}return JSON.parse(t)}return null}function Et(e,t){var s;if(!e||!("tools"in e)||!e.tools)return!1;const n=null==(s=e.tools)?void 0:s.find(e=>{var s;return $t(e)&&(null==(s=e.function)?void 0:s.name)===t.function.name});return $t(n)&&(Ot(n)||(null==n?void 0:n.function.strict)||!1)}function Dt(e){var t;return!!Tt(e.response_format)||((null==(t=e.tools)?void 0:t.some(e=>Ot(e)||"function"===e.type&&!0===e.function.strict))??!1)}function jt(e){for(const t of e||[])if("function"!==t.type)throw new V(`Currently only \`function\` tool calls are supported; Received \`${t.type}\``)}const Lt=e=>"assistant"===(null==e?void 0:e.role),Ut=e=>"tool"===(null==e?void 0:e.role);var Mt,qt,Nt,Bt,Wt,Vt,Ft,Xt,zt,Ht,Jt,Kt,Gt,Qt,Yt,Zt,es,ts,ss,ns,as;class os{constructor(){Mt.add(this),this.controller=new AbortController,qt.set(this,void 0),Nt.set(this,()=>{}),Bt.set(this,()=>{}),Wt.set(this,void 0),Vt.set(this,()=>{}),Ft.set(this,()=>{}),Xt.set(this,{}),zt.set(this,!1),Ht.set(this,!1),Jt.set(this,!1),Kt.set(this,!1),M(this,qt,new Promise((e,t)=>{M(this,Nt,e),M(this,Bt,t)})),M(this,Wt,new Promise((e,t)=>{M(this,Vt,e),M(this,Ft,t)})),q(this,qt,"f").catch(()=>{}),q(this,Wt,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},q(this,Mt,"m",Gt).bind(this))},0)}_connected(){this.ended||(q(this,Nt,"f").call(this),this._emit("connect"))}get ended(){return q(this,zt,"f")}get errored(){return q(this,Ht,"f")}get aborted(){return q(this,Jt,"f")}abort(){this.controller.abort()}on(e,t){return(q(this,Xt,"f")[e]||(q(this,Xt,"f")[e]=[])).push({listener:t}),this}off(e,t){const s=q(this,Xt,"f")[e];if(!s)return this;const n=s.findIndex(e=>e.listener===t);return n>=0&&s.splice(n,1),this}once(e,t){return(q(this,Xt,"f")[e]||(q(this,Xt,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,s)=>{M(this,Kt,!0),"error"!==e&&this.once("error",s),this.once(e,t)})}async done(){M(this,Kt,!0),await q(this,Wt,"f")}_emit(e,...t){if(q(this,zt,"f"))return;"end"===e&&(M(this,zt,!0),q(this,Vt,"f").call(this));const s=q(this,Xt,"f")[e];if(s&&(q(this,Xt,"f")[e]=s.filter(e=>!e.once),s.forEach(({listener:e})=>e(...t))),"abort"===e){const e=t[0];return q(this,Kt,"f")||(null==s?void 0:s.length)||Promise.reject(e),q(this,Bt,"f").call(this,e),q(this,Ft,"f").call(this,e),void this._emit("end")}if("error"===e){const e=t[0];q(this,Kt,"f")||(null==s?void 0:s.length)||Promise.reject(e),q(this,Bt,"f").call(this,e),q(this,Ft,"f").call(this,e),this._emit("end")}}_emitFinal(){}}function rs(e){return"function"==typeof e.parse}qt=new WeakMap,Nt=new WeakMap,Bt=new WeakMap,Wt=new WeakMap,Vt=new WeakMap,Ft=new WeakMap,Xt=new WeakMap,zt=new WeakMap,Ht=new WeakMap,Jt=new WeakMap,Kt=new WeakMap,Mt=new WeakSet,Gt=function(e){if(M(this,Ht,!0),e instanceof Error&&"AbortError"===e.name&&(e=new X),e instanceof X)return M(this,Jt,!0),this._emit("abort",e);if(e instanceof V)return this._emit("error",e);if(e instanceof Error){const t=new V(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new V(String(e)))};const is=10;class ls extends os{constructor(){super(...arguments),Qt.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){var t;this._chatCompletions.push(e),this._emit("chatCompletion",e);const s=null==(t=e.choices[0])?void 0:t.message;return s&&this._addMessage(s),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t)if(this._emit("message",e),Ut(e)&&e.content)this._emit("functionToolCallResult",e.content);else if(Lt(e)&&e.tool_calls)for(const s of e.tool_calls)"function"===s.type&&this._emit("functionToolCall",s.function)}async finalChatCompletion(){await this.done();const e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new V("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),q(this,Qt,"m",Yt).call(this)}async finalMessage(){return await this.done(),q(this,Qt,"m",Zt).call(this)}async finalFunctionToolCall(){return await this.done(),q(this,Qt,"m",es).call(this)}async finalFunctionToolCallResult(){return await this.done(),q(this,Qt,"m",ts).call(this)}async totalUsage(){return await this.done(),q(this,Qt,"m",ss).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){const e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);const t=q(this,Qt,"m",Zt).call(this);t&&this._emit("finalMessage",t);const s=q(this,Qt,"m",Yt).call(this);s&&this._emit("finalContent",s);const n=q(this,Qt,"m",es).call(this);n&&this._emit("finalFunctionToolCall",n);const a=q(this,Qt,"m",ts).call(this);null!=a&&this._emit("finalFunctionToolCallResult",a),this._chatCompletions.some(e=>e.usage)&&this._emit("totalUsage",q(this,Qt,"m",ss).call(this))}async _createChatCompletion(e,t,s){const n=null==s?void 0:s.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),q(this,Qt,"m",ns).call(this,t);const a=await e.chat.completions.create({...t,stream:!1},{...s,signal:this.controller.signal});return this._connected(),this._addChatCompletion(Rt(a,t))}async _runChatCompletion(e,t,s){for(const n of t.messages)this._addMessage(n,!1);return await this._createChatCompletion(e,t,s)}async _runTools(e,t,s){var n,a,o;const r="tool",{tool_choice:i="auto",stream:l,...c}=t,u="string"!=typeof i&&"function"===i.type&&(null==(n=null==i?void 0:i.function)?void 0:n.name),{maxChatCompletions:d=is}=s||{},h=t.tools.map(e=>{if(Ot(e)){if(!e.$callback)throw new V("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:e.$callback,name:e.function.name,description:e.function.description||"",parameters:e.function.parameters,parse:e.$parseRaw,strict:!0}}}return e}),p={};for(const v of h)"function"===v.type&&(p[v.function.name||v.function.function.name]=v.function);const f="tools"in t?h.map(e=>"function"===e.type?{type:"function",function:{name:e.function.name||e.function.function.name,parameters:e.function.parameters,description:e.function.description,strict:e.function.strict}}:e):void 0;for(const v of t.messages)this._addMessage(v,!1);for(let v=0;v<d;++v){const t=null==(a=(await this._createChatCompletion(e,{...c,tool_choice:i,tools:f,messages:[...this.messages]},s)).choices[0])?void 0:a.message;if(!t)throw new V("missing message in ChatCompletion response");if(!(null==(o=t.tool_calls)?void 0:o.length))return;for(const e of t.tool_calls){if("function"!==e.type)continue;const t=e.id,{name:s,arguments:n}=e.function,a=p[s];if(!a){const e=`Invalid tool_call: ${JSON.stringify(s)}. Available options are: ${Object.keys(p).map(e=>JSON.stringify(e)).join(", ")}. Please try again`;this._addMessage({role:r,tool_call_id:t,content:e});continue}if(u&&u!==s){const e=`Invalid tool_call: ${JSON.stringify(s)}. ${JSON.stringify(u)} requested. Please try again`;this._addMessage({role:r,tool_call_id:t,content:e});continue}let o;try{o=rs(a)?await a.parse(n):n}catch(m){const e=m instanceof Error?m.message:String(m);this._addMessage({role:r,tool_call_id:t,content:e});continue}const i=await a.function(o,this),l=q(this,Qt,"m",as).call(this,i);if(this._addMessage({role:r,tool_call_id:t,content:l}),u)return}}}}Qt=new WeakSet,Yt=function(){return q(this,Qt,"m",Zt).call(this).content??null},Zt=function(){let e=this.messages.length;for(;e-- >0;){const t=this.messages[e];if(Lt(t)){return{...t,content:t.content??null,refusal:t.refusal??null}}}throw new V("stream ended without producing a ChatCompletionMessage with role=assistant")},es=function(){var e,t;for(let s=this.messages.length-1;s>=0;s--){const n=this.messages[s];if(Lt(n)&&(null==(e=null==n?void 0:n.tool_calls)?void 0:e.length))return null==(t=n.tool_calls.filter(e=>"function"===e.type).at(-1))?void 0:t.function}},ts=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(Ut(t)&&null!=t.content&&"string"==typeof t.content&&this.messages.some(e=>{var s;return"assistant"===e.role&&(null==(s=e.tool_calls)?void 0:s.some(e=>"function"===e.type&&e.id===t.tool_call_id))}))return t.content}},ss=function(){const e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(const{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},ns=function(e){if(null!=e.n&&e.n>1)throw new V("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},as=function(e){return"string"==typeof e?e:void 0===e?"undefined":JSON.stringify(e)};class cs extends ls{static runTools(e,t,s){const n=new cs,a={...s,headers:{...null==s?void 0:s.headers,"X-Stainless-Helper-Method":"runTools"}};return n._run(()=>n._runTools(e,t,a)),n}_addMessage(e,t=!0){super._addMessage(e,t),Lt(e)&&e.content&&this._emit("content",e.content)}}const us=1,ds=2,hs=4,ps=8,fs=16,ms=32,vs=64,gs=128,ys=256,bs=511;class ws extends Error{}class _s extends Error{}const ks=(e,t)=>{const s=e.length;let n=0;const a=e=>{throw new ws(`${e} at position ${n}`)},o=e=>{throw new _s(`${e} at position ${n}`)},r=()=>(d(),n>=s&&a("Unexpected end of input"),'"'===e[n]?i():"{"===e[n]?l():"["===e[n]?c():"null"===e.substring(n,n+4)||fs&t&&s-n<4&&"null".startsWith(e.substring(n))?(n+=4,null):"true"===e.substring(n,n+4)||ms&t&&s-n<4&&"true".startsWith(e.substring(n))?(n+=4,!0):"false"===e.substring(n,n+5)||ms&t&&s-n<5&&"false".startsWith(e.substring(n))?(n+=5,!1):"Infinity"===e.substring(n,n+8)||gs&t&&s-n<8&&"Infinity".startsWith(e.substring(n))?(n+=8,1/0):"-Infinity"===e.substring(n,n+9)||ys&t&&1<s-n&&s-n<9&&"-Infinity".startsWith(e.substring(n))?(n+=9,-1/0):"NaN"===e.substring(n,n+3)||vs&t&&s-n<3&&"NaN".startsWith(e.substring(n))?(n+=3,NaN):u()),i=()=>{const r=n;let i=!1;for(n++;n<s&&('"'!==e[n]||i&&"\\"===e[n-1]);)i="\\"===e[n]&&!i,n++;if('"'==e.charAt(n))try{return JSON.parse(e.substring(r,++n-Number(i)))}catch(l){o(String(l))}else if(us&t)try{return JSON.parse(e.substring(r,n-Number(i))+'"')}catch(l){return JSON.parse(e.substring(r,e.lastIndexOf("\\"))+'"')}a("Unterminated string literal")},l=()=>{n++,d();const o={};try{for(;"}"!==e[n];){if(d(),n>=s&&ps&t)return o;const a=i();d(),n++;try{const e=r();Object.defineProperty(o,a,{value:e,writable:!0,enumerable:!0,configurable:!0})}catch(l){if(ps&t)return o;throw l}d(),","===e[n]&&n++}}catch(l){if(ps&t)return o;a("Expected '}' at end of object")}return n++,o},c=()=>{n++;const s=[];try{for(;"]"!==e[n];)s.push(r()),d(),","===e[n]&&n++}catch(o){if(hs&t)return s;a("Expected ']' at end of array")}return n++,s},u=()=>{if(0===n){"-"===e&&ds&t&&a("Not sure what '-' is");try{return JSON.parse(e)}catch(i){if(ds&t)try{return"."===e[e.length-1]?JSON.parse(e.substring(0,e.lastIndexOf("."))):JSON.parse(e.substring(0,e.lastIndexOf("e")))}catch(l){}o(String(i))}}const r=n;for("-"===e[n]&&n++;e[n]&&!",]}".includes(e[n]);)n++;n!=s||ds&t||a("Unterminated number literal");try{return JSON.parse(e.substring(r,n))}catch(i){"-"===e.substring(r,n)&&ds&t&&a("Not sure what '-' is");try{return JSON.parse(e.substring(r,e.lastIndexOf("e")))}catch(l){o(String(l))}}},d=()=>{for(;n<s&&" \n\r\t".includes(e[n]);)n++};return r()},xs=e=>function(e,t=bs){if("string"!=typeof e)throw new TypeError("expecting str, got "+typeof e);if(!e.trim())throw new Error(`${e} is empty`);return ks(e.trim(),t)}(e,bs^ds);var Cs,As,Ss,Is,$s,Ts,Os,Rs,Ps,Es,Ds,js;class Ls extends ls{constructor(e){super(),Cs.add(this),As.set(this,void 0),Ss.set(this,void 0),Is.set(this,void 0),M(this,As,e),M(this,Ss,[])}get currentChatCompletionSnapshot(){return q(this,Is,"f")}static fromReadableStream(e){const t=new Ls(null);return t._run(()=>t._fromReadableStream(e)),t}static createChatCompletion(e,t,s){const n=new Ls(t);return n._run(()=>n._runChatCompletion(e,{...t,stream:!0},{...s,headers:{...null==s?void 0:s.headers,"X-Stainless-Helper-Method":"stream"}})),n}async _createChatCompletion(e,t,s){var n;super._createChatCompletion;const a=null==s?void 0:s.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort())),q(this,Cs,"m",$s).call(this);const o=await e.chat.completions.create({...t,stream:!0},{...s,signal:this.controller.signal});this._connected();for await(const r of o)q(this,Cs,"m",Os).call(this,r);if(null==(n=o.controller.signal)?void 0:n.aborted)throw new X;return this._addChatCompletion(q(this,Cs,"m",Es).call(this))}async _fromReadableStream(e,t){var s;const n=null==t?void 0:t.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),q(this,Cs,"m",$s).call(this),this._connected();const a=et.fromReadableStream(e,this.controller);let o;for await(const r of a)o&&o!==r.id&&this._addChatCompletion(q(this,Cs,"m",Es).call(this)),q(this,Cs,"m",Os).call(this,r),o=r.id;if(null==(s=a.controller.signal)?void 0:s.aborted)throw new X;return this._addChatCompletion(q(this,Cs,"m",Es).call(this))}[(As=new WeakMap,Ss=new WeakMap,Is=new WeakMap,Cs=new WeakSet,$s=function(){this.ended||M(this,Is,void 0)},Ts=function(e){let t=q(this,Ss,"f")[e.index];return t||(t={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},q(this,Ss,"f")[e.index]=t,t)},Os=function(e){var t,s,n,a,o,r,i,l,c,u,d,h,p,f,m;if(this.ended)return;const v=q(this,Cs,"m",js).call(this,e);this._emit("chunk",e,v);for(const g of e.choices){const e=v.choices[g.index];null!=g.delta.content&&"assistant"===(null==(t=e.message)?void 0:t.role)&&(null==(s=e.message)?void 0:s.content)&&(this._emit("content",g.delta.content,e.message.content),this._emit("content.delta",{delta:g.delta.content,snapshot:e.message.content,parsed:e.message.parsed})),null!=g.delta.refusal&&"assistant"===(null==(n=e.message)?void 0:n.role)&&(null==(a=e.message)?void 0:a.refusal)&&this._emit("refusal.delta",{delta:g.delta.refusal,snapshot:e.message.refusal}),null!=(null==(o=g.logprobs)?void 0:o.content)&&"assistant"===(null==(r=e.message)?void 0:r.role)&&this._emit("logprobs.content.delta",{content:null==(i=g.logprobs)?void 0:i.content,snapshot:(null==(l=e.logprobs)?void 0:l.content)??[]}),null!=(null==(c=g.logprobs)?void 0:c.refusal)&&"assistant"===(null==(u=e.message)?void 0:u.role)&&this._emit("logprobs.refusal.delta",{refusal:null==(d=g.logprobs)?void 0:d.refusal,snapshot:(null==(h=e.logprobs)?void 0:h.refusal)??[]});const y=q(this,Cs,"m",Ts).call(this,e);e.finish_reason&&(q(this,Cs,"m",Ps).call(this,e),null!=y.current_tool_call_index&&q(this,Cs,"m",Rs).call(this,e,y.current_tool_call_index));for(const t of g.delta.tool_calls??[])y.current_tool_call_index!==t.index&&(q(this,Cs,"m",Ps).call(this,e),null!=y.current_tool_call_index&&q(this,Cs,"m",Rs).call(this,e,y.current_tool_call_index)),y.current_tool_call_index=t.index;for(const t of g.delta.tool_calls??[]){const s=null==(p=e.message.tool_calls)?void 0:p[t.index];(null==s?void 0:s.type)&&("function"===(null==s?void 0:s.type)?this._emit("tool_calls.function.arguments.delta",{name:null==(f=s.function)?void 0:f.name,index:t.index,arguments:s.function.arguments,parsed_arguments:s.function.parsed_arguments,arguments_delta:(null==(m=t.function)?void 0:m.arguments)??""}):Ms(null==s?void 0:s.type))}}},Rs=function(e,t){var s,n,a;if(q(this,Cs,"m",Ts).call(this,e).done_tool_calls.has(t))return;const o=null==(s=e.message.tool_calls)?void 0:s[t];if(!o)throw new Error("no tool call snapshot");if(!o.type)throw new Error("tool call snapshot missing `type`");if("function"===o.type){const e=null==(a=null==(n=q(this,As,"f"))?void 0:n.tools)?void 0:a.find(e=>$t(e)&&e.function.name===o.function.name);this._emit("tool_calls.function.arguments.done",{name:o.function.name,index:t,arguments:o.function.arguments,parsed_arguments:Ot(e)?e.$parseRaw(o.function.arguments):(null==e?void 0:e.function.strict)?JSON.parse(o.function.arguments):null})}else o.type},Ps=function(e){var t,s;const n=q(this,Cs,"m",Ts).call(this,e);if(e.message.content&&!n.content_done){n.content_done=!0;const t=q(this,Cs,"m",Ds).call(this);this._emit("content.done",{content:e.message.content,parsed:t?t.$parseRaw(e.message.content):null})}e.message.refusal&&!n.refusal_done&&(n.refusal_done=!0,this._emit("refusal.done",{refusal:e.message.refusal})),(null==(t=e.logprobs)?void 0:t.content)&&!n.logprobs_content_done&&(n.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:e.logprobs.content})),(null==(s=e.logprobs)?void 0:s.refusal)&&!n.logprobs_refusal_done&&(n.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:e.logprobs.refusal}))},Es=function(){if(this.ended)throw new V("stream has ended, this shouldn't happen");const e=q(this,Is,"f");if(!e)throw new V("request ended without sending any chunks");return M(this,Is,void 0),M(this,Ss,[]),function(e,t){const{id:s,choices:n,created:a,model:o,system_fingerprint:r,...i}=e,l={...i,id:s,choices:n.map(({message:t,finish_reason:s,index:n,logprobs:a,...o})=>{if(!s)throw new V(`missing finish_reason for choice ${n}`);const{content:r=null,function_call:i,tool_calls:l,...c}=t,u=t.role;if(!u)throw new V(`missing role for choice ${n}`);if(i){const{arguments:e,name:l}=i;if(null==e)throw new V(`missing function_call.arguments for choice ${n}`);if(!l)throw new V(`missing function_call.name for choice ${n}`);return{...o,message:{content:r,function_call:{arguments:e,name:l},role:u,refusal:t.refusal??null},finish_reason:s,index:n,logprobs:a}}return l?{...o,index:n,finish_reason:s,logprobs:a,message:{...c,role:u,content:r,refusal:t.refusal??null,tool_calls:l.map((t,s)=>{const{function:a,type:o,id:r,...i}=t,{arguments:l,name:c,...u}=a||{};if(null==r)throw new V(`missing choices[${n}].tool_calls[${s}].id\n${Us(e)}`);if(null==o)throw new V(`missing choices[${n}].tool_calls[${s}].type\n${Us(e)}`);if(null==c)throw new V(`missing choices[${n}].tool_calls[${s}].function.name\n${Us(e)}`);if(null==l)throw new V(`missing choices[${n}].tool_calls[${s}].function.arguments\n${Us(e)}`);return{...i,id:r,type:o,function:{...u,name:c,arguments:l}}})}}:{...o,message:{...c,content:r,role:u,refusal:t.refusal??null},finish_reason:s,index:n,logprobs:a}}),created:a,model:o,object:"chat.completion",...r?{system_fingerprint:r}:{}};return function(e,t){return t&&Dt(t)?Rt(e,t):{...e,choices:e.choices.map(e=>(jt(e.message.tool_calls),{...e,message:{...e.message,parsed:null,...e.message.tool_calls?{tool_calls:e.message.tool_calls}:void 0}}))}}(l,t)}(e,q(this,As,"f"))},Ds=function(){var e;const t=null==(e=q(this,As,"f"))?void 0:e.response_format;return Tt(t)?t:null},js=function(e){var t,s,n,a;let o=q(this,Is,"f");const{choices:r,...i}=e;o?Object.assign(o,i):o=M(this,Is,{...i,choices:[]});for(const{delta:l,finish_reason:c,index:u,logprobs:d=null,...h}of e.choices){let e=o.choices[u];if(e||(e=o.choices[u]={finish_reason:c,index:u,message:{},logprobs:d,...h}),d)if(e.logprobs){const{content:n,refusal:a,...o}=d;Object.assign(e.logprobs,o),n&&((t=e.logprobs).content??(t.content=[]),e.logprobs.content.push(...n)),a&&((s=e.logprobs).refusal??(s.refusal=[]),e.logprobs.refusal.push(...a))}else e.logprobs=Object.assign({},d);if(c&&(e.finish_reason=c,q(this,As,"f")&&Dt(q(this,As,"f")))){if("length"===c)throw new se;if("content_filter"===c)throw new ne}if(Object.assign(e,h),!l)continue;const{content:r,refusal:i,function_call:p,role:f,tool_calls:m,...v}=l;if(Object.assign(e.message,v),i&&(e.message.refusal=(e.message.refusal||"")+i),f&&(e.message.role=f),p&&(e.message.function_call?(p.name&&(e.message.function_call.name=p.name),p.arguments&&((n=e.message.function_call).arguments??(n.arguments=""),e.message.function_call.arguments+=p.arguments)):e.message.function_call=p),r&&(e.message.content=(e.message.content||"")+r,!e.message.refusal&&q(this,Cs,"m",Ds).call(this)&&(e.message.parsed=xs(e.message.content))),m){e.message.tool_calls||(e.message.tool_calls=[]);for(const{index:t,id:s,type:n,function:o,...r}of m){const i=(a=e.message.tool_calls)[t]??(a[t]={});Object.assign(i,r),s&&(i.id=s),n&&(i.type=n),o&&(i.function??(i.function={name:o.name??"",arguments:""})),(null==o?void 0:o.name)&&(i.function.name=o.name),(null==o?void 0:o.arguments)&&(i.function.arguments+=o.arguments,Et(q(this,As,"f"),i)&&(i.function.parsed_arguments=xs(i.function.arguments)))}}}return o},Symbol.asyncIterator)](){const e=[],t=[];let s=!1;return this.on("chunk",s=>{const n=t.shift();n?n.resolve(s):e.push(s)}),this.on("end",()=>{s=!0;for(const e of t)e.resolve(void 0);t.length=0}),this.on("abort",e=>{s=!0;for(const s of t)s.reject(e);t.length=0}),this.on("error",e=>{s=!0;for(const s of t)s.reject(e);t.length=0}),{next:async()=>{if(!e.length)return s?{value:void 0,done:!0}:new Promise((e,s)=>t.push({resolve:e,reject:s})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0});return{value:e.shift(),done:!1}},return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new et(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function Us(e){return JSON.stringify(e)}function Ms(e){}class qs extends Ls{static fromReadableStream(e){const t=new qs(null);return t._run(()=>t._fromReadableStream(e)),t}static runTools(e,t,s){const n=new qs(t),a={...s,headers:{...null==s?void 0:s.headers,"X-Stainless-Helper-Method":"runTools"}};return n._run(()=>n._runTools(e,t,a)),n}}let Ns=class extends xt{constructor(){super(...arguments),this.messages=new It(this._client)}create(e,t){return this._client.post("/chat/completions",{body:e,...t,stream:e.stream??!1})}retrieve(e,t){return this._client.get(St`/chat/completions/${e}`,t)}update(e,t,s){return this._client.post(St`/chat/completions/${e}`,{body:t,...s})}list(e={},t){return this._client.getAPIList("/chat/completions",lt,{query:e,...t})}delete(e,t){return this._client.delete(St`/chat/completions/${e}`,t)}parse(e,t){return function(e){for(const t of e??[]){if("function"!==t.type)throw new V(`Currently only \`function\` tool types support auto-parsing; Received \`${t.type}\``);if(!0!==t.function.strict)throw new V(`The \`${t.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}(e.tools),this._client.chat.completions.create(e,{...t,headers:{...null==t?void 0:t.headers,"X-Stainless-Helper-Method":"chat.completions.parse"}})._thenUnwrap(t=>Rt(t,e))}runTools(e,t){return e.stream?qs.runTools(this._client,e,t):cs.runTools(this._client,e,t)}stream(e,t){return Ls.createChatCompletion(this._client,e,t)}};Ns.Messages=It;class Bs extends xt{constructor(){super(...arguments),this.completions=new Ns(this._client)}}Bs.Completions=Ns;const Ws=Symbol("brand.privateNullableHeaders");function*Vs(e){if(!e)return;if(Ws in e){const{values:t,nulls:s}=e;yield*t.entries();for(const e of s)yield[e,null];return}let t,s=!1;e instanceof Headers?t=e.entries():ie(e)?t=e:(s=!0,t=Object.entries(e??{}));for(let n of t){const e=n[0];if("string"!=typeof e)throw new TypeError("expected header name to be a string");const t=ie(n[1])?n[1]:[n[1]];let a=!1;for(const n of t)void 0!==n&&(s&&!a&&(a=!0,yield[e,null]),yield[e,n])}}const Fs=e=>{const t=new Headers,s=new Set;for(const n of e){const e=new Set;for(const[a,o]of Vs(n)){const n=a.toLowerCase();e.has(n)||(t.delete(a),e.add(n)),null===o?(t.delete(a),s.add(n)):(t.append(a,o),s.delete(n))}}return{[Ws]:!0,values:t,nulls:s}};class Xs extends xt{create(e,t){return this._client.post("/audio/speech",{body:e,...t,headers:Fs([{Accept:"application/octet-stream"},null==t?void 0:t.headers]),__binaryResponse:!0})}}class zs extends xt{create(e,t){return this._client.post("/audio/transcriptions",mt({body:e,...t,stream:e.stream??!1,__metadata:{model:e.model}},this._client))}}class Hs extends xt{create(e,t){return this._client.post("/audio/translations",mt({body:e,...t,__metadata:{model:e.model}},this._client))}}class Js extends xt{constructor(){super(...arguments),this.transcriptions=new zs(this._client),this.translations=new Hs(this._client),this.speech=new Xs(this._client)}}Js.Transcriptions=zs,Js.Translations=Hs,Js.Speech=Xs;class Ks extends xt{create(e,t){return this._client.post("/batches",{body:e,...t})}retrieve(e,t){return this._client.get(St`/batches/${e}`,t)}list(e={},t){return this._client.getAPIList("/batches",lt,{query:e,...t})}cancel(e,t){return this._client.post(St`/batches/${e}/cancel`,t)}}class Gs extends xt{create(e,t){return this._client.post("/assistants",{body:e,...t,headers:Fs([{"OpenAI-Beta":"assistants=v2"},null==t?void 0:t.headers])})}retrieve(e,t){return this._client.get(St`/assistants/${e}`,{...t,headers:Fs([{"OpenAI-Beta":"assistants=v2"},null==t?void 0:t.headers])})}update(e,t,s){return this._client.post(St`/assistants/${e}`,{body:t,...s,headers:Fs([{"OpenAI-Beta":"assistants=v2"},null==s?void 0:s.headers])})}list(e={},t){return this._client.getAPIList("/assistants",lt,{query:e,...t,headers:Fs([{"OpenAI-Beta":"assistants=v2"},null==t?void 0:t.headers])})}delete(e,t){return this._client.delete(St`/assistants/${e}`,{...t,headers:Fs([{"OpenAI-Beta":"assistants=v2"},null==t?void 0:t.headers])})}}let Qs=class extends xt{create(e,t){return this._client.post("/realtime/sessions",{body:e,...t,headers:Fs([{"OpenAI-Beta":"assistants=v2"},null==t?void 0:t.headers])})}};class Ys extends xt{create(e,t){return this._client.post("/realtime/transcription_sessions",{body:e,...t,headers:Fs([{"OpenAI-Beta":"assistants=v2"},null==t?void 0:t.headers])})}}let Zs=class extends xt{constructor(){super(...arguments),this.sessions=new Qs(this._client),this.transcriptionSessions=new Ys(this._client)}};Zs.Sessions=Qs,Zs.TranscriptionSessions=Ys;class en extends xt{create(e,t){return this._client.post("/chatkit/sessions",{body:e,...t,headers:Fs([{"OpenAI-Beta":"chatkit_beta=v1"},null==t?void 0:t.headers])})}cancel(e,t){return this._client.post(St`/chatkit/sessions/${e}/cancel`,{...t,headers:Fs([{"OpenAI-Beta":"chatkit_beta=v1"},null==t?void 0:t.headers])})}}let tn=class extends xt{retrieve(e,t){return this._client.get(St`/chatkit/threads/${e}`,{...t,headers:Fs([{"OpenAI-Beta":"chatkit_beta=v1"},null==t?void 0:t.headers])})}list(e={},t){return this._client.getAPIList("/chatkit/threads",ct,{query:e,...t,headers:Fs([{"OpenAI-Beta":"chatkit_beta=v1"},null==t?void 0:t.headers])})}delete(e,t){return this._client.delete(St`/chatkit/threads/${e}`,{...t,headers:Fs([{"OpenAI-Beta":"chatkit_beta=v1"},null==t?void 0:t.headers])})}listItems(e,t={},s){return this._client.getAPIList(St`/chatkit/threads/${e}/items`,ct,{query:t,...s,headers:Fs([{"OpenAI-Beta":"chatkit_beta=v1"},null==s?void 0:s.headers])})}};class sn extends xt{constructor(){super(...arguments),this.sessions=new en(this._client),this.threads=new tn(this._client)}}sn.Sessions=en,sn.Threads=tn;class nn extends xt{create(e,t,s){return this._client.post(St`/threads/${e}/messages`,{body:t,...s,headers:Fs([{"OpenAI-Beta":"assistants=v2"},null==s?void 0:s.headers])})}retrieve(e,t,s){const{thread_id:n}=t;return this._client.get(St`/threads/${n}/messages/${e}`,{...s,headers:Fs([{"OpenAI-Beta":"assistants=v2"},null==s?void 0:s.headers])})}update(e,t,s){const{thread_id:n,...a}=t;return this._client.post(St`/threads/${n}/messages/${e}`,{body:a,...s,headers:Fs([{"OpenAI-Beta":"assistants=v2"},null==s?void 0:s.headers])})}list(e,t={},s){return this._client.getAPIList(St`/threads/${e}/messages`,lt,{query:t,...s,headers:Fs([{"OpenAI-Beta":"assistants=v2"},null==s?void 0:s.headers])})}delete(e,t,s){const{thread_id:n}=t;return this._client.delete(St`/threads/${n}/messages/${e}`,{...s,headers:Fs([{"OpenAI-Beta":"assistants=v2"},null==s?void 0:s.headers])})}}class an extends xt{retrieve(e,t,s){const{thread_id:n,run_id:a,...o}=t;return this._client.get(St`/threads/${n}/runs/${a}/steps/${e}`,{query:o,...s,headers:Fs([{"OpenAI-Beta":"assistants=v2"},null==s?void 0:s.headers])})}list(e,t,s){const{thread_id:n,...a}=t;return this._client.getAPIList(St`/threads/${n}/runs/${e}/steps`,lt,{query:a,...s,headers:Fs([{"OpenAI-Beta":"assistants=v2"},null==s?void 0:s.headers])})}}var on={};const rn=e=>{var t,s,n,a;return void 0!==globalThis.process?(null==(t=null==on?void 0:on[e])?void 0:t.trim())??void 0:void 0!==globalThis.Deno?null==(a=null==(n=null==(s=globalThis.Deno.env)?void 0:s.get)?void 0:n.call(s,e))?void 0:a.trim():void 0};var ln,cn,un,dn,hn,pn,fn,mn,vn,gn,yn,bn,wn,_n,kn,xn,Cn,An,Sn,In,$n,Tn,On;class Rn extends os{constructor(){super(...arguments),ln.add(this),un.set(this,[]),dn.set(this,{}),hn.set(this,{}),pn.set(this,void 0),fn.set(this,void 0),mn.set(this,void 0),vn.set(this,void 0),gn.set(this,void 0),yn.set(this,void 0),bn.set(this,void 0),wn.set(this,void 0),_n.set(this,void 0)}[(un=new WeakMap,dn=new WeakMap,hn=new WeakMap,pn=new WeakMap,fn=new WeakMap,mn=new WeakMap,vn=new WeakMap,gn=new WeakMap,yn=new WeakMap,bn=new WeakMap,wn=new WeakMap,_n=new WeakMap,ln=new WeakSet,Symbol.asyncIterator)](){const e=[],t=[];let s=!1;return this.on("event",s=>{const n=t.shift();n?n.resolve(s):e.push(s)}),this.on("end",()=>{s=!0;for(const e of t)e.resolve(void 0);t.length=0}),this.on("abort",e=>{s=!0;for(const s of t)s.reject(e);t.length=0}),this.on("error",e=>{s=!0;for(const s of t)s.reject(e);t.length=0}),{next:async()=>{if(!e.length)return s?{value:void 0,done:!0}:new Promise((e,s)=>t.push({resolve:e,reject:s})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0});return{value:e.shift(),done:!1}},return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){const t=new cn;return t._run(()=>t._fromReadableStream(e)),t}async _fromReadableStream(e,t){var s;const n=null==t?void 0:t.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),this._connected();const a=et.fromReadableStream(e,this.controller);for await(const o of a)q(this,ln,"m",kn).call(this,o);if(null==(s=a.controller.signal)?void 0:s.aborted)throw new X;return this._addRun(q(this,ln,"m",xn).call(this))}toReadableStream(){return new et(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,s,n){const a=new cn;return a._run(()=>a._runToolAssistantStream(e,t,s,{...n,headers:{...null==n?void 0:n.headers,"X-Stainless-Helper-Method":"stream"}})),a}async _createToolAssistantStream(e,t,s,n){var a;const o=null==n?void 0:n.signal;o&&(o.aborted&&this.controller.abort(),o.addEventListener("abort",()=>this.controller.abort()));const r={...s,stream:!0},i=await e.submitToolOutputs(t,r,{...n,signal:this.controller.signal});this._connected();for await(const l of i)q(this,ln,"m",kn).call(this,l);if(null==(a=i.controller.signal)?void 0:a.aborted)throw new X;return this._addRun(q(this,ln,"m",xn).call(this))}static createThreadAssistantStream(e,t,s){const n=new cn;return n._run(()=>n._threadAssistantStream(e,t,{...s,headers:{...null==s?void 0:s.headers,"X-Stainless-Helper-Method":"stream"}})),n}static createAssistantStream(e,t,s,n){const a=new cn;return a._run(()=>a._runAssistantStream(e,t,s,{...n,headers:{...null==n?void 0:n.headers,"X-Stainless-Helper-Method":"stream"}})),a}currentEvent(){return q(this,bn,"f")}currentRun(){return q(this,wn,"f")}currentMessageSnapshot(){return q(this,pn,"f")}currentRunStepSnapshot(){return q(this,_n,"f")}async finalRunSteps(){return await this.done(),Object.values(q(this,dn,"f"))}async finalMessages(){return await this.done(),Object.values(q(this,hn,"f"))}async finalRun(){if(await this.done(),!q(this,fn,"f"))throw Error("Final run was not received.");return q(this,fn,"f")}async _createThreadAssistantStream(e,t,s){var n;const a=null==s?void 0:s.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort()));const o={...t,stream:!0},r=await e.createAndRun(o,{...s,signal:this.controller.signal});this._connected();for await(const i of r)q(this,ln,"m",kn).call(this,i);if(null==(n=r.controller.signal)?void 0:n.aborted)throw new X;return this._addRun(q(this,ln,"m",xn).call(this))}async _createAssistantStream(e,t,s,n){var a;const o=null==n?void 0:n.signal;o&&(o.aborted&&this.controller.abort(),o.addEventListener("abort",()=>this.controller.abort()));const r={...s,stream:!0},i=await e.create(t,r,{...n,signal:this.controller.signal});this._connected();for await(const l of i)q(this,ln,"m",kn).call(this,l);if(null==(a=i.controller.signal)?void 0:a.aborted)throw new X;return this._addRun(q(this,ln,"m",xn).call(this))}static accumulateDelta(e,t){for(const[s,n]of Object.entries(t)){if(!e.hasOwnProperty(s)){e[s]=n;continue}let t=e[s];if(null!=t)if("index"!==s&&"type"!==s){if("string"==typeof t&&"string"==typeof n)t+=n;else if("number"==typeof t&&"number"==typeof n)t+=n;else{if(!ce(t)||!ce(n)){if(Array.isArray(t)&&Array.isArray(n)){if(t.every(e=>"string"==typeof e||"number"==typeof e)){t.push(...n);continue}for(const e of n){if(!ce(e))throw new Error(`Expected array delta entry to be an object but got: ${e}`);const s=e.index;if(null==s)throw new Error("Expected array delta entry to have an `index` property");if("number"!=typeof s)throw new Error(`Expected array delta entry \`index\` property to be a number but got ${s}`);const n=t[s];null==n?t.push(e):t[s]=this.accumulateDelta(n,e)}continue}throw Error(`Unhandled record type: ${s}, deltaValue: ${n}, accValue: ${t}`)}t=this.accumulateDelta(t,n)}e[s]=t}else e[s]=n;else e[s]=n}return e}_addRun(e){return e}async _threadAssistantStream(e,t,s){return await this._createThreadAssistantStream(t,e,s)}async _runAssistantStream(e,t,s,n){return await this._createAssistantStream(t,e,s,n)}async _runToolAssistantStream(e,t,s,n){return await this._createToolAssistantStream(t,e,s,n)}}cn=Rn,kn=function(e){if(!this.ended)switch(M(this,bn,e),q(this,ln,"m",Sn).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.incomplete":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":q(this,ln,"m",On).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":q(this,ln,"m",An).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":q(this,ln,"m",Cn).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},xn=function(){if(this.ended)throw new V("stream has ended, this shouldn't happen");if(!q(this,fn,"f"))throw Error("Final run has not been received");return q(this,fn,"f")},Cn=function(e){const[t,s]=q(this,ln,"m",$n).call(this,e,q(this,pn,"f"));M(this,pn,t),q(this,hn,"f")[t.id]=t;for(const n of s){const e=t.content[n.index];"text"==(null==e?void 0:e.type)&&this._emit("textCreated",e.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,t),e.data.delta.content)for(const s of e.data.delta.content){if("text"==s.type&&s.text){let e=s.text,n=t.content[s.index];if(!n||"text"!=n.type)throw Error("The snapshot associated with this text delta is not text or missing");this._emit("textDelta",e,n.text)}if(s.index!=q(this,mn,"f")){if(q(this,vn,"f"))switch(q(this,vn,"f").type){case"text":this._emit("textDone",q(this,vn,"f").text,q(this,pn,"f"));break;case"image_file":this._emit("imageFileDone",q(this,vn,"f").image_file,q(this,pn,"f"))}M(this,mn,s.index)}M(this,vn,t.content[s.index])}break;case"thread.message.completed":case"thread.message.incomplete":if(void 0!==q(this,mn,"f")){const t=e.data.content[q(this,mn,"f")];if(t)switch(t.type){case"image_file":this._emit("imageFileDone",t.image_file,q(this,pn,"f"));break;case"text":this._emit("textDone",t.text,q(this,pn,"f"))}}q(this,pn,"f")&&this._emit("messageDone",e.data),M(this,pn,void 0)}},An=function(e){const t=q(this,ln,"m",In).call(this,e);switch(M(this,_n,t),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":const s=e.data.delta;if(s.step_details&&"tool_calls"==s.step_details.type&&s.step_details.tool_calls&&"tool_calls"==t.step_details.type)for(const e of s.step_details.tool_calls)e.index==q(this,gn,"f")?this._emit("toolCallDelta",e,t.step_details.tool_calls[e.index]):(q(this,yn,"f")&&this._emit("toolCallDone",q(this,yn,"f")),M(this,gn,e.index),M(this,yn,t.step_details.tool_calls[e.index]),q(this,yn,"f")&&this._emit("toolCallCreated",q(this,yn,"f")));this._emit("runStepDelta",e.data.delta,t);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":M(this,_n,void 0);"tool_calls"==e.data.step_details.type&&q(this,yn,"f")&&(this._emit("toolCallDone",q(this,yn,"f")),M(this,yn,void 0)),this._emit("runStepDone",e.data,t)}},Sn=function(e){q(this,un,"f").push(e),this._emit("event",e)},In=function(e){switch(e.event){case"thread.run.step.created":return q(this,dn,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let t=q(this,dn,"f")[e.data.id];if(!t)throw Error("Received a RunStepDelta before creation of a snapshot");let s=e.data;if(s.delta){const n=cn.accumulateDelta(t,s.delta);q(this,dn,"f")[e.data.id]=n}return q(this,dn,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":q(this,dn,"f")[e.data.id]=e.data}if(q(this,dn,"f")[e.data.id])return q(this,dn,"f")[e.data.id];throw new Error("No snapshot available")},$n=function(e,t){let s=[];switch(e.event){case"thread.message.created":return[e.data,s];case"thread.message.delta":if(!t)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let n=e.data;if(n.delta.content)for(const e of n.delta.content)if(e.index in t.content){let s=t.content[e.index];t.content[e.index]=q(this,ln,"m",Tn).call(this,e,s)}else t.content[e.index]=e,s.push(e);return[t,s];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(t)return[t,s];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},Tn=function(e,t){return cn.accumulateDelta(t,e)},On=function(e){switch(M(this,wn,e.data),e.event){case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":case"thread.run.incomplete":M(this,fn,e.data),q(this,yn,"f")&&(this._emit("toolCallDone",q(this,yn,"f")),M(this,yn,void 0))}};let Pn=class extends xt{constructor(){super(...arguments),this.steps=new an(this._client)}create(e,t,s){const{include:n,...a}=t;return this._client.post(St`/threads/${e}/runs`,{query:{include:n},body:a,...s,headers:Fs([{"OpenAI-Beta":"assistants=v2"},null==s?void 0:s.headers]),stream:t.stream??!1})}retrieve(e,t,s){const{thread_id:n}=t;return this._client.get(St`/threads/${n}/runs/${e}`,{...s,headers:Fs([{"OpenAI-Beta":"assistants=v2"},null==s?void 0:s.headers])})}update(e,t,s){const{thread_id:n,...a}=t;return this._client.post(St`/threads/${n}/runs/${e}`,{body:a,...s,headers:Fs([{"OpenAI-Beta":"assistants=v2"},null==s?void 0:s.headers])})}list(e,t={},s){return this._client.getAPIList(St`/threads/${e}/runs`,lt,{query:t,...s,headers:Fs([{"OpenAI-Beta":"assistants=v2"},null==s?void 0:s.headers])})}cancel(e,t,s){const{thread_id:n}=t;return this._client.post(St`/threads/${n}/runs/${e}/cancel`,{...s,headers:Fs([{"OpenAI-Beta":"assistants=v2"},null==s?void 0:s.headers])})}async createAndPoll(e,t,s){const n=await this.create(e,t,s);return await this.poll(n.id,{thread_id:e},s)}createAndStream(e,t,s){return Rn.createAssistantStream(e,this._client.beta.threads.runs,t,s)}async poll(e,t,s){var n;const a=Fs([null==s?void 0:s.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":(null==(n=null==s?void 0:s.pollIntervalMs)?void 0:n.toString())??void 0}]);for(;;){const{data:n,response:o}=await this.retrieve(e,t,{...s,headers:{...null==s?void 0:s.headers,...a}}).withResponse();switch(n.status){case"queued":case"in_progress":case"cancelling":let e=5e3;if(null==s?void 0:s.pollIntervalMs)e=s.pollIntervalMs;else{const t=o.headers.get("openai-poll-after-ms");if(t){const s=parseInt(t);isNaN(s)||(e=s)}}await ue(e);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return n}}}stream(e,t,s){return Rn.createAssistantStream(e,this._client.beta.threads.runs,t,s)}submitToolOutputs(e,t,s){const{thread_id:n,...a}=t;return this._client.post(St`/threads/${n}/runs/${e}/submit_tool_outputs`,{body:a,...s,headers:Fs([{"OpenAI-Beta":"assistants=v2"},null==s?void 0:s.headers]),stream:t.stream??!1})}async submitToolOutputsAndPoll(e,t,s){const n=await this.submitToolOutputs(e,t,s);return await this.poll(n.id,t,s)}submitToolOutputsStream(e,t,s){return Rn.createToolAssistantStream(e,this._client.beta.threads.runs,t,s)}};Pn.Steps=an;class En extends xt{constructor(){super(...arguments),this.runs=new Pn(this._client),this.messages=new nn(this._client)}create(e={},t){return this._client.post("/threads",{body:e,...t,headers:Fs([{"OpenAI-Beta":"assistants=v2"},null==t?void 0:t.headers])})}retrieve(e,t){return this._client.get(St`/threads/${e}`,{...t,headers:Fs([{"OpenAI-Beta":"assistants=v2"},null==t?void 0:t.headers])})}update(e,t,s){return this._client.post(St`/threads/${e}`,{body:t,...s,headers:Fs([{"OpenAI-Beta":"assistants=v2"},null==s?void 0:s.headers])})}delete(e,t){return this._client.delete(St`/threads/${e}`,{...t,headers:Fs([{"OpenAI-Beta":"assistants=v2"},null==t?void 0:t.headers])})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:Fs([{"OpenAI-Beta":"assistants=v2"},null==t?void 0:t.headers]),stream:e.stream??!1})}async createAndRunPoll(e,t){const s=await this.createAndRun(e,t);return await this.runs.poll(s.id,{thread_id:s.thread_id},t)}createAndRunStream(e,t){return Rn.createThreadAssistantStream(e,this._client.beta.threads,t)}}En.Runs=Pn,En.Messages=nn;class Dn extends xt{constructor(){super(...arguments),this.realtime=new Zs(this._client),this.chatkit=new sn(this._client),this.assistants=new Gs(this._client),this.threads=new En(this._client)}}Dn.Realtime=Zs,Dn.ChatKit=sn,Dn.Assistants=Gs,Dn.Threads=En;class jn extends xt{create(e,t){return this._client.post("/completions",{body:e,...t,stream:e.stream??!1})}}class Ln extends xt{retrieve(e,t,s){const{container_id:n}=t;return this._client.get(St`/containers/${n}/files/${e}/content`,{...s,headers:Fs([{Accept:"application/binary"},null==s?void 0:s.headers]),__binaryResponse:!0})}}let Un=class extends xt{constructor(){super(...arguments),this.content=new Ln(this._client)}create(e,t,s){return this._client.post(St`/containers/${e}/files`,mt({body:t,...s},this._client))}retrieve(e,t,s){const{container_id:n}=t;return this._client.get(St`/containers/${n}/files/${e}`,s)}list(e,t={},s){return this._client.getAPIList(St`/containers/${e}/files`,lt,{query:t,...s})}delete(e,t,s){const{container_id:n}=t;return this._client.delete(St`/containers/${n}/files/${e}`,{...s,headers:Fs([{Accept:"*/*"},null==s?void 0:s.headers])})}};Un.Content=Ln;class Mn extends xt{constructor(){super(...arguments),this.files=new Un(this._client)}create(e,t){return this._client.post("/containers",{body:e,...t})}retrieve(e,t){return this._client.get(St`/containers/${e}`,t)}list(e={},t){return this._client.getAPIList("/containers",lt,{query:e,...t})}delete(e,t){return this._client.delete(St`/containers/${e}`,{...t,headers:Fs([{Accept:"*/*"},null==t?void 0:t.headers])})}}Mn.Files=Un;class qn extends xt{create(e,t,s){const{include:n,...a}=t;return this._client.post(St`/conversations/${e}/items`,{query:{include:n},body:a,...s})}retrieve(e,t,s){const{conversation_id:n,...a}=t;return this._client.get(St`/conversations/${n}/items/${e}`,{query:a,...s})}list(e,t={},s){return this._client.getAPIList(St`/conversations/${e}/items`,ct,{query:t,...s})}delete(e,t,s){const{conversation_id:n}=t;return this._client.delete(St`/conversations/${n}/items/${e}`,s)}}class Nn extends xt{constructor(){super(...arguments),this.items=new qn(this._client)}create(e={},t){return this._client.post("/conversations",{body:e,...t})}retrieve(e,t){return this._client.get(St`/conversations/${e}`,t)}update(e,t,s){return this._client.post(St`/conversations/${e}`,{body:t,...s})}delete(e,t){return this._client.delete(St`/conversations/${e}`,t)}}Nn.Items=qn;class Bn extends xt{create(e,t){const s=!!e.encoding_format;let n=s?e.encoding_format:"base64";s&&Ke(this._client).debug("embeddings/user defined encoding_format:",e.encoding_format);const a=this._client.post("/embeddings",{body:{...e,encoding_format:n},...t});return s?a:(Ke(this._client).debug("embeddings/decoding base64 embeddings from base64"),a._thenUnwrap(e=>(e&&e.data&&e.data.forEach(e=>{const t=e.embedding;e.embedding=(e=>{if("undefined"!=typeof Buffer){const t=Buffer.from(e,"base64");return Array.from(new Float32Array(t.buffer,t.byteOffset,t.length/Float32Array.BYTES_PER_ELEMENT))}{const t=atob(e),s=t.length,n=new Uint8Array(s);for(let e=0;e<s;e++)n[e]=t.charCodeAt(e);return Array.from(new Float32Array(n.buffer))}})(t)}),e)))}}class Wn extends xt{retrieve(e,t,s){const{eval_id:n,run_id:a}=t;return this._client.get(St`/evals/${n}/runs/${a}/output_items/${e}`,s)}list(e,t,s){const{eval_id:n,...a}=t;return this._client.getAPIList(St`/evals/${n}/runs/${e}/output_items`,lt,{query:a,...s})}}class Vn extends xt{constructor(){super(...arguments),this.outputItems=new Wn(this._client)}create(e,t,s){return this._client.post(St`/evals/${e}/runs`,{body:t,...s})}retrieve(e,t,s){const{eval_id:n}=t;return this._client.get(St`/evals/${n}/runs/${e}`,s)}list(e,t={},s){return this._client.getAPIList(St`/evals/${e}/runs`,lt,{query:t,...s})}delete(e,t,s){const{eval_id:n}=t;return this._client.delete(St`/evals/${n}/runs/${e}`,s)}cancel(e,t,s){const{eval_id:n}=t;return this._client.post(St`/evals/${n}/runs/${e}`,s)}}Vn.OutputItems=Wn;class Fn extends xt{constructor(){super(...arguments),this.runs=new Vn(this._client)}create(e,t){return this._client.post("/evals",{body:e,...t})}retrieve(e,t){return this._client.get(St`/evals/${e}`,t)}update(e,t,s){return this._client.post(St`/evals/${e}`,{body:t,...s})}list(e={},t){return this._client.getAPIList("/evals",lt,{query:e,...t})}delete(e,t){return this._client.delete(St`/evals/${e}`,t)}}Fn.Runs=Vn;let Xn=class extends xt{create(e,t){return this._client.post("/files",mt({body:e,...t},this._client))}retrieve(e,t){return this._client.get(St`/files/${e}`,t)}list(e={},t){return this._client.getAPIList("/files",lt,{query:e,...t})}delete(e,t){return this._client.delete(St`/files/${e}`,t)}content(e,t){return this._client.get(St`/files/${e}/content`,{...t,headers:Fs([{Accept:"application/binary"},null==t?void 0:t.headers]),__binaryResponse:!0})}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:s=18e5}={}){const n=new Set(["processed","error","deleted"]),a=Date.now();let o=await this.retrieve(e);for(;!o.status||!n.has(o.status);)if(await ue(t),o=await this.retrieve(e),Date.now()-a>s)throw new H({message:`Giving up on waiting for file ${e} to finish processing after ${s} milliseconds.`});return o}};class zn extends xt{}let Hn=class extends xt{run(e,t){return this._client.post("/fine_tuning/alpha/graders/run",{body:e,...t})}validate(e,t){return this._client.post("/fine_tuning/alpha/graders/validate",{body:e,...t})}};class Jn extends xt{constructor(){super(...arguments),this.graders=new Hn(this._client)}}Jn.Graders=Hn;class Kn extends xt{create(e,t,s){return this._client.getAPIList(St`/fine_tuning/checkpoints/${e}/permissions`,it,{body:t,method:"post",...s})}retrieve(e,t={},s){return this._client.get(St`/fine_tuning/checkpoints/${e}/permissions`,{query:t,...s})}delete(e,t,s){const{fine_tuned_model_checkpoint:n}=t;return this._client.delete(St`/fine_tuning/checkpoints/${n}/permissions/${e}`,s)}}let Gn=class extends xt{constructor(){super(...arguments),this.permissions=new Kn(this._client)}};Gn.Permissions=Kn;class Qn extends xt{list(e,t={},s){return this._client.getAPIList(St`/fine_tuning/jobs/${e}/checkpoints`,lt,{query:t,...s})}}class Yn extends xt{constructor(){super(...arguments),this.checkpoints=new Qn(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(St`/fine_tuning/jobs/${e}`,t)}list(e={},t){return this._client.getAPIList("/fine_tuning/jobs",lt,{query:e,...t})}cancel(e,t){return this._client.post(St`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},s){return this._client.getAPIList(St`/fine_tuning/jobs/${e}/events`,lt,{query:t,...s})}pause(e,t){return this._client.post(St`/fine_tuning/jobs/${e}/pause`,t)}resume(e,t){return this._client.post(St`/fine_tuning/jobs/${e}/resume`,t)}}Yn.Checkpoints=Qn;class Zn extends xt{constructor(){super(...arguments),this.methods=new zn(this._client),this.jobs=new Yn(this._client),this.checkpoints=new Gn(this._client),this.alpha=new Jn(this._client)}}Zn.Methods=zn,Zn.Jobs=Yn,Zn.Checkpoints=Gn,Zn.Alpha=Jn;class ea extends xt{}class ta extends xt{constructor(){super(...arguments),this.graderModels=new ea(this._client)}}ta.GraderModels=ea;class sa extends xt{createVariation(e,t){return this._client.post("/images/variations",mt({body:e,...t},this._client))}edit(e,t){return this._client.post("/images/edits",mt({body:e,...t,stream:e.stream??!1},this._client))}generate(e,t){return this._client.post("/images/generations",{body:e,...t,stream:e.stream??!1})}}class na extends xt{retrieve(e,t){return this._client.get(St`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",it,e)}delete(e,t){return this._client.delete(St`/models/${e}`,t)}}class aa extends xt{create(e,t){return this._client.post("/moderations",{body:e,...t})}}class oa extends xt{accept(e,t,s){return this._client.post(St`/realtime/calls/${e}/accept`,{body:t,...s,headers:Fs([{Accept:"*/*"},null==s?void 0:s.headers])})}hangup(e,t){return this._client.post(St`/realtime/calls/${e}/hangup`,{...t,headers:Fs([{Accept:"*/*"},null==t?void 0:t.headers])})}refer(e,t,s){return this._client.post(St`/realtime/calls/${e}/refer`,{body:t,...s,headers:Fs([{Accept:"*/*"},null==s?void 0:s.headers])})}reject(e,t={},s){return this._client.post(St`/realtime/calls/${e}/reject`,{body:t,...s,headers:Fs([{Accept:"*/*"},null==s?void 0:s.headers])})}}class ra extends xt{create(e,t){return this._client.post("/realtime/client_secrets",{body:e,...t})}}class ia extends xt{constructor(){super(...arguments),this.clientSecrets=new ra(this._client),this.calls=new oa(this._client)}}function la(e,t){return t&&function(e){var t;if(Tt(null==(t=e.text)?void 0:t.format))return!0;return!1}(t)?ca(e,t):{...e,output_parsed:null,output:e.output.map(e=>"function_call"===e.type?{...e,parsed_arguments:null}:"message"===e.type?{...e,content:e.content.map(e=>({...e,parsed:null}))}:e)}}function ca(e,t){const s=e.output.map(e=>{if("function_call"===e.type)return{...e,parsed_arguments:da(t,e)};if("message"===e.type){const s=e.content.map(e=>"output_text"===e.type?{...e,parsed:ua(t,e.text)}:e);return{...e,content:s}}return e}),n=Object.assign({},e,{output:s});return Object.getOwnPropertyDescriptor(e,"output_text")||ha(n),Object.defineProperty(n,"output_parsed",{enumerable:!0,get(){for(const e of n.output)if("message"===e.type)for(const t of e.content)if("output_text"===t.type&&null!==t.parsed)return t.parsed;return null}}),n}function ua(e,t){var s,n,a,o;if("json_schema"!==(null==(n=null==(s=e.text)?void 0:s.format)?void 0:n.type))return null;if("$parseRaw"in(null==(a=e.text)?void 0:a.format)){return(null==(o=e.text)?void 0:o.format).$parseRaw(t)}return JSON.parse(t)}function da(e,t){const s=(n=e.tools??[],a=t.name,n.find(e=>"function"===e.type&&e.name===a));var n,a,o;return{...t,...t,parsed_arguments:(o=s,"auto-parseable-tool"===(null==o?void 0:o.$brand)?s.$parseRaw(t.arguments):(null==s?void 0:s.strict)?JSON.parse(t.arguments):null)}}function ha(e){const t=[];for(const s of e.output)if("message"===s.type)for(const e of s.content)"output_text"===e.type&&t.push(e.text);e.output_text=t.join("")}var pa,fa,ma,va,ga,ya,ba,wa;ia.ClientSecrets=ra,ia.Calls=oa;class _a extends os{constructor(e){super(),pa.add(this),fa.set(this,void 0),ma.set(this,void 0),va.set(this,void 0),M(this,fa,e)}static createResponse(e,t,s){const n=new _a(t);return n._run(()=>n._createOrRetrieveResponse(e,t,{...s,headers:{...null==s?void 0:s.headers,"X-Stainless-Helper-Method":"stream"}})),n}async _createOrRetrieveResponse(e,t,s){var n;const a=null==s?void 0:s.signal;let o;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort())),q(this,pa,"m",ga).call(this);let r=null;"response_id"in t?(o=await e.responses.retrieve(t.response_id,{stream:!0},{...s,signal:this.controller.signal,stream:!0}),r=t.starting_after??null):o=await e.responses.create({...t,stream:!0},{...s,signal:this.controller.signal}),this._connected();for await(const i of o)q(this,pa,"m",ya).call(this,i,r);if(null==(n=o.controller.signal)?void 0:n.aborted)throw new X;return q(this,pa,"m",ba).call(this)}[(fa=new WeakMap,ma=new WeakMap,va=new WeakMap,pa=new WeakSet,ga=function(){this.ended||M(this,ma,void 0)},ya=function(e,t){if(this.ended)return;const s=(e,s)=>{(null==t||s.sequence_number>t)&&this._emit(e,s)},n=q(this,pa,"m",wa).call(this,e);switch(s("event",e),e.type){case"response.output_text.delta":{const t=n.output[e.output_index];if(!t)throw new V(`missing output at index ${e.output_index}`);if("message"===t.type){const n=t.content[e.content_index];if(!n)throw new V(`missing content at index ${e.content_index}`);if("output_text"!==n.type)throw new V(`expected content to be 'output_text', got ${n.type}`);s("response.output_text.delta",{...e,snapshot:n.text})}break}case"response.function_call_arguments.delta":{const t=n.output[e.output_index];if(!t)throw new V(`missing output at index ${e.output_index}`);"function_call"===t.type&&s("response.function_call_arguments.delta",{...e,snapshot:t.arguments});break}default:s(e.type,e)}},ba=function(){if(this.ended)throw new V("stream has ended, this shouldn't happen");const e=q(this,ma,"f");if(!e)throw new V("request ended without sending any events");M(this,ma,void 0);const t=function(e,t){return la(e,t)}(e,q(this,fa,"f"));return M(this,va,t),t},wa=function(e){var t;let s=q(this,ma,"f");if(!s){if("response.created"!==e.type)throw new V(`When snapshot hasn't been set yet, expected 'response.created' event, got ${e.type}`);return s=M(this,ma,e.response),s}switch(e.type){case"response.output_item.added":s.output.push(e.item);break;case"response.content_part.added":{const t=s.output[e.output_index];if(!t)throw new V(`missing output at index ${e.output_index}`);const n=t.type,a=e.part;"message"===n&&"reasoning_text"!==a.type?t.content.push(a):"reasoning"===n&&"reasoning_text"===a.type&&(t.content||(t.content=[]),t.content.push(a));break}case"response.output_text.delta":{const t=s.output[e.output_index];if(!t)throw new V(`missing output at index ${e.output_index}`);if("message"===t.type){const s=t.content[e.content_index];if(!s)throw new V(`missing content at index ${e.content_index}`);if("output_text"!==s.type)throw new V(`expected content to be 'output_text', got ${s.type}`);s.text+=e.delta}break}case"response.function_call_arguments.delta":{const t=s.output[e.output_index];if(!t)throw new V(`missing output at index ${e.output_index}`);"function_call"===t.type&&(t.arguments+=e.delta);break}case"response.reasoning_text.delta":{const n=s.output[e.output_index];if(!n)throw new V(`missing output at index ${e.output_index}`);if("reasoning"===n.type){const s=null==(t=n.content)?void 0:t[e.content_index];if(!s)throw new V(`missing content at index ${e.content_index}`);if("reasoning_text"!==s.type)throw new V(`expected content to be 'reasoning_text', got ${s.type}`);s.text+=e.delta}break}case"response.completed":M(this,ma,e.response)}return s},Symbol.asyncIterator)](){const e=[],t=[];let s=!1;return this.on("event",s=>{const n=t.shift();n?n.resolve(s):e.push(s)}),this.on("end",()=>{s=!0;for(const e of t)e.resolve(void 0);t.length=0}),this.on("abort",e=>{s=!0;for(const s of t)s.reject(e);t.length=0}),this.on("error",e=>{s=!0;for(const s of t)s.reject(e);t.length=0}),{next:async()=>{if(!e.length)return s?{value:void 0,done:!0}:new Promise((e,s)=>t.push({resolve:e,reject:s})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0});return{value:e.shift(),done:!1}},return:async()=>(this.abort(),{value:void 0,done:!0})}}async finalResponse(){await this.done();const e=q(this,va,"f");if(!e)throw new V("stream ended without producing a ChatCompletion");return e}}class ka extends xt{list(e,t={},s){return this._client.getAPIList(St`/responses/${e}/input_items`,lt,{query:t,...s})}}class xa extends xt{count(e={},t){return this._client.post("/responses/input_tokens",{body:e,...t})}}class Ca extends xt{constructor(){super(...arguments),this.inputItems=new ka(this._client),this.inputTokens=new xa(this._client)}create(e,t){return this._client.post("/responses",{body:e,...t,stream:e.stream??!1})._thenUnwrap(e=>("object"in e&&"response"===e.object&&ha(e),e))}retrieve(e,t={},s){return this._client.get(St`/responses/${e}`,{query:t,...s,stream:(null==t?void 0:t.stream)??!1})._thenUnwrap(e=>("object"in e&&"response"===e.object&&ha(e),e))}delete(e,t){return this._client.delete(St`/responses/${e}`,{...t,headers:Fs([{Accept:"*/*"},null==t?void 0:t.headers])})}parse(e,t){return this._client.responses.create(e,t)._thenUnwrap(t=>ca(t,e))}stream(e,t){return _a.createResponse(this._client,e,t)}cancel(e,t){return this._client.post(St`/responses/${e}/cancel`,t)}}Ca.InputItems=ka,Ca.InputTokens=xa;class Aa extends xt{create(e,t,s){return this._client.post(St`/uploads/${e}/parts`,mt({body:t,...s},this._client))}}class Sa extends xt{constructor(){super(...arguments),this.parts=new Aa(this._client)}create(e,t){return this._client.post("/uploads",{body:e,...t})}cancel(e,t){return this._client.post(St`/uploads/${e}/cancel`,t)}complete(e,t,s){return this._client.post(St`/uploads/${e}/complete`,{body:t,...s})}}Sa.Parts=Aa;class Ia extends xt{create(e,t,s){return this._client.post(St`/vector_stores/${e}/file_batches`,{body:t,...s,headers:Fs([{"OpenAI-Beta":"assistants=v2"},null==s?void 0:s.headers])})}retrieve(e,t,s){const{vector_store_id:n}=t;return this._client.get(St`/vector_stores/${n}/file_batches/${e}`,{...s,headers:Fs([{"OpenAI-Beta":"assistants=v2"},null==s?void 0:s.headers])})}cancel(e,t,s){const{vector_store_id:n}=t;return this._client.post(St`/vector_stores/${n}/file_batches/${e}/cancel`,{...s,headers:Fs([{"OpenAI-Beta":"assistants=v2"},null==s?void 0:s.headers])})}async createAndPoll(e,t,s){const n=await this.create(e,t);return await this.poll(e,n.id,s)}listFiles(e,t,s){const{vector_store_id:n,...a}=t;return this._client.getAPIList(St`/vector_stores/${n}/file_batches/${e}/files`,lt,{query:a,...s,headers:Fs([{"OpenAI-Beta":"assistants=v2"},null==s?void 0:s.headers])})}async poll(e,t,s){var n;const a=Fs([null==s?void 0:s.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":(null==(n=null==s?void 0:s.pollIntervalMs)?void 0:n.toString())??void 0}]);for(;;){const{data:n,response:o}=await this.retrieve(t,{vector_store_id:e},{...s,headers:a}).withResponse();switch(n.status){case"in_progress":let e=5e3;if(null==s?void 0:s.pollIntervalMs)e=s.pollIntervalMs;else{const t=o.headers.get("openai-poll-after-ms");if(t){const s=parseInt(t);isNaN(s)||(e=s)}}await ue(e);break;case"failed":case"cancelled":case"completed":return n}}}async uploadAndPoll(e,{files:t,fileIds:s=[]},n){if(null==t||0==t.length)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");const a=(null==n?void 0:n.maxConcurrency)??5,o=Math.min(a,t.length),r=this._client,i=t.values(),l=[...s];const c=Array(o).fill(i).map(async function(e){for(let t of e){const e=await r.files.create({file:t,purpose:"assistants"},n);l.push(e.id)}});return await(async e=>{const t=await Promise.allSettled(e),s=t.filter(e=>"rejected"===e.status);if(s.length){for(const e of s);throw new Error(`${s.length} promise(s) failed - see the above errors`)}const n=[];for(const a of t)"fulfilled"===a.status&&n.push(a.value);return n})(c),await this.createAndPoll(e,{file_ids:l})}}class $a extends xt{create(e,t,s){return this._client.post(St`/vector_stores/${e}/files`,{body:t,...s,headers:Fs([{"OpenAI-Beta":"assistants=v2"},null==s?void 0:s.headers])})}retrieve(e,t,s){const{vector_store_id:n}=t;return this._client.get(St`/vector_stores/${n}/files/${e}`,{...s,headers:Fs([{"OpenAI-Beta":"assistants=v2"},null==s?void 0:s.headers])})}update(e,t,s){const{vector_store_id:n,...a}=t;return this._client.post(St`/vector_stores/${n}/files/${e}`,{body:a,...s,headers:Fs([{"OpenAI-Beta":"assistants=v2"},null==s?void 0:s.headers])})}list(e,t={},s){return this._client.getAPIList(St`/vector_stores/${e}/files`,lt,{query:t,...s,headers:Fs([{"OpenAI-Beta":"assistants=v2"},null==s?void 0:s.headers])})}delete(e,t,s){const{vector_store_id:n}=t;return this._client.delete(St`/vector_stores/${n}/files/${e}`,{...s,headers:Fs([{"OpenAI-Beta":"assistants=v2"},null==s?void 0:s.headers])})}async createAndPoll(e,t,s){const n=await this.create(e,t,s);return await this.poll(e,n.id,s)}async poll(e,t,s){var n;const a=Fs([null==s?void 0:s.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":(null==(n=null==s?void 0:s.pollIntervalMs)?void 0:n.toString())??void 0}]);for(;;){const n=await this.retrieve(t,{vector_store_id:e},{...s,headers:a}).withResponse(),o=n.data;switch(o.status){case"in_progress":let e=5e3;if(null==s?void 0:s.pollIntervalMs)e=s.pollIntervalMs;else{const t=n.response.headers.get("openai-poll-after-ms");if(t){const s=parseInt(t);isNaN(s)||(e=s)}}await ue(e);break;case"failed":case"completed":return o}}}async upload(e,t,s){const n=await this._client.files.create({file:t,purpose:"assistants"},s);return this.create(e,{file_id:n.id},s)}async uploadAndPoll(e,t,s){const n=await this.upload(e,t,s);return await this.poll(e,n.id,s)}content(e,t,s){const{vector_store_id:n}=t;return this._client.getAPIList(St`/vector_stores/${n}/files/${e}/content`,it,{...s,headers:Fs([{"OpenAI-Beta":"assistants=v2"},null==s?void 0:s.headers])})}}class Ta extends xt{constructor(){super(...arguments),this.files=new $a(this._client),this.fileBatches=new Ia(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:Fs([{"OpenAI-Beta":"assistants=v2"},null==t?void 0:t.headers])})}retrieve(e,t){return this._client.get(St`/vector_stores/${e}`,{...t,headers:Fs([{"OpenAI-Beta":"assistants=v2"},null==t?void 0:t.headers])})}update(e,t,s){return this._client.post(St`/vector_stores/${e}`,{body:t,...s,headers:Fs([{"OpenAI-Beta":"assistants=v2"},null==s?void 0:s.headers])})}list(e={},t){return this._client.getAPIList("/vector_stores",lt,{query:e,...t,headers:Fs([{"OpenAI-Beta":"assistants=v2"},null==t?void 0:t.headers])})}delete(e,t){return this._client.delete(St`/vector_stores/${e}`,{...t,headers:Fs([{"OpenAI-Beta":"assistants=v2"},null==t?void 0:t.headers])})}search(e,t,s){return this._client.getAPIList(St`/vector_stores/${e}/search`,it,{body:t,method:"post",...s,headers:Fs([{"OpenAI-Beta":"assistants=v2"},null==s?void 0:s.headers])})}}Ta.Files=$a,Ta.FileBatches=Ia;class Oa extends xt{create(e,t){return this._client.post("/videos",ft({body:e,...t},this._client))}retrieve(e,t){return this._client.get(St`/videos/${e}`,t)}list(e={},t){return this._client.getAPIList("/videos",ct,{query:e,...t})}delete(e,t){return this._client.delete(St`/videos/${e}`,t)}downloadContent(e,t={},s){return this._client.get(St`/videos/${e}/content`,{query:t,...s,headers:Fs([{Accept:"application/binary"},null==s?void 0:s.headers]),__binaryResponse:!0})}remix(e,t,s){return this._client.post(St`/videos/${e}/remix`,ft({body:t,...s},this._client))}}var Ra,Pa,Ea,Da,ja,La,Ua;class Ma extends xt{constructor(){super(...arguments),Ra.add(this)}async unwrap(e,t,s=this._client.webhookSecret,n=300){return await this.verifySignature(e,t,s,n),JSON.parse(e)}async verifySignature(e,t,s=this._client.webhookSecret,n=300){if("undefined"==typeof crypto||"function"!=typeof crypto.subtle.importKey||"function"!=typeof crypto.subtle.verify)throw new Error("Webhook signature verification is only supported when the `crypto` global is defined");q(this,Ra,"m",Pa).call(this,s);const a=Fs([t]).values,o=q(this,Ra,"m",Ea).call(this,a,"webhook-signature"),r=q(this,Ra,"m",Ea).call(this,a,"webhook-timestamp"),i=q(this,Ra,"m",Ea).call(this,a,"webhook-id"),l=parseInt(r,10);if(isNaN(l))throw new ae("Invalid webhook timestamp format");const c=Math.floor(Date.now()/1e3);if(c-l>n)throw new ae("Webhook timestamp is too old");if(l>c+n)throw new ae("Webhook timestamp is too new");const u=o.split(" ").map(e=>e.startsWith("v1,")?e.substring(3):e),d=s.startsWith("whsec_")?Buffer.from(s.replace("whsec_",""),"base64"):Buffer.from(s,"utf-8"),h=i?`${i}.${r}.${e}`:`${r}.${e}`,p=await crypto.subtle.importKey("raw",d,{name:"HMAC",hash:"SHA-256"},!1,["verify"]);for(const f of u)try{const e=Buffer.from(f,"base64");if(await crypto.subtle.verify("HMAC",p,e,(new TextEncoder).encode(h)))return}catch{continue}throw new ae("The given webhook signature does not match the expected signature")}}Ra=new WeakSet,Pa=function(e){if("string"!=typeof e||0===e.length)throw new Error("The webhook secret must either be set using the env var, OPENAI_WEBHOOK_SECRET, on the client class, OpenAI({ webhookSecret: '123' }), or passed to this function")},Ea=function(e,t){if(!e)throw new Error("Headers are required");const s=e.get(t);if(null==s)throw new Error(`Missing required header: ${t}`);return s};class qa{constructor({baseURL:e=rn("OPENAI_BASE_URL"),apiKey:t=rn("OPENAI_API_KEY"),organization:s=rn("OPENAI_ORG_ID")??null,project:n=rn("OPENAI_PROJECT_ID")??null,webhookSecret:a=rn("OPENAI_WEBHOOK_SECRET")??null,...o}={}){if(Da.add(this),La.set(this,void 0),this.completions=new jn(this),this.chat=new Bs(this),this.embeddings=new Bn(this),this.files=new Xn(this),this.images=new sa(this),this.audio=new Js(this),this.moderations=new aa(this),this.models=new na(this),this.fineTuning=new Zn(this),this.graders=new ta(this),this.vectorStores=new Ta(this),this.webhooks=new Ma(this),this.beta=new Dn(this),this.batches=new Ks(this),this.uploads=new Sa(this),this.responses=new Ca(this),this.realtime=new ia(this),this.conversations=new Nn(this),this.evals=new Fn(this),this.containers=new Mn(this),this.videos=new Oa(this),void 0===t)throw new V("Missing credentials. Please pass an `apiKey`, or set the `OPENAI_API_KEY` environment variable.");const r={apiKey:t,organization:s,project:n,webhookSecret:a,...o,baseURL:e||"https://api.openai.com/v1"};if(!r.dangerouslyAllowBrowser&&"undefined"!=typeof window&&void 0!==window.document&&"undefined"!=typeof navigator)throw new V("It looks like you're running in a browser-like environment.\n\nThis is disabled by default, as it risks exposing your secret API credentials to attackers.\nIf you understand the risks and have appropriate mitigations in place,\nyou can set the `dangerouslyAllowBrowser` option to `true`, e.g.,\n\nnew OpenAI({ apiKey, dangerouslyAllowBrowser: true });\n\nhttps://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety\n");this.baseURL=r.baseURL,this.timeout=r.timeout??ja.DEFAULT_TIMEOUT,this.logger=r.logger??console;const i="warn";this.logLevel=i,this.logLevel=Fe(r.logLevel,"ClientOptions.logLevel",this)??Fe(rn("OPENAI_LOG"),"process.env['OPENAI_LOG']",this)??i,this.fetchOptions=r.fetchOptions,this.maxRetries=r.maxRetries??2,this.fetch=r.fetch??function(){if("undefined"!=typeof fetch)return fetch;throw new Error("`fetch` is not defined as a global; Either pass `fetch` to the client, `new OpenAI({ fetch })` or polyfill the global, `globalThis.fetch = fetch`")}(),M(this,La,be),this._options=r,this.apiKey="string"==typeof t?t:"Missing Key",this.organization=s,this.project=n,this.webhookSecret=a}withOptions(e){return new this.constructor({...this._options,baseURL:this.baseURL,maxRetries:this.maxRetries,timeout:this.timeout,logger:this.logger,logLevel:this.logLevel,fetch:this.fetch,fetchOptions:this.fetchOptions,apiKey:this.apiKey,organization:this.organization,project:this.project,webhookSecret:this.webhookSecret,...e})}defaultQuery(){return this._options.defaultQuery}validateHeaders({values:e,nulls:t}){}async authHeaders(e){return Fs([{Authorization:`Bearer ${this.apiKey}`}])}stringifyQuery(e){return Ee(e,{arrayFormat:"brackets"})}getUserAgent(){return`${this.constructor.name}/JS ${de}`}defaultIdempotencyKey(){return`stainless-node-retry-${N()}`}makeStatusError(e,t,s,n){return F.generate(e,t,s,n)}async _callApiKey(){const e=this._options.apiKey;if("function"!=typeof e)return!1;let t;try{t=await e()}catch(s){if(s instanceof V)throw s;throw new V(`Failed to get token from 'apiKey' function: ${s.message}`,{cause:s})}if("string"!=typeof t||!t)throw new V(`Expected 'apiKey' function argument to return a string but it returned ${t}`);return this.apiKey=t,!0}buildURL(e,t,s){const n=!q(this,Da,"m",Ua).call(this)&&s||this.baseURL,a=(e=>oe.test(e))(e)?new URL(e):new URL(n+(n.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),o=this.defaultQuery();return function(e){if(!e)return!0;for(const t in e)return!1;return!0}(o)||(t={...o,...t}),"object"==typeof t&&t&&!Array.isArray(t)&&(a.search=this.stringifyQuery(t)),a.toString()}async prepareOptions(e){await this._callApiKey()}async prepareRequest(e,{url:t,options:s}){}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,s){return this.request(Promise.resolve(s).then(s=>({method:e,path:t,...s})))}request(e,t=null){return new at(this,this.makeRequest(e,t,void 0))}async makeRequest(e,t,s){var n,a;const o=await e,r=o.maxRetries??this.maxRetries;null==t&&(t=r),await this.prepareOptions(o);const{req:i,url:l,timeout:c}=await this.buildRequest(o,{retryCount:r-t});await this.prepareRequest(i,{url:l,options:o});const u="log_"+(Math.random()*(1<<24)|0).toString(16).padStart(6,"0"),d=void 0===s?"":`, retryOf: ${s}`,h=Date.now();if(Ke(this).debug(`[${u}] sending request`,Ge({retryOfRequestLogID:s,method:o.method,url:l,options:o,headers:i.headers})),null==(n=o.signal)?void 0:n.aborted)throw new X;const p=new AbortController,f=await this.fetchWithTimeout(l,i,c,p).catch(W),m=Date.now();if(f instanceof globalThis.Error){const e=`retrying, ${t} attempts remaining`;if(null==(a=o.signal)?void 0:a.aborted)throw new X;const n=B(f)||/timed? ?out/i.test(String(f)+("cause"in f?String(f.cause):""));if(t)return Ke(this).info(`[${u}] connection ${n?"timed out":"failed"} - ${e}`),Ke(this).debug(`[${u}] connection ${n?"timed out":"failed"} (${e})`,Ge({retryOfRequestLogID:s,url:l,durationMs:m-h,message:f.message})),this.retryRequest(o,t,s??u);if(Ke(this).info(`[${u}] connection ${n?"timed out":"failed"} - error; no more retries left`),Ke(this).debug(`[${u}] connection ${n?"timed out":"failed"} (error; no more retries left)`,Ge({retryOfRequestLogID:s,url:l,durationMs:m-h,message:f.message})),n)throw new H;throw new z({cause:f})}const v=`[${u}${d}${[...f.headers.entries()].filter(([e])=>"x-request-id"===e).map(([e,t])=>", "+e+": "+JSON.stringify(t)).join("")}] ${i.method} ${l} ${f.ok?"succeeded":"failed"} with status ${f.status} in ${m-h}ms`;if(!f.ok){const e=await this.shouldRetry(f);if(t&&e){const e=`retrying, ${t} attempts remaining`;return await async function(e){var t,s;if(null===e||"object"!=typeof e)return;if(e[Symbol.asyncIterator])return void(await(null==(s=(t=e[Symbol.asyncIterator]()).return)?void 0:s.call(t)));const n=e.getReader(),a=n.cancel();n.releaseLock(),await a}(f.body),Ke(this).info(`${v} - ${e}`),Ke(this).debug(`[${u}] response error (${e})`,Ge({retryOfRequestLogID:s,url:f.url,status:f.status,headers:f.headers,durationMs:m-h})),this.retryRequest(o,t,s??u,f.headers)}const n=e?"error; no more retries left":"error; not retryable";Ke(this).info(`${v} - ${n}`);const a=await f.text().catch(e=>W(e).message),r=(e=>{try{return JSON.parse(e)}catch(t){return}})(a),i=r?void 0:a;Ke(this).debug(`[${u}] response error (${n})`,Ge({retryOfRequestLogID:s,url:f.url,status:f.status,headers:f.headers,message:i,durationMs:Date.now()-h}));throw this.makeStatusError(f.status,r,i,f.headers)}return Ke(this).info(v),Ke(this).debug(`[${u}] response start`,Ge({retryOfRequestLogID:s,url:f.url,status:f.status,headers:f.headers,durationMs:m-h})),{response:f,options:o,controller:p,requestLogID:u,retryOfRequestLogID:s,startTime:h}}getAPIList(e,t,s){return this.requestAPIList(t,{method:"get",path:e,...s})}requestAPIList(e,t){const s=this.makeRequest(t,null,void 0);return new rt(this,s,e)}async fetchWithTimeout(e,t,s,n){const{signal:a,method:o,...r}=t||{};a&&a.addEventListener("abort",()=>n.abort());const i=setTimeout(()=>n.abort(),s),l=globalThis.ReadableStream&&r.body instanceof globalThis.ReadableStream||"object"==typeof r.body&&null!==r.body&&Symbol.asyncIterator in r.body,c={signal:n.signal,...l?{duplex:"half"}:{},method:"GET",...r};o&&(c.method=o.toUpperCase());try{return await this.fetch.call(void 0,e,c)}finally{clearTimeout(i)}}async shouldRetry(e){const t=e.headers.get("x-should-retry");return"true"===t||"false"!==t&&(408===e.status||(409===e.status||(429===e.status||e.status>=500)))}async retryRequest(e,t,s,n){let a;const o=null==n?void 0:n.get("retry-after-ms");if(o){const e=parseFloat(o);Number.isNaN(e)||(a=e)}const r=null==n?void 0:n.get("retry-after");if(r&&!a){const e=parseFloat(r);a=Number.isNaN(e)?Date.parse(r)-Date.now():1e3*e}if(!(a&&0<=a&&a<6e4)){const s=e.maxRetries??this.maxRetries;a=this.calculateDefaultRetryTimeoutMillis(t,s)}return await ue(a),this.makeRequest(e,t-1,s)}calculateDefaultRetryTimeoutMillis(e,t){const s=t-e;return Math.min(.5*Math.pow(2,s),8)*(1-.25*Math.random())*1e3}async buildRequest(e,{retryCount:t=0}={}){const s={...e},{method:n,path:a,query:o,defaultBaseURL:r}=s,i=this.buildURL(a,o,r);"timeout"in s&&((e,t)=>{if("number"!=typeof t||!Number.isInteger(t))throw new V(`${e} must be an integer`);if(t<0)throw new V(`${e} must be a positive integer`)})("timeout",s.timeout),s.timeout=s.timeout??this.timeout;const{bodyHeaders:l,body:c}=this.buildBody({options:s});return{req:{method:n,headers:await this.buildHeaders({options:e,method:n,bodyHeaders:l,retryCount:t}),...s.signal&&{signal:s.signal},...globalThis.ReadableStream&&c instanceof globalThis.ReadableStream&&{duplex:"half"},...c&&{body:c},...this.fetchOptions??{},...s.fetchOptions??{}},url:i,timeout:s.timeout}}async buildHeaders({options:e,method:t,bodyHeaders:s,retryCount:n}){let a={};this.idempotencyHeader&&"get"!==t&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),a[this.idempotencyHeader]=e.idempotencyKey);const o=Fs([a,{Accept:"application/json","User-Agent":this.getUserAgent(),"X-Stainless-Retry-Count":String(n),...e.timeout?{"X-Stainless-Timeout":String(Math.trunc(e.timeout/1e3))}:{},...me??(me=he()),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project},await this.authHeaders(e),this._options.defaultHeaders,s,e.headers]);return this.validateHeaders(o),o.values}buildBody({options:{body:e,headers:t}}){if(!e)return{bodyHeaders:void 0,body:void 0};const s=Fs([t]);return ArrayBuffer.isView(e)||e instanceof ArrayBuffer||e instanceof DataView||"string"==typeof e&&s.values.has("content-type")||globalThis.Blob&&e instanceof globalThis.Blob||e instanceof FormData||e instanceof URLSearchParams||globalThis.ReadableStream&&e instanceof globalThis.ReadableStream?{bodyHeaders:void 0,body:e}:"object"==typeof e&&(Symbol.asyncIterator in e||Symbol.iterator in e&&"next"in e&&"function"==typeof e.next)?{bodyHeaders:void 0,body:ge(e)}:q(this,La,"f").call(this,{body:e,headers:s})}}ja=qa,La=new WeakMap,Da=new WeakSet,Ua=function(){return"https://api.openai.com/v1"!==this.baseURL},qa.OpenAI=ja,qa.DEFAULT_TIMEOUT=6e5,qa.OpenAIError=V,qa.APIError=F,qa.APIConnectionError=z,qa.APIConnectionTimeoutError=H,qa.APIUserAbortError=X,qa.NotFoundError=Q,qa.ConflictError=Y,qa.RateLimitError=ee,qa.BadRequestError=J,qa.AuthenticationError=K,qa.InternalServerError=te,qa.PermissionDeniedError=G,qa.UnprocessableEntityError=Z,qa.InvalidWebhookSignatureError=ae,qa.toFile=async function(e,t,s){if(ut(),(e=>null!=e&&"object"==typeof e&&"string"==typeof e.name&&"number"==typeof e.lastModified&&_t(e))(e=await e))return e instanceof File?e:dt([await e.arrayBuffer()],e.name);if((e=>null!=e&&"object"==typeof e&&"string"==typeof e.url&&"function"==typeof e.blob)(e)){const n=await e.blob();return t||(t=new URL(e.url).pathname.split(/[\\/]/).pop()),dt(await kt(n),t,s)}const n=await kt(e);if(t||(t=ht(e)),!(null==s?void 0:s.type)){const e=n.find(e=>"object"==typeof e&&"type"in e&&e.type);"string"==typeof e&&(s={...s,type:e})}return dt(n,t,s)},qa.Completions=jn,qa.Chat=Bs,qa.Embeddings=Bn,qa.Files=Xn,qa.Images=sa,qa.Audio=Js,qa.Moderations=aa,qa.Models=na,qa.FineTuning=Zn,qa.Graders=ta,qa.VectorStores=Ta,qa.Webhooks=Ma,qa.Beta=Dn,qa.Batches=Ks,qa.Uploads=Sa,qa.Responses=Ca,qa.Realtime=ia,qa.Conversations=Nn,qa.Evals=Fn,qa.Containers=Mn,qa.Videos=Oa;const Na={class:"admin-blog-manager"},Ba={class:"manager-header"},Wa={class:"blog-list"},Va={class:"list-header"},Fa={class:"search-bar"},Xa={class:"filter-bar"},za={class:"blog-table"},Ha={class:"blog-title"},Ja={key:0,class:"pinned-indicator"},Ka={class:"blog-summary"},Ga={class:"category-badge"},Qa={class:"action-buttons"},Ya=["onClick"],Za=["onClick"],eo={class:"modal-header"},to={class:"modal-body"},so={class:"form-group"},no={class:"form-group"},ao={class:"excerpt-wrapper"},oo=["disabled"],ro={key:0},io={key:1,class:"loading-text"},lo={key:0,class:"hint-text"},co={key:1,class:"error-text"},uo={key:2,class:"success-text"},ho={class:"form-group"},po={class:"content-header"},fo={key:0,class:"assets-counter"},mo={class:"markdown-editor"},vo=["innerHTML"],go={class:"form-group"},yo={class:"cover-row"},bo={key:0,class:"cover-preview"},wo=["src"],_o={class:"form-group"},ko={class:"form-group"},xo=["value"],Co={key:0,class:"mt-2"},Ao={class:"form-group"},So={class:"form-actions"},Io={type:"submit",class:"save-btn"},$o={__name:"AdminBlogManager",setup(e){s();const t=a([]),x=a([]),C=a(""),A=a(""),S=a(!1),I=a(!1),$=a(!1),T=a(""),E=a(!1),D=a(""),j=a(!1),L=a(null),M=a(null),q=a(null),N=a([]),B=a(null),W=a(new Map),V=a(["前端开发","AI技术","游戏","音乐"]),F=o({id:null,title:"",excerpt:"",content:"",category:"",newCategoryText:"",tags:"",status:"draft",coverImage:""}),X=new R.Renderer;X.image=(e="",t,s)=>{if("object"==typeof e&&null!==e){const n=e;e=n.href||"",t=n.title,s=n.text||n.alt||""}const n=/^(https?:|data:)/i.test(e),a=/^\/api\/blog\//i.test(e);let o=e;if(n||a)a&&(o=`https://api.shirakawananase.top${e}`);else{const t=String(e).replace(/^\.\//,"").replace(/\\/g,"/").replace(/^\//,""),s=W.value.get(t);o=s||e}return`<img src="${o}" alt="${s||""}"${t?` title="${t}"`:""} loading="lazy" decoding="async">`},R.setOptions({renderer:X});const z=r(()=>{const e=R(F.content||"");return P.sanitize(e)}),H=()=>{"__other__"!==F.category&&(F.newCategoryText="")},J=()=>{var e;null==(e=L.value)||e.click()},K=()=>{var e;null==(e=q.value)||e.click()},G=e=>{const t=e.target.files[0];if(!t)return;if(t.type&&"text/markdown"!==t.type&&!t.name.endsWith(".md"))return void alert("请选择一个 Markdown (.md) 文件。");const s=new FileReader;s.onload=e=>{F.content=e.target.result},s.onerror=e=>{alert("文件读取失败")},s.readAsText(t)},Q=async()=>{var e,t,s,a,o;if(D.value="",j.value=!1,F.content&&""!==F.content.trim()){E.value=!0;try{const e=await n.getAiConfig(),t=e.data||e;if(!t.available)return void(D.value=t.message||"服务端未配置 AI API Key，AI 摘要功能不可用");const s=new qa({baseURL:t.baseURL||"https://api.deepseek.com",apiKey:t.apiKey,dangerouslyAllowBrowser:!0}),a="你是一名爱好写博客的技术人，现在需要概括一下文章，进而生成一下博客概要，不超过150字：\n 以下是源文章："+F.content,o=await s.chat.completions.create({messages:[{role:"system",content:a}],model:"deepseek-chat"});F.excerpt=o.choices[0].message.content,j.value=!0,setTimeout(()=>{j.value=!1},3e3)}catch(r){403===(null==(e=r.response)?void 0:e.status)?D.value="没有权限使用 AI 功能，请确认您是管理员":401===(null==(t=r.response)?void 0:t.status)?D.value="登录已过期，请重新登录后再试":(null==(s=r.message)?void 0:s.includes("network"))?D.value="网络连接失败，请检查网络后重试":(null==(a=r.message)?void 0:a.includes("API key"))?D.value="API密钥无效，请联系管理员检查后端配置":(null==(o=r.message)?void 0:o.includes("quota"))?D.value="API调用额度不足，请稍后重试":D.value="AI生成失败："+(r.message||"请稍后重试"),setTimeout(()=>{D.value=""},5e3)}finally{E.value=!1}}else D.value="请先填写博客内容"},Y=async e=>{const t=Array.from(e.target.files||[]);N.value=t,W.value=new Map;for(const s of t){if(/\.zip$/i.test(s.name))continue;const e=URL.createObjectURL(s);W.value.set(s.name.replace(/\\/g,"/"),e)}},Z=async()=>{$.value=!0,T.value="";try{const e=await O.getAllBlogs();if(!e.success)throw new Error(e.message||"获取博客列表失败");t.value=e.data.blogs||[],x.value=e.data.blogs||[],(()=>{const e=new Set(["前端开发","AI技术","游戏","音乐"]);t.value.forEach(t=>{t.category&&e.add(t.category)}),V.value=Array.from(e).sort()})()}catch(e){T.value=e.message||"获取博客列表失败，请稍后重试",t.value=[],x.value=[]}finally{$.value=!1}},ee=()=>{let e=t.value;if(C.value){const t=C.value.toLowerCase();e=e.filter(e=>e.title.toLowerCase().includes(t)||e.excerpt.toLowerCase().includes(t)||e.content.toLowerCase().includes(t)||e.tags&&e.tags.some(e=>e.toLowerCase().includes(t)))}A.value&&(e=e.filter(e=>e.status===A.value)),x.value=e},te=async()=>{var e;try{const t="__other__"===F.category?F.newCategoryText.trim():F.category,s={title:F.title,excerpt:F.excerpt,content:F.content,category:t,tags:F.tags.split(",").map(e=>e.trim()).filter(Boolean),status:F.status,coverImage:F.coverImage||""};if(!s.title)return void alert("请填写博客标题");if(!s.excerpt)return void alert("请填写博客摘要");if(!s.content)return void alert("请填写博客内容");if(!s.category)return void alert("请选择博客分类");if("__other__"===F.category&&!F.newCategoryText.trim())return void alert("请输入新分类名称");let n;if(/!\[[^\]]*\]\((?!https?:|data:|\/api\/blog\/)[^\)]+\)/i.test(s.content)&&((null==(e=N.value)?void 0:e.length)||0)>0){const e=new FormData,t=new Blob([s.content],{type:"text/markdown"});e.append("markdown",t,`${Date.now()}.md`),e.append("title",s.title),e.append("excerpt",s.excerpt),e.append("category",s.category);for(const n of s.tags)e.append("tags",n);e.append("status",s.status),!S.value&&F.id&&e.append("blogId",F.id);for(const s of N.value)e.append("assets",s);n=await O.importMarkdown(e)}else n=S.value?await O.createBlog(s):await O.updateBlog(F.id,s);if(!n.success)throw new Error(n.message||"保存失败");await Z(),se(),alert(S.value?"博客创建成功!":"博客更新成功!")}catch(t){let e="保存失败";if(t.response){const s=t.response.data;switch(s.message&&(e+=": "+s.message),t.response.status){case 400:e="数据验证失败 - 请检查所有必填字段是否正确填写",s.errors&&(e+="\n详细错误: "+JSON.stringify(s.errors));break;case 401:e="认证失败 - 请重新登录";break;case 403:e="权限不足 - 您没有权限执行此操作";break;case 500:e="服务器内部错误 - 请稍后重试"}}else e=t.request?"网络连接失败 - 请检查网络连接":t.message;alert(e)}},se=()=>{S.value=!1,I.value=!1,Object.assign(F,{id:null,title:"",excerpt:"",content:"",category:"",newCategoryText:"",tags:"",status:"draft",coverImage:""}),N.value=[],W.value=new Map,q.value&&(q.value.value=""),B.value&&(B.value.value="")};const ne=async e=>{const t=(e.clipboardData||e.originalEvent.clipboardData).items;for(let s=0;s<t.length;s++){const n=t[s];if("file"===n.kind&&-1!==n.type.indexOf("image")){e.preventDefault();const t=n.getAsFile();await oe(t);break}}},ae=async e=>{e.preventDefault();const t=e.dataTransfer.files;for(let s=0;s<t.length;s++){const e=t[s];if(-1!==e.type.indexOf("image")){await oe(e);break}}},oe=async e=>{try{const t=await U(e),s=`![${e.name}](${t.url})`;!function(e,t){const s=e.selectionStart,n=e.selectionEnd,a=e.value;e.value=a.slice(0,s)+t+a.slice(n);const o=s+t.length;e.selectionStart=e.selectionEnd=o,e.dispatchEvent(new Event("input"))}(M.value,s)}catch(t){alert("图片上传失败: "+t.message)}},re=()=>{var e;null==(e=B.value)||e.click()},ie=async e=>{var t;const s=null==(t=e.target.files)?void 0:t[0];if(s)try{const e=await U(s);F.coverImage=e.url}catch(n){alert("封面上传失败: "+n.message)}},le=e=>{if(!e)return"";const t=/^(https?:|data:)/i.test(e),s=/^\/api\/blog\//i.test(e);return t?e:s?`https://api.shirakawananase.top${e}`:e},ce=()=>{},ue=e=>{if(!e)return"N/A";const t=new Date(e);return isNaN(t.getTime())?"Invalid Date":t.toLocaleDateString("zh-CN")};return i(()=>{Z()}),(e,t)=>(c(),l("div",Na,[u("div",Ba,[t[13]||(t[13]=u("h2",null,"博客管理",-1)),u("button",{onClick:t[0]||(t[0]=e=>S.value=!0),class:"create-btn"}," ➕ 创建博客 ")]),u("div",Wa,[u("div",Va,[u("div",Fa,[h(u("input",{"onUpdate:modelValue":t[1]||(t[1]=e=>C.value=e),placeholder:"搜索博客标题或内容...",onInput:ee},null,544),[[p,C.value]])]),u("div",Xa,[h(u("select",{"onUpdate:modelValue":t[2]||(t[2]=e=>A.value=e),onChange:ee},t[14]||(t[14]=[u("option",{value:""},"全部状态",-1),u("option",{value:"published"},"已发布",-1),u("option",{value:"draft"},"草稿",-1),u("option",{value:"pinned"},"置顶",-1)]),544),[[f,A.value]])])]),u("div",za,[u("table",null,[t[15]||(t[15]=u("thead",null,[u("tr",null,[u("th",null,"标题"),u("th",null,"分类"),u("th",null,"状态"),u("th",null,"创建时间"),u("th",null,"更新时间"),u("th",null,"操作")])],-1)),u("tbody",null,[(c(!0),l(m,null,v(x.value,e=>{return c(),l("tr",{key:e._id||e.id},[u("td",null,[u("div",Ha,[g(b(e.title)+" ",1),"pinned"===e.status?(c(),l("span",Ja,"📌")):y("",!0),u("span",Ka,b(e.excerpt),1)])]),u("td",null,[u("span",Ga,b(e.category),1)]),u("td",null,[u("span",{class:w(["status-badge",e.status])},b((t=e.status,{draft:"草稿",published:"已发布",pinned:"置顶"}[t]||t)),3)]),u("td",null,b(ue(e.createdAt)),1),u("td",null,b(ue(e.updatedAt)),1),u("td",null,[u("div",Qa,[u("button",{onClick:t=>(e=>{var t;Object.assign(F,{id:e._id||e.id,title:e.title,excerpt:e.excerpt,content:e.content,category:e.category,newCategoryText:"",tags:(null==(t=e.tags)?void 0:t.join(","))||"",status:e.status||"draft",coverImage:e.coverImage||""}),I.value=!0})(e),class:"edit-btn"},"编辑",8,Ya),u("button",{onClick:t=>(async e=>{if(confirm("确定要删除这篇博客吗？"))try{const t=await O.deleteBlog(e);if(!t.success&&"博客已删除"!==t.message)throw new Error(t.message||"删除失败");await Z(),alert("博客删除成功!")}catch(t){alert("删除失败: "+t.message)}})(e._id||e.id),class:"delete-btn"},"删除",8,Za)])])]);var t}),128))])])])]),(c(),d(k,{to:"body"},[S.value||I.value?(c(),l("div",{key:0,class:"modal-overlay",onClick:se},[u("div",{class:"modal-content",onClick:t[12]||(t[12]=_(()=>{},["stop"]))},[u("div",eo,[u("h3",null,b(S.value?"创建博客":"编辑博客"),1),u("button",{onClick:se,class:"close-btn"},"✕")]),u("div",to,[u("form",{onSubmit:_(te,["prevent"])},[u("div",so,[t[16]||(t[16]=u("label",null,"标题",-1)),h(u("input",{"onUpdate:modelValue":t[3]||(t[3]=e=>F.title=e),type:"text",required:""},null,512),[[p,F.title]])]),u("div",no,[t[19]||(t[19]=u("label",null,"摘要",-1)),u("div",ao,[h(u("textarea",{"onUpdate:modelValue":t[4]||(t[4]=e=>F.excerpt=e),rows:"3",placeholder:"请输入博客摘要，或点击AI生成按钮自动生成..."},null,512),[[p,F.excerpt]]),u("button",{type:"button",class:"ai-summary-btn",onClick:Q,disabled:E.value||!F.content},[E.value?(c(),l("span",io,t[18]||(t[18]=[u("span",{class:"spinner"},null,-1),g(" AI思考中... ")]))):(c(),l("span",ro,t[17]||(t[17]=[u("span",{class:"ai-icon"},"✨",-1),g(" AI生成摘要 ")])))],8,oo)]),F.content?y("",!0):(c(),l("div",lo," 💡 提示：请先填写博客内容后再使用AI生成摘要 ")),D.value?(c(),l("div",co," ❌ "+b(D.value),1)):y("",!0),j.value?(c(),l("div",uo," ✅ AI摘要生成成功！ ")):y("",!0)]),u("div",ho,[u("div",po,[t[20]||(t[20]=u("label",null,"内容 (Markdown)",-1)),u("button",{type:"button",onClick:J,class:"upload-md-btn"},"从文件上传"),u("input",{type:"file",ref_key:"markdownFileInput",ref:L,onChange:G,accept:".md",style:{display:"none"}},null,544),u("button",{type:"button",onClick:K,class:"upload-md-btn"},"添加资源"),u("input",{type:"file",ref_key:"assetsInput",ref:q,onChange:Y,multiple:"",style:{display:"none"},accept:"image/*,.zip"},null,544),N.value.length?(c(),l("span",fo,"已添加 "+b(N.value.length)+" 个资源",1)):y("",!0)]),u("div",mo,[h(u("textarea",{"onUpdate:modelValue":t[5]||(t[5]=e=>F.content=e),ref_key:"markdownTextarea",ref:M,rows:"15",required:"",class:"markdown-input",onPaste:ne,onDrop:ae,onDragover:t[6]||(t[6]=_(()=>{},["prevent"]))},null,544),[[p,F.content]]),u("div",{innerHTML:z.value,class:"markdown-preview"},null,8,vo)])]),u("div",go,[t[21]||(t[21]=u("label",null,"封面图（可选）",-1)),u("div",yo,[h(u("input",{"onUpdate:modelValue":t[7]||(t[7]=e=>F.coverImage=e),type:"text",placeholder:"封面图 URL 或相对路径"},null,512),[[p,F.coverImage]]),u("input",{type:"file",ref_key:"coverInput",ref:B,accept:"image/*",style:{display:"none"},onChange:ie},null,544),u("button",{type:"button",class:"upload-md-btn",onClick:re},"上传封面")]),F.coverImage?(c(),l("div",bo,[u("img",{src:le(F.coverImage),alt:"封面预览",onError:ce},null,40,wo)])):y("",!0)]),u("div",_o,[t[22]||(t[22]=u("label",null,"标签",-1)),h(u("input",{"onUpdate:modelValue":t[8]||(t[8]=e=>F.tags=e),type:"text",placeholder:"用逗号分隔多个标签"},null,512),[[p,F.tags]])]),u("div",ko,[t[25]||(t[25]=u("label",null,"分类",-1)),h(u("select",{"onUpdate:modelValue":t[9]||(t[9]=e=>F.category=e),onChange:H,required:""},[t[23]||(t[23]=u("option",{value:""},"请选择分类",-1)),(c(!0),l(m,null,v(V.value,e=>(c(),l("option",{key:e,value:e},b(e),9,xo))),128)),t[24]||(t[24]=u("option",{value:"__other__"},"其他",-1))],544),[[f,F.category]]),"__other__"===F.category?(c(),l("div",Co,[h(u("input",{"onUpdate:modelValue":t[10]||(t[10]=e=>F.newCategoryText=e),type:"text",placeholder:"输入新分类名称",required:"",class:"form-control"},null,512),[[p,F.newCategoryText]])])):y("",!0)]),u("div",Ao,[t[27]||(t[27]=u("label",null,"状态",-1)),h(u("select",{"onUpdate:modelValue":t[11]||(t[11]=e=>F.status=e)},t[26]||(t[26]=[u("option",{value:"draft"},"草稿",-1),u("option",{value:"published"},"发布",-1),u("option",{value:"pinned"},"置顶",-1)]),512),[[f,F.status]])]),u("div",So,[u("button",{type:"button",onClick:se,class:"cancel-btn"},"取消"),u("button",Io,b(S.value?"创建":"保存"),1)])],32)])])])):y("",!0)]))]))}},To=t($o,[["__scopeId","data-v-66e9e5e1"]]),Oo={class:"admin-friend-link-manager"},Ro={class:"manager-header"},Po={class:"filter-bar"},Eo={key:0,class:"loading-state"},Do={key:1,class:"error-state"},jo={key:2,class:"friend-links-grid"},Lo={class:"link-header"},Uo=["src","alt"],Mo={class:"link-info"},qo={class:"link-name"},No={class:"link-url"},Bo=["href"],Wo={class:"link-content"},Vo={class:"link-description"},Fo={class:"link-meta"},Xo={class:"category"},zo={class:"date"},Ho={class:"link-actions"},Jo=["onClick"],Ko=["onClick"],Go=["onClick"],Qo=["onClick"],Yo={key:3,class:"empty-state"},Zo={class:"modal-header"},er={class:"modal-body"},tr={class:"form-group"},sr={class:"form-group"},nr={class:"url-input-group"},ar=["disabled"],or={class:"form-group"},rr={class:"form-group"},ir={class:"form-group"},lr={class:"logo-input-group"},cr={key:0,class:"logo-preview"},ur=["src"],dr={class:"form-group"},hr={class:"form-group"},pr={class:"form-group"},fr={class:"form-actions"},mr={type:"submit",class:"save-btn"},vr=t({__name:"AdminFriendLinkManager",setup(e){const t=a([]),s=a([]),n=a(!1),g=a(!1),C=a(!1),A=a(""),S=a(""),I=a(""),$=a(""),T=a(!1),O=o({id:null,name:"",url:"",description:"",category:"",avatar:"",email:"",contactInfo:"",isActive:"false"}),R=r(()=>!!O.id),P=async()=>{C.value=!0,A.value="";try{const e=await E.getFriendLinks();if(!e.success)throw new Error(e.message||"获取友情链接失败");t.value=e.data.friendLinks||e.data,s.value=e.data.friendLinks||e.data}catch(e){A.value=e.message||"获取友情链接失败，请稍后重试";const n=[{id:1,name:"Vue.js 官网",url:"https://vuejs.org",description:"The Progressive JavaScript Framework",category:"技术社区",avatar:"https://vuejs.org/logo.svg",isActive:!0,email:"admin@vuejs.org",contactInfo:"",createdAt:(new Date).toISOString()},{id:2,name:"GitHub",url:"https://github.com",description:"Where the world builds software",category:"工具网站",avatar:"https://github.com/fluidicon.png",isActive:!0,email:"support@github.com",contactInfo:"",createdAt:(new Date).toISOString()},{id:3,name:"测试博客",url:"https://example.com",description:"这是一个待审核的测试博客",category:"个人博客",avatar:"",isActive:!1,email:"test@example.com",contactInfo:"QQ: 123456789",createdAt:(new Date).toISOString()}];t.value=n,s.value=n}finally{C.value=!1}},D=()=>{let e=t.value;if(S.value&&("approved"===S.value?e=e.filter(e=>!0===e.isActive):"pending"===S.value&&(e=e.filter(e=>!1===e.isActive))),I.value&&(e=e.filter(e=>e.category===I.value)),$.value){const t=$.value.toLowerCase();e=e.filter(e=>{var s;return e.name.toLowerCase().includes(t)||(null==(s=e.description)?void 0:s.toLowerCase().includes(t))||e.url.toLowerCase().includes(t)})}s.value=e},j=async()=>{var e,t;try{const e={name:O.name,url:O.url,description:O.description,category:O.category,avatar:O.avatar,email:O.email,contactInfo:O.contactInfo,isActive:"true"===O.isActive};R.value?(await E.updateFriendLink(O.id,e),alert("友情链接更新成功!")):(await E.createFriendLink(e),alert("友情链接创建成功!")),await P(),U()}catch(s){alert("保存失败: "+((null==(t=null==(e=s.response)?void 0:e.data)?void 0:t.message)||s.message))}},L=async(e,t)=>{var s,n;const a=t?"通过":"禁用";if(confirm(`确定要${a}此友情链接吗？`))try{await E.updateFriendLink(e,{isActive:t}),await P(),alert(`友情链接${a}成功!`)}catch(o){alert("状态切换失败: "+((null==(n=null==(s=o.response)?void 0:s.data)?void 0:n.message)||o.message))}},U=()=>{n.value=!1,g.value=!1,Object.assign(O,{id:null,name:"",url:"",description:"",category:"",avatar:"",email:"",contactInfo:"",isActive:"false"})},M=e=>e?"已通过":"待审核",q=async()=>{var e,t;if(O.url){T.value=!0;try{const e=await E.previewFavicon(O.url);e.success&&e.data.success?(O.avatar=e.data.faviconUrl,alert(`Favicon获取成功！\n方法: ${e.data.method}\n域名: ${e.data.domain}`)):alert("无法获取网站图标，请手动输入Logo地址")}catch(s){alert("获取网站图标失败: "+((null==(t=null==(e=s.response)?void 0:e.data)?void 0:t.message)||s.message))}finally{T.value=!1}}else alert("请先输入网站地址")},N=async()=>{O.url&&!O.avatar&&await q()},B=e=>{e.target.src="/image/default-logo.png"},W=e=>{if(!e)return"/image/default-logo.png";if(e.startsWith("http"))return e;return`${"undefined"==typeof window||"shirakawananase.top"!==window.location.hostname&&!window.location.hostname.endsWith(".shirakawananase.top")?"http://localhost:3000":"https://api.shirakawananase.top"}${e}`};return i(()=>{P()}),(e,t)=>(c(),l("div",Oo,[u("div",Ro,[t[13]||(t[13]=u("h2",null,"友情链接管理",-1)),u("button",{onClick:t[0]||(t[0]=e=>n.value=!0),class:"create-btn"}," ➕ 添加友情链接 ")]),u("div",Po,[h(u("select",{"onUpdate:modelValue":t[1]||(t[1]=e=>S.value=e),onChange:D},t[14]||(t[14]=[u("option",{value:""},"全部状态",-1),u("option",{value:"approved"},"已通过",-1),u("option",{value:"pending"},"待审核",-1),u("option",{value:"rejected"},"已拒绝",-1)]),544),[[f,S.value]]),h(u("select",{"onUpdate:modelValue":t[2]||(t[2]=e=>I.value=e),onChange:D},t[15]||(t[15]=[x('<option value="" data-v-fd051ab8>全部分类</option><option value="个人博客" data-v-fd051ab8>个人博客</option><option value="技术社区" data-v-fd051ab8>技术社区</option><option value="学习资源" data-v-fd051ab8>学习资源</option><option value="工具网站" data-v-fd051ab8>工具网站</option><option value="其他" data-v-fd051ab8>其他</option>',6)]),544),[[f,I.value]]),h(u("input",{"onUpdate:modelValue":t[3]||(t[3]=e=>$.value=e),placeholder:"搜索网站名称或描述...",onInput:D},null,544),[[p,$.value]])]),C.value?(c(),l("div",Eo,t[16]||(t[16]=[u("p",null,"正在加载友情链接...",-1)]))):A.value?(c(),l("div",Do,[t[17]||(t[17]=u("h3",null,"加载失败",-1)),u("p",null,b(A.value),1),u("button",{onClick:P,class:"retry-btn"},"重试")])):(c(),l("div",jo,[(c(!0),l(m,null,v(s.value,e=>{return c(),l("div",{key:e._id||e.id,class:"link-card"},[u("div",Lo,[u("img",{src:W(e.avatar),alt:e.name,class:"link-logo"},null,8,Uo),u("div",Mo,[u("div",qo,b(e.name),1),u("div",No,[u("a",{href:e.url,target:"_blank"},b(e.url),9,Bo)])])]),u("div",Wo,[u("div",Vo,b(e.description||"暂无描述"),1),u("div",Fo,[u("span",Xo,b(e.category),1),u("span",{class:w(["status",(s=e.isActive,s?"approved":"pending")])},b(M(e.isActive)),3),u("span",zo,b((t=e.createdAt,new Date(t).toLocaleDateString("zh-CN"))),1)])]),u("div",Ho,[u("button",{onClick:t=>(e=>{Object.assign(O,{id:e._id||e.id,name:e.name,url:e.url,description:e.description||"",category:e.category,avatar:e.avatar,email:e.email,contactInfo:e.contactInfo,isActive:e.isActive?"true":"false"}),g.value=!0})(e),class:"edit-btn"},"编辑",8,Jo),e.isActive?y("",!0):(c(),l("button",{key:0,onClick:t=>L(e._id||e.id,!0),class:"approve-btn"}," 通过 ",8,Ko)),e.isActive?(c(),l("button",{key:1,onClick:t=>L(e._id||e.id,!1),class:"reject-btn"}," 禁用 ",8,Go)):y("",!0),u("button",{onClick:t=>(async e=>{var t,s;if(confirm("确定要删除这个友情链接吗？"))try{await E.deleteFriendLink(e),await P(),alert("友情链接删除成功!")}catch(n){alert("删除失败: "+((null==(s=null==(t=n.response)?void 0:t.data)?void 0:s.message)||n.message))}})(e._id||e.id),class:"delete-btn"},"删除",8,Qo)])]);var t,s}),128))])),C.value||A.value||0!==s.value.length?y("",!0):(c(),l("div",Yo,t[18]||(t[18]=[u("h3",null,"暂无友情链接",-1),u("p",null,"还没有任何友情链接，点击添加按钮开始创建",-1)]))),(c(),d(k,{to:"body"},[n.value||g.value?(c(),l("div",{key:0,class:"modal-overlay",onClick:U},[u("div",{class:"modal-content",onClick:t[12]||(t[12]=_(()=>{},["stop"]))},[u("div",Zo,[u("h3",null,b(R.value?"编辑友情链接":"添加友情链接"),1),u("button",{onClick:U,class:"close-btn"},"✕")]),u("div",er,[u("form",{onSubmit:_(j,["prevent"])},[u("div",tr,[t[19]||(t[19]=u("label",null,"网站名称",-1)),h(u("input",{"onUpdate:modelValue":t[4]||(t[4]=e=>O.name=e),type:"text",required:""},null,512),[[p,O.name]])]),u("div",sr,[t[20]||(t[20]=u("label",null,"网站地址",-1)),u("div",nr,[h(u("input",{"onUpdate:modelValue":t[5]||(t[5]=e=>O.url=e),type:"text",required:"",placeholder:"例如：www.example.com 或 https://www.example.com",onBlur:N},null,544),[[p,O.url]]),u("button",{type:"button",onClick:q,class:"fetch-favicon-btn",disabled:T.value||!O.url},b(T.value?"获取中...":"🔄 获取图标"),9,ar)])]),u("div",or,[t[21]||(t[21]=u("label",null,"网站描述",-1)),h(u("textarea",{"onUpdate:modelValue":t[6]||(t[6]=e=>O.description=e),rows:"3"},null,512),[[p,O.description]])]),u("div",rr,[t[23]||(t[23]=u("label",null,"分类",-1)),h(u("select",{"onUpdate:modelValue":t[7]||(t[7]=e=>O.category=e),required:""},t[22]||(t[22]=[u("option",{value:""},"选择分类",-1),u("option",{value:"个人博客"},"个人博客",-1),u("option",{value:"技术社区"},"技术社区",-1),u("option",{value:"学习资源"},"学习资源",-1),u("option",{value:"工具网站"},"工具网站",-1),u("option",{value:"其他"},"其他",-1)]),512),[[f,O.category]])]),u("div",ir,[t[24]||(t[24]=u("label",null,"网站Logo",-1)),u("div",lr,[h(u("input",{"onUpdate:modelValue":t[8]||(t[8]=e=>O.avatar=e),type:"url",placeholder:"自动获取或手动输入Logo地址"},null,512),[[p,O.avatar]]),O.avatar?(c(),l("div",cr,[u("img",{src:O.avatar,alt:"Logo预览",onError:B},null,40,ur)])):y("",!0)]),t[25]||(t[25]=u("small",{class:"form-hint"},"留空将自动获取网站favicon作为Logo",-1))]),u("div",dr,[t[26]||(t[26]=u("label",null,"联系邮箱",-1)),h(u("input",{"onUpdate:modelValue":t[9]||(t[9]=e=>O.email=e),type:"email"},null,512),[[p,O.email]])]),u("div",hr,[t[27]||(t[27]=u("label",null,"联系信息",-1)),h(u("input",{"onUpdate:modelValue":t[10]||(t[10]=e=>O.contactInfo=e),type:"text",placeholder:"QQ、微信等联系方式"},null,512),[[p,O.contactInfo]])]),u("div",pr,[t[29]||(t[29]=u("label",null,"状态",-1)),h(u("select",{"onUpdate:modelValue":t[11]||(t[11]=e=>O.isActive=e)},t[28]||(t[28]=[u("option",{value:"false"},"待审核",-1),u("option",{value:"true"},"已通过",-1)]),512),[[f,O.isActive]])]),u("div",fr,[u("button",{type:"button",onClick:U,class:"cancel-btn"},"取消"),u("button",mr,b(R.value?"更新":"创建"),1)])],32)])])])):y("",!0)]))]))}},[["__scopeId","data-v-fd051ab8"]]),gr={class:"admin-gallery-manager"},yr={class:"manager-header"},br={class:"header-actions"},wr={key:0,class:"batch-actions"},_r={class:"selection-count"},kr={class:"filter-bar"},xr={class:"filter-controls"},Cr={class:"select-controls"},Ar={class:"select-all-control"},Sr=["checked","indeterminate"],Ir={key:0,class:"loading-state"},$r={key:1,class:"error-state"},Tr={key:2,class:"gallery-grid"},Or={class:"selection-checkbox"},Rr=["checked","onChange"],Pr={class:"image-preview"},Er=["src","alt"],Dr={class:"image-overlay"},jr=["onClick"],Lr=["onClick"],Ur={class:"image-info"},Mr={class:"image-title"},qr={class:"image-meta"},Nr={class:"category"},Br={class:"upload-date"},Wr={key:0,class:"image-tags"},Vr={key:3,class:"empty-state"},Fr={class:"modal-body"},Xr={class:"form-group"},zr=["value"],Hr={key:0,class:"mt-2"},Jr={key:0,class:"form-group"},Kr={class:"tags-selection"},Gr=["id","value"],Qr=["for"],Yr={class:"tag-item"},Zr={class:"form-group"},ei={class:"status-selection"},ti={key:1,class:"selected-files"},si={class:"file-list"},ni=["src","alt"],ai={class:"file-info"},oi={class:"file-name"},ri={class:"file-size"},ii=["onClick"],li={class:"modal-footer"},ci=["disabled"],ui={class:"modal-body"},di={class:"form-group"},hi={class:"form-group"},pi=["value"],fi={class:"form-group"},mi={class:"form-group"},vi={class:"visibility-options"},gi={class:"form-group"},yi={key:0,class:"modal-overlay"},bi={class:"modal-content batch-delete-modal"},wi={class:"modal-body"},_i={class:"preview-images"},ki=["src","alt"],xi={key:0,class:"more-count"},Ci={class:"modal-footer"},Ai=["disabled"],Si=t({__name:"AdminGalleryManager",setup(e){const t=a([]),s=a([]),n=a([]),S=a(!1),I=a(!1),$=a(!1),T=a([]),O=a(!1),R=a(!1),P=a(""),E=a(""),j=a(!1),L=a(""),U=a([]),M=a(null),q=a(!1),N=a(["摄影","游戏","编程","设计"]),B=o({category:"",tags:[],otherTagEnabled:!1,newTagText:"",isPublic:"true",otherCategoryEnabled:!1,newCategoryText:""}),W=o({id:null,title:"",category:"",secondaryTagsInput:"",secondaryTags:[],isPublic:!0,status:"draft"}),V=r(()=>s.value.length>0&&n.value.length===s.value.length),F=r(()=>n.value.length>0&&n.value.length<s.value.length),X=r(()=>K(B.category)),z=async()=>{await Promise.all([oe(),H()]),J()},H=async()=>{try{const e=await D.getTags();e.success&&(U.value=e.data||[])}catch(e){}},J=()=>{const e=new Set(["摄影","游戏","编程","设计"]);t.value.forEach(t=>{t.category&&e.add(t.category)}),N.value=Array.from(e).sort()},K=e=>{if(!e)return U.value;const s=t.value.filter(t=>t.category===e),n=new Set;return s.forEach(e=>{e.secondaryTags&&e.secondaryTags.length>0&&e.secondaryTags.forEach(e=>n.add(e))}),Array.from(n)},G=e=>n.value.some(t=>(t._id||t.id)===(e._id||e.id)),Q=()=>{V.value?n.value=[]:n.value=[...s.value]},Y=()=>{n.value=[]},Z=()=>{B.tags=[],B.otherTagEnabled=!1,B.newTagText="","__other__"!==B.category&&(B.newCategoryText="")},ee=()=>{0!==n.value.length&&($.value=!0)},te=async()=>{var e,t;R.value=!0;try{const e=n.value.map(e=>D.deleteImage(e._id||e.id));await Promise.all(e),alert(`成功删除 ${n.value.length} 张图片！`),n.value=[],$.value=!1,await oe(),J()}catch(s){alert("批量删除失败: "+((null==(t=null==(e=s.response)?void 0:e.data)?void 0:t.message)||s.message))}finally{R.value=!1}},se=()=>{$.value=!1},ne=async()=>{var e,t;if(0!==T.value.length)if(B.category)if("__other__"!==B.category||B.newCategoryText.trim()){O.value=!0;try{const e="__other__"===B.category?B.newCategoryText.trim():B.category;for(let t=0;t<T.value.length;t++){const s=T.value[t],n=new FormData;n.append("image",s.file),n.append("title",s.name.split(".")[0]),n.append("category",e),n.append("isPublic",B.isPublic),n.append("status","published");let a=[...B.tags];if(B.otherTagEnabled&&B.newTagText){const e=B.newTagText.split(",").map(e=>e.trim()).filter(Boolean);a=[...a,...e]}n.append("secondaryTags",JSON.stringify(a)),await D.uploadImage(n)}alert("图片上传成功!"),await z(),fe()}catch(s){alert("上传失败: "+((null==(t=null==(e=s.response)?void 0:e.data)?void 0:t.message)||s.message))}finally{O.value=!1}}else alert("请输入新分类名称");else alert("请选择分类")},ae=()=>{let e=t.value;if(P.value&&(e=e.filter(e=>e.category===P.value)),E.value){const t=E.value.toLowerCase();e=e.filter(e=>{var s;return e.title.toLowerCase().includes(t)||(null==(s=e.description)?void 0:s.toLowerCase().includes(t))})}s.value=e,n.value=n.value.filter(t=>e.some(e=>(e._id||e.id)===(t._id||t.id)))},oe=async()=>{j.value=!0,L.value="";try{const e=await D.getAllImages();if(!e.success)throw new Error(e.message||"获取图片列表失败");t.value=e.data||[],s.value=e.data||[]}catch(e){L.value=e.message||"获取图片列表失败，请稍后重试",t.value=[],s.value=[]}finally{j.value=!1}},re=e=>{const t=Array.from(e.target.files);he(t)},ie=()=>{M.value.click()},le=e=>{e.preventDefault(),q.value=!1;const t=Array.from(e.dataTransfer.files);he(t)},ce=e=>{e.preventDefault(),q.value=!0},ue=e=>{e.preventDefault(),e.currentTarget.contains(e.relatedTarget)||(q.value=!1)},de=e=>{e.preventDefault()},he=e=>{e.forEach(e=>{if(e.type.startsWith("image/")){const t=new FileReader;t.onload=t=>{T.value.push({file:e,name:e.name,size:e.size,preview:t.target.result})},t.readAsDataURL(e)}})},pe=async()=>{var e,t;try{const e={title:W.title,category:W.category,secondaryTags:W.secondaryTagsInput.split(",").map(e=>e.trim()).filter(Boolean),isPublic:W.isPublic,status:W.status};await D.updateImage(W.id,e),alert("图片信息更新成功!"),me(),await oe()}catch(s){alert("保存失败: "+((null==(t=null==(e=s.response)?void 0:e.data)?void 0:t.message)||s.message))}},fe=()=>{S.value=!1,T.value=[],q.value=!1,Object.assign(B,{category:"",tags:[],otherTagEnabled:!1,newTagText:"",isPublic:"true",otherCategoryEnabled:!1,newCategoryText:""})},me=()=>{I.value=!1,Object.assign(W,{id:null,title:"",category:"",secondaryTagsInput:"",secondaryTags:[],isPublic:!0,status:"draft"})},ve=e=>{if(0===e)return"0 Bytes";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["Bytes","KB","MB","GB"][t]},ge=e=>{if(!e)return"/placeholder.jpg";if(e.startsWith("http"))return e;const t="undefined"==typeof window||"shirakawananase.top"!==window.location.hostname&&!window.location.hostname.endsWith(".shirakawananase.top")?"http://localhost:3000":"https://api.shirakawananase.top";return e.startsWith("/")?`${t}${e}`:`${t}/${e}`};return i(()=>{z()}),(e,t)=>(c(),l("div",gr,[u("div",yr,[t[18]||(t[18]=u("h2",null,"图库管理",-1)),u("div",br,[n.value.length>0?(c(),l("div",wr,[u("span",_r,"已选择 "+b(n.value.length)+" 张图片",1),u("button",{onClick:ee,class:"batch-delete-btn"}," 🗑️ 批量删除 ("+b(n.value.length)+") ",1),u("button",{onClick:Y,class:"clear-selection-btn"}," ✕ 取消选择 ")])):y("",!0),u("button",{onClick:t[0]||(t[0]=e=>S.value=!0),class:"upload-btn"}," 📷 上传图片 ")])]),u("div",kr,[u("div",xr,[h(u("select",{"onUpdate:modelValue":t[1]||(t[1]=e=>P.value=e),onChange:ae},t[19]||(t[19]=[x('<option value="" data-v-1565dc1b>全部分类</option><option value="摄影" data-v-1565dc1b>摄影</option><option value="游戏" data-v-1565dc1b>游戏</option><option value="编程" data-v-1565dc1b>编程</option><option value="设计" data-v-1565dc1b>设计</option>',5)]),544),[[f,P.value]]),h(u("input",{"onUpdate:modelValue":t[2]||(t[2]=e=>E.value=e),placeholder:"搜索图片标题...",onInput:ae},null,544),[[p,E.value]])]),u("div",Cr,[u("label",Ar,[u("input",{type:"checkbox",checked:V.value,indeterminate:F.value,onChange:Q},null,40,Sr),u("span",null,"全选 ("+b(s.value.length)+")",1)])])]),j.value?(c(),l("div",Ir,t[20]||(t[20]=[u("div",{class:"loading-spinner"},null,-1),u("p",null,"正在加载图片...",-1)]))):L.value?(c(),l("div",$r,[t[21]||(t[21]=u("div",{class:"error-icon"},"😞",-1)),t[22]||(t[22]=u("h3",null,"加载失败",-1)),u("p",null,b(L.value),1),u("button",{onClick:oe,class:"retry-btn"},"重试")])):(c(),l("div",Tr,[(c(!0),l(m,null,v(s.value,e=>{return c(),l("div",{key:e._id||e.id,class:w(["image-card",{selected:G(e)}])},[u("div",Or,[u("input",{type:"checkbox",checked:G(e),onChange:t=>(e=>{const t=e._id||e.id,s=n.value.findIndex(e=>(e._id||e.id)===t);-1===s?n.value.push(e):n.value.splice(s,1)})(e)},null,40,Rr)]),u("div",Pr,[u("img",{src:ge(e.thumbnail||e.url),alt:e.title},null,8,Er),u("div",Dr,[u("button",{onClick:t=>(e=>{Object.assign(W,{id:e._id||e.id,title:e.title,category:e.category,secondaryTagsInput:(e.secondaryTags||[]).join(", "),secondaryTags:e.secondaryTags||[],isPublic:e.isPublic,status:e.status}),I.value=!0})(e),class:"edit-btn"},"编辑",8,jr),u("button",{onClick:t=>(async e=>{var t,s;if(confirm("确定要删除这张图片吗？"))try{await D.deleteImage(e),alert("图片删除成功!"),await oe(),J()}catch(n){alert("删除失败: "+((null==(s=null==(t=n.response)?void 0:t.data)?void 0:s.message)||n.message))}})(e._id||e.id),class:"delete-btn"},"删除",8,Lr)])]),u("div",Ur,[u("div",Mr,b(e.title),1),u("div",qr,[u("span",Nr,b(e.category),1),u("span",Br,b((t=e.date||e.createdAt,new Date(t).toLocaleDateString("zh-CN"))),1),u("span",{class:w(["status",e.isPublic?"public":"private"])},b(e.isPublic?"公开":"私有"),3),u("span",{class:w(["publish-status",e.status])},b("published"===e.status?"已发布":"未发布"),3)]),e.secondaryTags&&e.secondaryTags.length?(c(),l("div",Wr,[(c(!0),l(m,null,v(e.secondaryTags,e=>(c(),l("span",{key:e,class:"tag"},b(e),1))),128))])):y("",!0)])],2);var t}),128))])),j.value||L.value||0!==s.value.length?y("",!0):(c(),l("div",Vr,t[23]||(t[23]=[u("div",{class:"empty-icon"},"🖼️",-1),u("h3",null,"暂无图片",-1),u("p",null,"还没有上传任何图片，点击上传按钮开始添加图片",-1)]))),(c(),d(k,{to:"body"},[S.value?(c(),l("div",{key:0,class:"modal-overlay",onClick:fe},[u("div",{class:"modal-content",onClick:t[10]||(t[10]=_(()=>{},["stop"]))},[u("div",{class:"modal-header"},[t[24]||(t[24]=u("h3",null,"上传图片",-1)),u("button",{onClick:fe,class:"close-btn"},"✕")]),u("div",Fr,[u("div",Xr,[t[27]||(t[27]=u("label",null,"分类 (一级标签)",-1)),h(u("select",{"onUpdate:modelValue":t[3]||(t[3]=e=>B.category=e),onChange:Z,required:""},[t[25]||(t[25]=u("option",{value:""},"选择分类",-1)),(c(!0),l(m,null,v(N.value,e=>(c(),l("option",{key:e,value:e},b(e),9,zr))),128)),t[26]||(t[26]=u("option",{value:"__other__"},"其他",-1))],544),[[f,B.category]]),"__other__"===B.category?(c(),l("div",Hr,[h(u("input",{"onUpdate:modelValue":t[4]||(t[4]=e=>B.newCategoryText=e),type:"text",placeholder:"输入新分类名称",required:"",class:"form-control"},null,512),[[p,B.newCategoryText]])])):y("",!0)]),B.category?(c(),l("div",Jr,[t[29]||(t[29]=u("label",null,"二级标签 (可多选)",-1)),u("div",Kr,[(c(!0),l(m,null,v(X.value,e=>(c(),l("div",{key:e,class:"tag-item"},[h(u("input",{type:"checkbox",id:`upload-tag-${e}`,value:e,"onUpdate:modelValue":t[5]||(t[5]=e=>B.tags=e)},null,8,Gr),[[C,B.tags]]),u("label",{for:`upload-tag-${e}`},b(e),9,Qr)]))),128)),u("div",Yr,[h(u("input",{type:"checkbox",id:"upload-other-tag","onUpdate:modelValue":t[6]||(t[6]=e=>B.otherTagEnabled=e)},null,512),[[C,B.otherTagEnabled]]),t[28]||(t[28]=u("label",{for:"upload-other-tag"},"其他",-1)),B.otherTagEnabled?h((c(),l("input",{key:0,"onUpdate:modelValue":t[7]||(t[7]=e=>B.newTagText=e),placeholder:"新标签,逗号分隔"},null,512)),[[p,B.newTagText]]):y("",!0)])]),t[30]||(t[30]=u("p",{class:"helper-text"},"请先选择分类，然后选择相应的二级标签",-1))])):y("",!0),u("div",Zr,[t[33]||(t[33]=u("label",null,"状态",-1)),u("div",ei,[h(u("input",{type:"radio",id:"upload-public",value:"true","onUpdate:modelValue":t[8]||(t[8]=e=>B.isPublic=e)},null,512),[[A,B.isPublic]]),t[31]||(t[31]=u("label",{for:"upload-public"},"公开",-1)),h(u("input",{type:"radio",id:"upload-private",value:"false","onUpdate:modelValue":t[9]||(t[9]=e=>B.isPublic=e)},null,512),[[A,B.isPublic]]),t[32]||(t[32]=u("label",{for:"upload-private"},"私有",-1))])]),u("div",{class:w(["upload-area",{"drag-over":q.value}]),onClick:ie,onDrop:le,onDragover:de,onDragenter:ce,onDragleave:ue},[u("input",{ref_key:"fileInput",ref:M,type:"file",multiple:"",accept:"image/*",onChange:re,class:"file-input"},null,544),t[34]||(t[34]=u("div",{class:"upload-text"},[u("p",null,"拖拽图片到此处或点击选择文件"),u("p",{class:"upload-hint"},"支持多文件选择，格式：JPG、PNG、GIF等")],-1))],34),T.value.length>0?(c(),l("div",ti,[u("h4",null,"待上传文件 ("+b(T.value.length)+")",1),u("div",si,[(c(!0),l(m,null,v(T.value,(e,t)=>(c(),l("div",{key:t,class:"file-item"},[u("img",{src:e.preview,alt:e.name,class:"file-preview"},null,8,ni),u("div",ai,[u("div",oi,b(e.name),1),u("div",ri,b(ve(e.size)),1)]),u("button",{onClick:e=>(e=>{T.value.splice(e,1)})(t),class:"remove-file"},"✕",8,ii)]))),128))])])):y("",!0)]),u("div",li,[u("button",{onClick:fe,class:"cancel-btn"},"取消"),u("button",{onClick:ne,disabled:0===T.value.length||O.value,class:"upload-confirm-btn"},b(O.value?"上传中...":`上传 ${T.value.length} 张图片`),9,ci)])])])):y("",!0)])),(c(),d(k,{to:"body"},[I.value?(c(),l("div",{key:0,class:"modal-overlay",onClick:me},[u("div",{class:"modal-content",onClick:t[17]||(t[17]=_(()=>{},["stop"]))},[u("div",{class:"modal-header"},[t[35]||(t[35]=u("h3",null,"编辑图片",-1)),u("button",{onClick:me,class:"close-btn"},"✕")]),u("div",ui,[u("form",{onSubmit:_(pe,["prevent"])},[u("div",di,[t[36]||(t[36]=u("label",null,"标题",-1)),h(u("input",{"onUpdate:modelValue":t[11]||(t[11]=e=>W.title=e),type:"text",required:""},null,512),[[p,W.title]])]),u("div",hi,[t[38]||(t[38]=u("label",null,"分类",-1)),h(u("select",{"onUpdate:modelValue":t[12]||(t[12]=e=>W.category=e),required:""},[t[37]||(t[37]=u("option",{value:""},"选择分类",-1)),(c(!0),l(m,null,v(N.value,e=>(c(),l("option",{key:e,value:e},b(e),9,pi))),128))],512),[[f,W.category]])]),u("div",fi,[t[39]||(t[39]=u("label",null,"二级标签",-1)),h(u("input",{"onUpdate:modelValue":t[13]||(t[13]=e=>W.secondaryTagsInput=e),type:"text",placeholder:"用逗号分隔多个标签，如：夜景,城市,建筑"},null,512),[[p,W.secondaryTagsInput]])]),u("div",mi,[t[42]||(t[42]=u("label",null,"可见性",-1)),u("div",vi,[u("label",null,[h(u("input",{type:"radio",value:!0,"onUpdate:modelValue":t[14]||(t[14]=e=>W.isPublic=e)},null,512),[[A,W.isPublic]]),t[40]||(t[40]=g(" 公开 "))]),u("label",null,[h(u("input",{type:"radio",value:!1,"onUpdate:modelValue":t[15]||(t[15]=e=>W.isPublic=e)},null,512),[[A,W.isPublic]]),t[41]||(t[41]=g(" 私有 "))])])]),u("div",gi,[t[44]||(t[44]=u("label",null,"发布状态",-1)),h(u("select",{"onUpdate:modelValue":t[16]||(t[16]=e=>W.status=e)},t[43]||(t[43]=[u("option",{value:"draft"},"未发布",-1),u("option",{value:"published"},"已发布",-1)]),512),[[f,W.status]])]),u("div",{class:"form-actions"},[u("button",{type:"button",onClick:me,class:"cancel-btn"},"取消"),t[45]||(t[45]=u("button",{type:"submit",class:"save-btn"},"保存",-1))])],32)])])])):y("",!0)])),(c(),d(k,{to:"body"},[$.value?(c(),l("div",yi,[u("div",bi,[t[49]||(t[49]=u("div",{class:"modal-header"},[u("h3",null,"⚠️ 确认批量删除")],-1)),u("div",wi,[u("p",null,[t[46]||(t[46]=g("您即将删除 ")),u("strong",null,b(n.value.length),1),t[47]||(t[47]=g(" 张图片"))]),t[48]||(t[48]=u("p",{class:"warning-text"},"此操作不可撤销，确定要继续吗？",-1)),u("div",_i,[(c(!0),l(m,null,v(n.value.slice(0,6),e=>(c(),l("img",{key:e._id||e.id,src:ge(e.thumbnail),alt:e.title,class:"preview-thumb"},null,8,ki))),128)),n.value.length>6?(c(),l("div",xi," +"+b(n.value.length-6),1)):y("",!0)])]),u("div",Ci,[u("button",{onClick:se,class:"cancel-btn"},"取消"),u("button",{onClick:te,disabled:R.value,class:"danger-btn"},b(R.value?"删除中...":"确认删除"),9,Ai)])])])):y("",!0)]))]))}},[["__scopeId","data-v-1565dc1b"]]),Ii={class:"admin-document-manager"},$i={class:"manager-header"},Ti={class:"filter-bar"},Oi=["value"],Ri={key:0,class:"loading-state"},Pi={key:1,class:"error-state"},Ei={key:2,class:"document-list"},Di={class:"doc-icon"},ji={class:"document-info"},Li={class:"document-meta"},Ui={class:"doc-category"},Mi={class:"doc-type"},qi={class:"doc-size"},Ni={class:"doc-date"},Bi={key:0,class:"doc-tags"},Wi={class:"document-actions"},Vi=["onClick"],Fi=["onClick"],Xi=["onClick"],zi={key:3,class:"empty-state"},Hi={class:"modal-header"},Ji={class:"modal-body"},Ki={key:0,class:"form-group"},Gi={key:0,class:"upload-placeholder"},Qi={key:1,class:"selected-file"},Yi={class:"file-details"},Zi={class:"file-name"},el={class:"file-size"},tl={class:"form-group"},sl={class:"form-group"},nl={class:"form-group"},al=["value"],ol={key:0,class:"mt-2"},rl={class:"form-group"},il={key:1,class:"form-group"},ll={class:"current-file-info"},cl={class:"file-size"},ul={class:"form-group"},dl={key:2,class:"upload-progress"},hl={class:"progress-bar"},pl={class:"progress-text"},fl={class:"form-actions"},ml=["disabled"],vl=["disabled"],gl={key:0},yl={key:1},bl=t({__name:"AdminDocumentManager",setup(e){const t=a([]),s=a([]),n=a(!1),r=a(!1),C=a(null),A=a(""),I=a(""),$=a(""),T=a(!1),R=a(""),P=a(!1),E=a(0),D=o({id:null,title:"",description:"",category:"",newCategoryText:"",secondaryTagsInput:"",secondaryTags:[],type:"",size:"",downloadUrl:"",previewUrl:"",status:"draft"}),L=a(["前端开发","游戏攻略","AI技术","音乐制作","模板资源"]),U=()=>{"__other__"!==D.category&&(D.newCategoryText="")},M=()=>{let e=t.value;if(A.value&&(e=e.filter(e=>e.category===A.value)),I.value&&(e=e.filter(e=>e.type===I.value)),$.value){const t=$.value.toLowerCase();e=e.filter(e=>{var s,n;return e.title.toLowerCase().includes(t)||(null==(s=e.description)?void 0:s.toLowerCase().includes(t))||(null==(n=e.secondaryTags)?void 0:n.some(e=>e.toLowerCase().includes(t)))})}s.value=e},q=e=>e.split(".").pop().toUpperCase(),N=e=>{if(0===e)return"0 Bytes";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["Bytes","KB","MB","GB"][t]},B=e=>{const t=e.target.files[0];t&&V(t)},W=e=>{const t=e.dataTransfer.files;t.length>0&&V(t[0])},V=e=>{if(e.size>52428800)return void alert("文件大小超过50MB限制，请选择较小的文件");const t=e.name.toLowerCase();[".pdf",".doc",".docx",".ppt",".pptx",".xls",".xlsx",".txt",".md"].some(e=>t.endsWith(e))?(C.value=e,D.type=q(e.name),D.size=N(e.size),D.title||(D.title=e.name.split(".")[0])):alert("不支持的文件类型，请选择 PDF、Word、PowerPoint、Excel、TXT 或 Markdown 文件")},F=()=>{var e;C.value=null,D.type="",D.size="",(null==(e=document.refs)?void 0:e.fileInput)&&(document.refs.fileInput.value="")},X=async()=>{T.value=!0,R.value="";try{0;const e=await O.getAllDocuments();if(!e.success)throw new Error(e.message||"获取文档列表失败");{const n=e.data.documents||e.data||[];0,t.value=n,s.value=n,(()=>{const e=new Set(["前端开发","游戏攻略","AI技术","音乐制作","模板资源"]);t.value.forEach(t=>{t.category&&e.add(t.category)}),L.value=Array.from(e).sort()})()}}catch(e){}finally{T.value=!1}},z=async()=>{try{P.value=!0,E.value=0;const e="__other__"===D.category?D.newCategoryText.trim():D.category,t={title:D.title,description:D.description,category:e,secondaryTags:D.secondaryTagsInput.split(",").map(e=>e.trim()).filter(Boolean),type:D.type,size:D.size,status:D.status};if(!t.title)return void alert("请填写文档标题");if(!t.category)return void alert("请选择文档分类");if("__other__"===D.category&&!D.newCategoryText.trim())return void alert("请输入新分类名称");if(n.value&&!C.value)return void alert("请选择要上传的文档文件");let s;if(n.value)if(C.value){const e=setInterval(()=>{E.value<90&&(E.value+=20*Math.random())},200),n=new FormData;n.append("document",C.value),n.append("title",t.title),n.append("description",t.description),n.append("category",t.category),n.append("type",t.type),n.append("status",t.status),t.secondaryTags.length>0&&n.append("secondaryTags",JSON.stringify(t.secondaryTags));for(let[t,s]of n.entries());try{s=await O.uploadDocumentFile(n),E.value=100}finally{clearInterval(e)}}else s=await O.createDocument(t);else E.value=50,s=await O.updateDocument(D.id,t),E.value=100;if(!s.success)throw new Error(s.message||"保存失败");await X(),H(),alert(n.value?"文档上传成功!":"文档更新成功!")}catch(e){let t="保存失败";if(e.response){const s=e.response.data;switch(s.message&&(t+=": "+s.message),e.response.status){case 400:t="数据验证失败 - 请检查所有必填字段是否正确填写",s.errors&&(t+="\n详细错误: "+JSON.stringify(s.errors));break;case 401:t="认证失败 - 请重新登录";break;case 403:t="权限不足 - 您没有权限执行此操作";break;case 500:t="服务器内部错误 - 请稍后重试"}}else t=e.request?"网络连接失败 - 请检查网络连接":e.message;alert(t)}finally{P.value=!1,E.value=0}},H=()=>{n.value=!1,r.value=!1,C.value=null,document.querySelector('input[type="file"]')&&(document.querySelector('input[type="file"]').value=""),Object.assign(D,{id:null,title:"",description:"",category:"",newCategoryText:"",secondaryTagsInput:"",secondaryTags:[],type:"",size:"",status:"draft"})},J=e=>({PDF:"fas fa-file-pdf",DOCX:"fas fa-file-word",PPT:"fas fa-file-powerpoint",XLSX:"fas fa-file-excel",TXT:"fas fa-file-alt"}[e]||"fas fa-file"),K=e=>{if(!e)return"未知日期";const t=new Date(e);return isNaN(t.getTime())?"未知日期":t.toLocaleDateString("zh-CN")};return i(()=>{X()}),(e,t)=>{var a;return c(),l("div",Ii,[u("div",$i,[t[13]||(t[13]=u("h2",null,"文档管理",-1)),u("button",{onClick:t[0]||(t[0]=e=>n.value=!0),class:"create-btn"}," 📄 上传文档 ")]),u("div",Ti,[h(u("select",{"onUpdate:modelValue":t[1]||(t[1]=e=>A.value=e),onChange:M},[t[14]||(t[14]=u("option",{value:""},"全部分类",-1)),(c(!0),l(m,null,v(L.value,e=>(c(),l("option",{key:e,value:e},b(e),9,Oi))),128))],544),[[f,A.value]]),h(u("select",{"onUpdate:modelValue":t[2]||(t[2]=e=>I.value=e),onChange:M},t[15]||(t[15]=[x('<option value="" data-v-fe8f1588>全部类型</option><option value="PDF" data-v-fe8f1588>PDF</option><option value="DOCX" data-v-fe8f1588>DOCX</option><option value="PPT" data-v-fe8f1588>PPT</option><option value="XLSX" data-v-fe8f1588>XLSX</option><option value="TXT" data-v-fe8f1588>TXT</option><option value="MD" data-v-fe8f1588>MD</option>',7)]),544),[[f,I.value]]),h(u("input",{"onUpdate:modelValue":t[3]||(t[3]=e=>$.value=e),placeholder:"搜索文档标题或描述...",onInput:M},null,544),[[p,$.value]])]),T.value?(c(),l("div",Ri,t[16]||(t[16]=[u("p",null,"正在加载文档...",-1)]))):R.value?(c(),l("div",Pi,[t[17]||(t[17]=u("h3",null,"加载失败",-1)),u("p",null,b(R.value),1),u("button",{onClick:X,class:"retry-btn"},"重试")])):(c(),l("div",Ei,[(c(!0),l(m,null,v(s.value,e=>{return c(),l("div",{key:e._id||e.id,class:"document-card"},[u("div",Di,[u("i",{class:w(J(e.type))},null,2)]),u("div",ji,[u("h3",null,b(e.title),1),u("p",null,b(e.description),1),u("div",Li,[u("span",Ui,b(e.category),1),u("span",Mi,b(e.type),1),u("span",qi,b(e.size||e.formattedSize),1),u("span",Ni,b(K(e.date||e.createdAt)),1),u("span",{class:w(["status",e.status])},b((t=e.status,{draft:"私人",published:"公开",pinned:"置顶"}[t]||"未知")),3)]),e.secondaryTags&&e.secondaryTags.length?(c(),l("div",Bi,[(c(!0),l(m,null,v(e.secondaryTags,e=>(c(),l("span",{key:e,class:"tag"},b(e),1))),128))])):y("",!0)]),u("div",Wi,[u("button",{onClick:t=>(e=>{var t;Object.assign(D,{id:e.id,title:e.title,description:e.description,category:e.category,newCategoryText:"",secondaryTagsInput:(null==(t=e.secondaryTags)?void 0:t.join(","))||"",secondaryTags:e.secondaryTags||[],type:e.type,size:e.size,downloadUrl:e.downloadUrl,previewUrl:e.previewUrl,status:e.status}),r.value=!0})(e),class:"edit-btn"},"编辑",8,Vi),u("button",{onClick:t=>(async e=>{var t,s;if(confirm("确定要删除这个文档吗？"))try{(await O.deleteDocument(e)).success&&(await X(),alert("文档删除成功!"))}catch(n){alert("删除失败: "+((null==(s=null==(t=n.response)?void 0:t.data)?void 0:s.message)||n.message))}})(e._id||e.id),class:"delete-btn"},"删除",8,Fi),u("button",{onClick:t=>(async e=>{var t,s,n;try{const s=await j.downloadDocument(e._id||e.id),n=window.URL.createObjectURL(s),a=document.createElement("a");a.href=n,a.download=`${e.title}.${(null==(t=e.type)?void 0:t.toLowerCase())||"file"}`,a.style.display="none",document.body.appendChild(a),a.click(),document.body.removeChild(a),window.URL.revokeObjectURL(n)}catch(a){alert("下载失败："+((null==(n=null==(s=a.response)?void 0:s.data)?void 0:n.message)||a.message||"请稍后重试"))}})(e),class:"download-btn"},"下载",8,Xi)])]);var t}),128))])),T.value||R.value||0!==s.value.length?y("",!0):(c(),l("div",zi,t[18]||(t[18]=[u("h3",null,"暂无文档",-1),u("p",null,"还没有上传任何文档，点击创建按钮开始添加文档",-1)]))),(c(),d(k,{to:"body"},[n.value||r.value?(c(),l("div",{key:0,class:"modal-overlay",onClick:H},[u("div",{class:"modal-content",onClick:t[12]||(t[12]=_(()=>{},["stop"]))},[u("div",Hi,[u("h3",null,b(n.value?"上传文档":"编辑文档"),1),u("button",{onClick:H,class:"close-btn"},"✕")]),u("div",Ji,[u("form",{onSubmit:_(z,["prevent"])},[n.value?(c(),l("div",Ki,[t[20]||(t[20]=u("label",null,"📁 选择文档文件",-1)),u("div",{class:"file-upload-area",onClick:t[4]||(t[4]=t=>{var s;return null==(s=e.$refs.fileInput)?void 0:s.click()}),onDragover:t[5]||(t[5]=_(()=>{},["prevent"])),onDrop:_(W,["prevent"])},[u("input",{ref:"fileInput",type:"file",onChange:B,accept:".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.txt,.md",style:{display:"none"}},null,544),C.value?(c(),l("div",Qi,[u("i",{class:w([J(q(C.value.name)),"file-icon"])},null,2),u("div",Yi,[u("span",Zi,b(C.value.name),1),u("span",el,b(N(C.value.size)),1)]),u("button",{type:"button",onClick:_(F,["stop"]),class:"remove-file-btn"},"✕")])):(c(),l("div",Gi,t[19]||(t[19]=[u("i",{class:"fas fa-cloud-upload-alt upload-icon"},null,-1),u("p",null,"点击选择文件或拖拽文件到此处",-1),u("p",{class:"upload-hint"},"支持 PDF、Word、PowerPoint、Excel、TXT、Markdown 文件",-1),u("p",{class:"size-limit"},"文件大小限制：50MB",-1)])))],32)])):y("",!0),u("div",tl,[t[21]||(t[21]=u("label",null,"标题",-1)),h(u("input",{"onUpdate:modelValue":t[6]||(t[6]=e=>D.title=e),type:"text",required:""},null,512),[[p,D.title]])]),u("div",sl,[t[22]||(t[22]=u("label",null,"描述",-1)),h(u("textarea",{"onUpdate:modelValue":t[7]||(t[7]=e=>D.description=e),rows:"3"},null,512),[[p,D.description]])]),u("div",nl,[t[25]||(t[25]=u("label",null,"分类",-1)),h(u("select",{"onUpdate:modelValue":t[8]||(t[8]=e=>D.category=e),onChange:U,required:""},[t[23]||(t[23]=u("option",{value:""},"选择分类",-1)),(c(!0),l(m,null,v(L.value,e=>(c(),l("option",{key:e,value:e},b(e),9,al))),128)),t[24]||(t[24]=u("option",{value:"__other__"},"其他",-1))],544),[[f,D.category]]),"__other__"===D.category?(c(),l("div",ol,[h(u("input",{"onUpdate:modelValue":t[9]||(t[9]=e=>D.newCategoryText=e),type:"text",placeholder:"输入新分类名称",required:"",class:"form-control"},null,512),[[p,D.newCategoryText]])])):y("",!0)]),u("div",rl,[t[26]||(t[26]=u("label",null,"二级标签",-1)),h(u("input",{"onUpdate:modelValue":t[10]||(t[10]=e=>D.secondaryTagsInput=e),type:"text",placeholder:"用逗号分隔多个标签，如：Vue3,JavaScript,Composition API"},null,512),[[p,D.secondaryTagsInput]])]),r.value?(c(),l("div",il,[t[27]||(t[27]=u("label",null,"当前文件",-1)),u("div",ll,[u("i",{class:w(J(D.type))},null,2),u("span",null,b(D.title)+"."+b(null==(a=D.type)?void 0:a.toLowerCase()),1),u("span",cl,"("+b(D.size)+")",1)]),t[28]||(t[28]=u("p",{class:"file-note"},"💡 提示：要更换文件请重新上传",-1))])):y("",!0),u("div",ul,[t[30]||(t[30]=u("label",null,"状态",-1)),h(u("select",{"onUpdate:modelValue":t[11]||(t[11]=e=>D.status=e)},t[29]||(t[29]=[u("option",{value:"draft"},"私人",-1),u("option",{value:"published"},"公开",-1),u("option",{value:"pinned"},"置顶",-1)]),512),[[f,D.status]])]),P.value?(c(),l("div",dl,[u("div",hl,[u("div",{class:"progress-fill",style:S({width:E.value+"%"})},null,4)]),u("p",pl,b(n.value?"正在上传文档...":"正在保存...")+" "+b(E.value)+"%",1)])):y("",!0),u("div",fl,[u("button",{type:"button",onClick:H,disabled:P.value,class:"cancel-btn"},"取消",8,ml),u("button",{type:"submit",disabled:P.value,class:"save-btn"},[P.value?(c(),l("span",gl,[t[31]||(t[31]=u("i",{class:"fas fa-spinner fa-spin"},null,-1)),g(" "+b(n.value?"上传中...":"保存中..."),1)])):(c(),l("span",yl,b(n.value?"📁 上传文档":"💾 保存"),1))],8,vl)])],32)])])])):y("",!0)]))])}}},[["__scopeId","data-v-fe8f1588"]]),wl={class:"admin-comment-manager"},_l={class:"manager-header"},kl={class:"stats"},xl={class:"total-count"},Cl={class:"filter-bar"},Al={key:0,class:"loading-state"},Sl={key:1,class:"error-state"},Il={key:2,class:"comment-list"},$l={class:"comment-info"},Tl={class:"comment-header"},Ol={class:"user-info"},Rl={class:"commenter"},Pl={class:"comment-source"},El=["onClick","title"],Dl={class:"comment-meta"},jl={class:"comment-time"},Ll={key:0,class:"reply-indicator"},Ul={class:"comment-content"},Ml={key:0,class:"parent-comment"},ql={class:"parent-content"},Nl={class:"comment-actions"},Bl={class:"like-count"},Wl=["onClick"],Vl=["onClick"],Fl=["onClick"],Xl={key:3,class:"empty-state"},zl=t({__name:"AdminCommentReview",setup(e){const t=I(),s=a([]),n=a(""),o=a(""),d=a(""),g=a(!1),_=a(""),k=r(()=>s.value.length),x=async()=>{g.value=!0,_.value="";try{const e={};n.value&&(e.status=n.value),o.value&&(e.targetType=o.value),d.value&&(e.search=d.value);const t=await O.getAllComments(e);if(!t.success)throw new Error(t.message||"获取评论列表失败");s.value=t.data.comments||t.data||[]}catch(e){_.value=e.message||"获取评论列表失败，请稍后重试",s.value=[]}finally{g.value=!1}},C=e=>{if("blog"===e.targetType||"Blog"===e.targetType)if(e.targetId){const s="object"==typeof e.targetId?e.targetId.id||e.targetId._id:e.targetId;t.push(`/blog/${s}`)}else alert("博客ID缺失，无法跳转");else"comment"===e.targetType?t.push("/comments"):"document"===e.targetType||"Document"===e.targetType?e.targetTitle?t.push({path:"/documents",query:{search:e.targetTitle}}):t.push("/documents"):"General"===e.targetType?t.push("/comments"):"gallery"===e.targetType||"Gallery"===e.targetType?t.push("/gallery"):alert("无法确定跳转目标，可能是数据不完整")},A=e=>{const t={blog:"博客",Blog:"博客",comment:"评论区",General:"留言板"}[e.targetType]||"其他";const s=e.targetTitle||"";return"blog"===e.targetType||"Blog"===e.targetType?s?`博客：${s}`:"博客":"General"===e.targetType?"留言板":s?`${t}：${s}`:t},S=e=>{if(!e)return"未知时间";const t=new Date(e);return isNaN(t.getTime())?"未知时间":t.toLocaleString("zh-CN")};return i(()=>{x()}),(e,t)=>(c(),l("div",wl,[u("div",_l,[t[2]||(t[2]=u("h2",null,"评论管理",-1)),u("div",kl,[u("span",xl,"总评论: "+b(k.value),1)])]),u("div",Cl,[h(u("select",{"onUpdate:modelValue":t[0]||(t[0]=e=>o.value=e),onChange:x},t[3]||(t[3]=[u("option",{value:""},"全部来源",-1),u("option",{value:"blog"},"博客",-1),u("option",{value:"comment"},"评论区",-1),u("option",{value:"General"},"留言板",-1)]),544),[[f,o.value]]),h(u("input",{"onUpdate:modelValue":t[1]||(t[1]=e=>d.value=e),placeholder:"搜索评论内容或用户...",onInput:x},null,544),[[p,d.value]])]),g.value?(c(),l("div",Al,t[4]||(t[4]=[u("p",null,"正在加载评论...",-1)]))):_.value?(c(),l("div",Sl,[t[5]||(t[5]=u("h3",null,"加载失败",-1)),u("p",null,b(_.value),1),u("button",{onClick:x,class:"retry-btn"},"重试")])):(c(),l("div",Il,[(c(!0),l(m,null,v(s.value,e=>{var s;return c(),l("div",{key:e.id||e._id,class:"comment-card"},[u("div",$l,[u("div",Tl,[u("div",Ol,[u("span",Rl,b((null==(s=e.author)?void 0:s.username)||e.author||"匿名用户"),1)]),u("div",Pl,[t[6]||(t[6]=u("span",{class:"source-label"},"来源:",-1)),u("button",{onClick:t=>C(e),class:"source-link",title:`点击跳转到${A(e)}`},b(A(e)),9,El)])]),u("div",Dl,[u("span",jl,b(S(e.createdAt)),1),e.parentComment?(c(),l("span",Ll,"回复评论")):y("",!0)]),u("div",Ul,b(e.content),1),e.parentComment?(c(),l("div",Ml,[t[7]||(t[7]=u("span",{class:"parent-label"},"回复:",-1)),u("span",ql,b(e.parentComment.content),1)])):y("",!0)]),u("div",Nl,[u("span",Bl,b(e.likeCount||0)+" ❤️",1),u("button",{onClick:t=>(async e=>{var t,s;try{const t=!e.isPublic;(await O.updateCommentVisibility(e.id||e._id,t)).success&&(e.isPublic=t,alert("评论已"+(t?"设为公开":"设为私有")))}catch(n){alert("操作失败: "+((null==(s=null==(t=n.response)?void 0:t.data)?void 0:s.message)||n.message))}})(e),class:w(["visibility-btn",{private:!e.isPublic}])},b(e.isPublic?"🔒 设为私有":"🔓 设为公开"),11,Wl),u("button",{onClick:t=>C(e),class:"jump-btn"}," 🔗 跳转 ",8,Vl),u("button",{onClick:t=>(async e=>{var t,s;if(confirm("确定要删除这条评论吗？此操作不可恢复。"))try{(await O.deleteComment(e)).success&&(await x(),alert("评论已删除!"))}catch(n){alert("删除失败: "+((null==(s=null==(t=n.response)?void 0:t.data)?void 0:s.message)||n.message))}})(e.id||e._id),class:"delete-btn"}," 🗑️ 删除 ",8,Fl)])])}),128))])),g.value||_.value||0!==s.value.length?y("",!0):(c(),l("div",Xl,t[8]||(t[8]=[u("h3",null,"暂无评论",-1),u("p",null,"还没有任何评论数据",-1)])))]))}},[["__scopeId","data-v-0a6f6234"]]),Hl={class:"admin-user-manager"},Jl={class:"filter-bar"},Kl={key:0,class:"loading-state"},Gl={key:1,class:"error-state"},Ql={key:2,class:"users-table"},Yl={class:"user-info"},Zl={class:"username"},ec={key:0,class:"pending-dot"},tc={class:"user-id"},sc={class:"action-buttons"},nc=["onClick"],ac=["onClick"],oc=["onClick"],rc={key:3,class:"empty-state"},ic={class:"modal-body"},lc={class:"form-group"},cc={class:"form-group"},uc={class:"form-group"},dc={class:"password-input-group"},hc={class:"form-group"},pc={class:"form-group"},fc=t({__name:"AdminUserManager",setup(e){const t=a([]),s=a([]),n=a(!1),x=a(!1),C=a(""),A=a(""),S=a(""),I=a(""),$=o({id:null,username:"",email:"",password:"",role:"user",status:"pending"}),R=r(()=>{const{user:e}=T.getAuth();return(null==e?void 0:e._id)||(null==e?void 0:e.id)}),P=r(()=>[...s.value].sort((e,t)=>"pending"===e.status&&"pending"!==t.status?-1:"pending"!==e.status&&"pending"===t.status?1:new Date(t.createdAt||0)-new Date(e.createdAt||0))),E=async()=>{x.value=!0,C.value="";try{const e=await O.getAllUsers();if(!e.success)throw new Error(e.message||"获取用户列表失败");{const n=(e.data.users||e.data||[]).map(e=>({...e,status:e.status||(!1!==e.active?"approved":"pending")}));t.value=n,s.value=n}}catch(e){C.value=e.message||"获取用户列表失败，请稍后重试";const n=[{_id:"1",username:"admin",email:"admin@example.com",role:"admin",status:"approved",createdAt:(new Date).toISOString()},{_id:"2",username:"newuser",email:"newuser@example.com",role:"user",status:"pending",createdAt:new Date(Date.now()-864e5).toISOString()},{_id:"3",username:"alice",email:"alice@example.com",role:"user",status:"approved",createdAt:new Date(Date.now()-1728e5).toISOString()}];t.value=n,s.value=n}finally{x.value=!1}},D=()=>{let e=t.value;if(A.value&&(e=e.filter(e=>e.role===A.value)),S.value&&(e=e.filter(e=>e.status===S.value)),I.value){const t=I.value.toLowerCase();e=e.filter(e=>e.username.toLowerCase().includes(t)||e.email.toLowerCase().includes(t))}s.value=e},j=()=>{confirm("确定要重置此用户的密码为 123456 吗？")&&($.password="123456",alert("密码已设置为 123456"))},L=async()=>{var e,t;try{const e={username:$.username,email:$.email,role:$.role,status:$.status};$.password&&(e.password=$.password);(await O.updateUserRole($.id,e)).success&&(alert("用户更新成功!"),await E(),U())}catch(s){alert("保存失败: "+((null==(t=null==(e=s.response)?void 0:e.data)?void 0:t.message)||s.message))}},U=()=>{n.value=!1,Object.assign($,{id:null,username:"",email:"",password:"",role:"user",status:"pending"})},M=e=>{if(!e)return"";const t=new Date(e);return isNaN(t.getTime())?"":t.toLocaleString("zh-CN")};return i(()=>{E()}),(e,t)=>(c(),l("div",Hl,[t[24]||(t[24]=u("div",{class:"manager-header"},[u("h2",null,"用户管理")],-1)),u("div",Jl,[h(u("select",{"onUpdate:modelValue":t[0]||(t[0]=e=>A.value=e),onChange:D},t[9]||(t[9]=[u("option",{value:""},"全部角色",-1),u("option",{value:"admin"},"管理员",-1),u("option",{value:"user"},"普通用户",-1)]),544),[[f,A.value]]),h(u("select",{"onUpdate:modelValue":t[1]||(t[1]=e=>S.value=e),onChange:D},t[10]||(t[10]=[u("option",{value:""},"全部状态",-1),u("option",{value:"approved"},"已启用",-1),u("option",{value:"pending"},"待审核",-1)]),544),[[f,S.value]]),h(u("input",{"onUpdate:modelValue":t[2]||(t[2]=e=>I.value=e),placeholder:"搜索用户名或邮箱...",onInput:D},null,544),[[p,I.value]])]),x.value?(c(),l("div",Kl,t[11]||(t[11]=[u("p",null,"正在加载用户数据...",-1)]))):C.value?(c(),l("div",Gl,[t[12]||(t[12]=u("h3",null,"加载失败",-1)),u("p",null,b(C.value),1),u("button",{onClick:E,class:"retry-btn"},"重试")])):(c(),l("div",Ql,[u("table",null,[t[13]||(t[13]=u("thead",null,[u("tr",null,[u("th",null,"用户名"),u("th",null,"邮箱"),u("th",null,"角色"),u("th",null,"状态"),u("th",null,"注册时间"),u("th",null,"操作")])],-1)),u("tbody",null,[(c(!0),l(m,null,v(P.value,e=>{return c(),l("tr",{key:e._id||e.id,class:w({"pending-user":"pending"===e.status})},[u("td",null,[u("div",Yl,[u("div",Zl,["pending"===e.status?(c(),l("span",ec)):y("",!0),g(" "+b(e.username),1)]),u("div",tc,"ID: "+b(e._id||e.id),1)])]),u("td",null,b(e.email),1),u("td",null,[u("span",{class:w(["role-badge",e.role])},b((s=e.role,{admin:"管理员",user:"普通用户"}[s]||s)),3)]),u("td",null,[u("span",{class:w(["status-badge",e.status])},b((t=e.status,{approved:"已启用",pending:"待审核"}[t]||t)),3)]),u("td",null,b(M(e.createdAt||e.registerTime)),1),u("td",null,[u("div",sc,[u("button",{onClick:t=>(e=>{Object.assign($,{id:e._id||e.id,username:e.username,email:e.email,password:"",role:e.role,status:e.status}),n.value=!0})(e),class:"edit-btn"},"编辑",8,nc),"pending"===e.status?(c(),l("button",{key:0,onClick:t=>(async e=>{var t,s;if(confirm("确定要启用此用户吗？"))try{(await O.updateUserRole(e,{status:"approved"})).success&&(await E(),alert("用户已启用!"))}catch(n){alert("启用失败: "+((null==(s=null==(t=n.response)?void 0:t.data)?void 0:s.message)||n.message))}})(e._id||e.id),class:"approve-btn"}," 启用 ",8,ac)):y("",!0),"admin"!==e.role||e._id!==R.value?(c(),l("button",{key:1,onClick:t=>(async e=>{var t,s;if(confirm("确定要删除此用户吗？此操作将删除该用户的所有博客、评论等数据，不可恢复！"))try{(await O.deleteUser(e)).success&&(await E(),alert("用户删除成功!"))}catch(n){alert("删除失败: "+((null==(s=null==(t=n.response)?void 0:t.data)?void 0:s.message)||n.message))}})(e._id||e.id),class:"delete-btn"}," 删除 ",8,oc)):y("",!0)])])],2);var t,s}),128))])])])),x.value||C.value||0!==s.value.length?y("",!0):(c(),l("div",rc,t[14]||(t[14]=[u("h3",null,"暂无用户数据",-1),u("p",null,"没有找到符合条件的用户",-1)]))),(c(),d(k,{to:"body"},[n.value?(c(),l("div",{key:0,class:"modal-overlay",onClick:U},[u("div",{class:"modal-content",onClick:t[8]||(t[8]=_(()=>{},["stop"]))},[u("div",{class:"modal-header"},[t[15]||(t[15]=u("h3",null,"编辑用户",-1)),u("button",{onClick:U,class:"close-btn"},"✕")]),u("div",ic,[u("form",{onSubmit:_(L,["prevent"])},[u("div",lc,[t[16]||(t[16]=u("label",null,"用户名",-1)),h(u("input",{"onUpdate:modelValue":t[3]||(t[3]=e=>$.username=e),type:"text",required:""},null,512),[[p,$.username]])]),u("div",cc,[t[17]||(t[17]=u("label",null,"邮箱",-1)),h(u("input",{"onUpdate:modelValue":t[4]||(t[4]=e=>$.email=e),type:"email",required:""},null,512),[[p,$.email]])]),u("div",uc,[t[18]||(t[18]=u("label",null,"密码",-1)),u("div",dc,[h(u("input",{"onUpdate:modelValue":t[5]||(t[5]=e=>$.password=e),type:"password",placeholder:"留空则不修改密码"},null,512),[[p,$.password]]),u("button",{type:"button",onClick:j,class:"reset-password-btn"},"重置密码")])]),u("div",hc,[t[20]||(t[20]=u("label",null,"角色",-1)),h(u("select",{"onUpdate:modelValue":t[6]||(t[6]=e=>$.role=e),required:""},t[19]||(t[19]=[u("option",{value:"user"},"普通用户",-1),u("option",{value:"admin"},"管理员",-1)]),512),[[f,$.role]])]),u("div",pc,[t[22]||(t[22]=u("label",null,"状态",-1)),h(u("select",{"onUpdate:modelValue":t[7]||(t[7]=e=>$.status=e)},t[21]||(t[21]=[u("option",{value:"pending"},"待审核",-1),u("option",{value:"approved"},"已启用",-1)]),512),[[f,$.status]])]),u("div",{class:"form-actions"},[u("button",{type:"button",onClick:U,class:"cancel-btn"},"取消"),t[23]||(t[23]=u("button",{type:"submit",class:"save-btn"},"更新",-1))])],32)])])])):y("",!0)]))]))}},[["__scopeId","data-v-c46a3f58"]]),mc={class:"admin-panel"},vc={class:"admin-header"},gc={class:"welcome-section"},yc={class:"welcome-text"},bc={class:"admin-nav"},wc={class:"nav-grid"},_c=["onClick"],kc={class:"nav-icon"},xc={key:0,class:"pending-badge"},Cc={class:"admin-content"},Ac={key:0,class:"overview-content"},Sc={class:"recent-activities"},Ic={key:0,class:"activity-list"},$c={class:"activity-icon"},Tc={class:"activity-content"},Oc={class:"activity-text"},Rc={class:"activity-time"},Pc={key:1,class:"empty-activity"},Ec=t({__name:"AdminPanel",setup(e){I();const t=a("overview"),s=a(null),n=o({blogs:0,images:0,documents:0,comments:0}),h=a([]),p=r(()=>[{key:"blogs",icon:"📝",label:"博客管理",description:"创建和编辑博客文章",pending:0},{key:"gallery",icon:"🖼️",label:"图库管理",description:"管理图片和分类",pending:0},{key:"documents",icon:"📄",label:"文档管理",description:"管理文档和资源",pending:0},{key:"friend-links",icon:"🔗",label:"友情链接",description:"管理友情链接申请",pending:0},{key:"users",icon:"👥",label:"用户管理",description:"管理用户账户和权限",pending:0},{key:"comments",icon:"💬",label:"评论管理",description:"管理用户评论",pending:0},{key:"user-panel",icon:"👤",label:"我的面板",description:"管理个人评论和设置",pending:0}]),f=r(()=>({blogs:To,gallery:Si,documents:bl,"friend-links":vr,users:fc,comments:zl,"user-panel":L}[t.value]));return i(()=>{(()=>{const{user:e}=T.getAuth();s.value=e})(),(async()=>{try{const e=await O.getStats();e.success&&(Object.assign(n,e.data.stats),h.value=(e.data.recentActivities||[]).slice(0,3))}catch(e){Object.assign(n,{blogs:15,images:128,documents:25,playlists:45,comments:89}),h.value=[{id:1,icon:"🚀",text:"系统启动完成",time:new Date},{id:2,icon:"👨‍💼",text:"管理员登录成功",time:new Date(Date.now()-6e5)},{id:3,icon:"🔗",text:"数据库连接正常",time:new Date(Date.now()-18e5)}]}})()}),(e,n)=>{var a;return c(),l("div",mc,[u("div",vc,[u("div",gc,[n[0]||(n[0]=u("h1",null,"管理员控制台",-1)),u("p",yc,"欢迎回来，"+b(null==(a=s.value)?void 0:a.username)+"！",1)])]),u("div",bc,[u("div",wc,[(c(!0),l(m,null,v(p.value,e=>(c(),l("div",{key:e.key,class:w(["nav-card",{active:t.value===e.key}]),onClick:s=>t.value=e.key},[u("div",kc,b(e.icon),1),u("h3",null,b(e.label),1),u("p",null,b(e.description),1),e.pending>0?(c(),l("div",xc,b(e.pending),1)):y("",!0)],10,_c))),128))])]),u("div",Cc,["overview"===t.value?(c(),l("div",Ac,[n[3]||(n[3]=u("h2",null,"系统总览",-1)),u("div",Sc,[n[2]||(n[2]=u("h3",null,"最近活动",-1)),h.value.length>0?(c(),l("div",Ic,[(c(!0),l(m,null,v(h.value.slice(0,3),e=>{return c(),l("div",{key:e.id,class:"activity-item"},[u("div",$c,b(e.icon),1),u("div",Tc,[u("div",Oc,b(e.text),1),u("div",Rc,b((t=e.time,new Date(t).toLocaleString("zh-CN"))),1)])]);var t}),128))])):(c(),l("div",Pc,n[1]||(n[1]=[u("p",null,"暂无最近活动",-1)])))])])):y("",!0),"overview"!==t.value?(c(),d($(f.value),{key:1})):y("",!0)])])}}},[["__scopeId","data-v-c7cec6c9"]]);export{Ec as default};
